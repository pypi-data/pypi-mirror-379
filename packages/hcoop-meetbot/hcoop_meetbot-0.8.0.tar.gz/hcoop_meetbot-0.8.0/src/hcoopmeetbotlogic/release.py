# vim: set ft=python ts=4 sw=4 expandtab:

"""
Version and release information.
"""

# Historically, this information was tracked directly within this file as part of the
# release process.  In modern Python, it's better to rely on the package metadata,
# which is managed by UV on our behalf.
#
# The metadata will always be set any time the package has been completely and
# properly installed, but defaults are provided for times when this is not the case.
#
# Note: previously, we also tracked release date (DATE) and copyright date range
# (COPYRIGHT), but that information is not available in the package metadata.  These
# variables are maintained to avoid breaking the public interface, but are always
# "unset".
#
# See also:
#   https://packaging.python.org/en/latest/specifications/core-metadata/#core-metadata-project-url
#   https://packaging.python.org/en/latest/specifications/well-known-project-urls/#well-known-project-urls

import re
from importlib.metadata import metadata

try:
    _METADATA = metadata("hcoop-meetbot")
except ImportError:
    _METADATA = {}  # type: ignore[assignment]

# Regex matching the Author-email metadata entry generated by UV, an optionally-quoted name plus email address
_REGEX = r"(^)(\"?)([^<\"]*)(\"?)( <)([^>]*)(>$)"


def _project_url(key: str, default: str) -> str:
    urls = _METADATA.get_all("Project-URL")
    if urls is None:
        urls = []
    return next(
        iter([url.replace(f"{key}, ", "") for url in urls if url.startswith(f"{key}, ")]),
        default,
    )


AUTHOR = re.sub(_REGEX, r"\3", _METADATA["Author-email"]) if "Author-email" in _METADATA else "unset"
EMAIL = re.sub(_REGEX, r"\6", _METADATA["Author-email"]) if "Author-email" in _METADATA else "unset"
VERSION = _METADATA["Version"] if "Version" in _METADATA else "0.0.0"  # noqa: SIM401 # this is not a dict
URL = _project_url("Homepage", "unset")
DOCS = _project_url("Documentation", "unset")

COPYRIGHT = "unset"
DATE = "unset"
