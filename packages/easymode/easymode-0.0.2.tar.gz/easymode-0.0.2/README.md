[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://github.com/mgflast/easymode/LICENSE.txt)
[![Downloads](https://img.shields.io/pypi/dm/easymode)](https://pypi.org/project/easymode/)
[![Documentation Status](https://readthedocs.org/projects/easymode/badge/?version=latest)](https://easymode.readthedocs.io/en/latest/?badge=latest)
![Last Commit](https://img.shields.io/github/last-commit/mgflast/easymode)

## easymode
### a collection of pretrained general networks for cellular cryoET

Easymode is a collection of general pretrained neural networks for cellular cryo-electron tomography (cryoET). The goal is to offer single command line interface commands to handle one of the most time consuming and tedious steps of the cryoET workflow: particle detection. **Inspired and based upon [Membrain-seg](https://github.com/teamtomo/membrain-seg), easymode provides general pretrained networks for segmentation of cellular cryoET data.**    

All networks were trained on a dataset of ~850 tilt series from 30 different sources, covering many prokaryotic, archaeal, and eukaryotic species, different sample preparation techniques (cryo-FIB, lift-out, purified organelles, purified proteins, intact virus particles, whole cells), different hardware configurations (e.g., K2/K3/Falcon4i, 200/300 kV, Volta phase plate), a range of acquisition pixel sizes, electron doses, and defocus values, and various different original applications including various subtomogram averaging and benchmarking projects. The dataset is biased towards human samples: nine of the datasets concern human cells or tissues. For each tilt series, we reconstructed tomograms in five 'flavours' using [WarpTools](https://warpem.github.io/), [AreTomo3](https://github.com/czimaginginstitute/AreTomo3), [cryoCARE](https://github.com/juglab/cryoCARE_pip), and [DeepDeWedge](https://github.com/MLI-lab/DeepDeWedge), all at a common scale of 10.0 Ã…ngstrom per pixel. Training was performed using linear combinations of different tomogram flavours as the input; we use almost exactly the same 3D UNet architecture and many of the same augmentations as used in [Membrain-seg](https://github.com/teamtomo/membrain-seg), including their missing wedge augmentation. Labels were generated by applying [Ais](github.com/bionanopatterning/Ais) 2D UNets to selected subtomograms and manually curating the results.

### functionality

Pretrained 3D UNets for segmentation of common eukaryotic features are hosted via [ðŸ¤— huggingface](https://huggingface.co/mgflast/easymode/tree/main) and are automatically downloaded when you call *easymode*, so you don't need to worry about where to get the network weights from. To see which models are available, use this command. Note that we're still working to include more features & to validate the accuracy.
```
easymode list
```

```
Easymode can currently segment the following features:

   > membrane                  [available for download]
   > microtubule               [available for download]
   > ribosome                  [in local cache]
   > tric                      [available for download]
   > actin                     [available for download]
   > mitochondrial_granule     [available for download]
   > cytoplasmic_granule       [available for download]
```

To segment data, use 'easymode segment'. If the required network weights are not found in your local cache, they are automatically downloaded.
```
easymode segment <feature> --data <directory containing tomograms>
easymode segment ribosome --data warp_tiltseries/reconstruction
easymode segment tric --data warp_tiltseries/reconstruction --tta 4 --batch 1 --format int8        # 4-fold test-time augmentation, mimimal memory requirement
```
To facilitate data pre-processing you can use the 'reconstruct' command. Using this requires an environment with [WarpTools](https://warpem.github.io/warp/user_guide/warptools/installation/) installedand configuring access to AreTomo3. In our case we set it up as follows:
```
easymode set --aretomo3_path /public/EM/AreTomo/AreTomo3-2.1.10-cuda12.4/AreTomo3
easymode set --aretomo3_env "module load aretomo3/2.1.10-cu12.4"
```
To turn raw data into reconstructed tomograms, you can then run the following command. Behind the scenes we simply call a sequence of WarpTools commands, move some files, and run AreTomo3 for tilt series alignment. All credit for this utility goes to the authors of [Warp](https://warpem.github.io/warp/team/) and [AreTomo](https://github.com/czimaginginstitute/AreTomo3). 
```
easymode reconstruct --frames <frames_directory> --mdocs <mdocs_directory> --apix <pixel_size> --dose <dose_per_tilt>
easymode reconstruct --frames warp_tiltseries/frames --mdocs warp_tiltseries/mdocs --apix 1.56 --dose 4.6
```
We also distribute pretrained networks for two denoising methods: Noise2Noise (n2n, like cryoCARE) and DeepDeWedge. For each denoising method we offer two processing modes: 'splits', to denoise using even/odd volume splits, or 'direct', to denoise full volumes. This latter method is enabled by transfer learning, where we use the results of even/odd denoising to train networks to denoise straight from full volumes. Although this is not quite statistically sound, the denoising results are decent, the process is twice as fast, and you can save a lot of time and memory by not having to generate even/odd frame and volume splits. 
To use easymode denoising, run:
```
easymode denoise --method {'ddw', 'n2n'} --mode {'splits', 'direct'} --data <directory containing tomograms OR containing subdirectories 'even' and 'odd', depending on selected mode> ...
easymode denoise --method n2n --mode direct --data warp_tiltseries/reconstruction --output denoised
easymode denoise --method ddw --mode splits --data warp_tiltseries/reconstruction --output denoised         # NOTE: ddw weights are not yet available
```
To turn segmentations into coordinates and export starfiles for ingestion in tools such as [Relion](https://github.com/3dem/relion) or [Warp](https://github.com/warpem/warp), use the following commands. Behind the scence we simply call _ais pick <arguments>_ from [Ais](github.com/bionanopatterning/Ais).
```
easymode pick <feature> --data <directory containing segmentations corresponding to the feature> --output <output_directory> --size <minimum particle volume in cubic Ã…> --spacing <minimum inter-particle distance in Ã…>
easymode pick ribosome --data segmented/ --output coordinates/ribosome --size 2000000 --spacing 300
```
Finally, to clear up valuable disk space (run with care!)
```
easymode clean --frame_halfmaps --volume_halfmaps --frame_averages --thumbnails --aretomo --tiltstacks         # use these flags to specify what to delete
easymode clean <> --confirm                                                                                    # to actually delete files
easymode clean <> --list                                                                                       # to list the files that would be deleted
```

### data sources

Not all training data sources are currently listed, as a number of contributors prefer to remain anonymous so long as their work is not published. These contributions are marked with *.


| ID          | Contributor / source* | Sample type                                | N  | Pixel size (Ã…) |
|-------------|-----------------------|--------------------------------------------|----|----------------|
| 001_HELA    | Mart Last             | milled H. sapiens (HeLa)                   | 60 | 1.51           |
| 002_U2OS    | Mart Last             | milled H. sapiens (U2OS)                   | 40 | 2.15           |
| 003_HSPERM  | Tom Dendooven         | milled H. sapiens (spermatozoa)            | 56 | 1.50           |
| 004_*       | *                     |                                            | 23 | 1.68           |
| 005_FIBRO   | Tom Hale              | milled H. sapiens (fibroblasts)            | 52 | 1.33           |
| 006_*       | *                     |                                            | 20 | 1.69           |
| 007_APOF    | EMPIAR-10491          | purified apoferritin                       | 37 | 0.79           |
| 008_HIV     | EMPIAR-10164          | purified HIV particles                     | 10 | 0.68           |
| 009_*       | *                     |                                            | 64 | 1.56           |
| 010_RIBO    | EMPIAR-11111          | purified E. coli 70S ribosomes             | 25 | 1.07           |
| 011_CHLO    | EMPIAR-12612          | milled S. oleracea chloroplasts            | 23 | 3.52           |
| 012_CHLAMY  | EMPIAR-11830          | milled C. reinhardtii                      | 52 | 1.96           |
| 013_DIAT    | EMPIAR-11747          | milled T. pseudonana                       | 7  | 1.07           |
| 014_CILIA   | EMPIAR-11078          | milled C. reinhardtii ciliary base         | 23 | 3.42           |
| 015_MMVOLTA | DS-10452              | whole M. mycoides cells                    | 15 | 1.53           |
| 016_PHANTOM | DS-10440, DS-10445    | E. coli lysate with added proteins         | 19 | 1.53           |
| 017_MYCP    | EMPIAR-10499          | whole M. pneunomiae cells                  | 65 | 1.70           |
| 018_ECM     | EMPIAR-11897          | lift-out H. sapiens (extracellular matrix) | 39 | 2.14           |
| 019_ECOLI   | EMPIAR-12413          | milled E. coli                             | 44 | 1.90           |
| 020_*       | *                     | *                                          | 30 | 2.13           |
| 021_*       | *                     | *                                          | 8  | 3.02           |
| 022_SCOV    | EMPIAR-10493          | purified SARS-CoV-2 virions                | 20 | 1.53           |
| 023_SPORE   | EMPIAR-12176          | milled E. intestinalis                     | 24 | 2.06           |
| 024_*       | *                     | *                                          | 17 | 1.96           |
| 025_RPE     | EMPIAR-10989          | cellular periphery H. sapiens (RPE1)       | 3  | 3.45           |
| 026_EHV     | EMPIAR-11896          | Emiliania huxleyi virus 201                | 40 | 2.08           |
| 027_NUCFT   | Forson Gao            | milled S. cerevisiae nuclei                | 21 | 1.51           |
| 028_ROOF    | DS-10434              | cellular periphery H. sapiens (HEK293)     | 20 | 1.51           |
| 029_TKIV    | EMPIAR-11058          | milled T. kivui                            | 17 | 1.51           |
| 030_LDN     | Mart Last             | cellular periphery H. sapiens (U2OS)       | 26 | 2.74           |

*DS: datasets on the [CZI CryoET Data Portal](https://cryoetdataportal.czscience.com/)

### references

(work in progress)