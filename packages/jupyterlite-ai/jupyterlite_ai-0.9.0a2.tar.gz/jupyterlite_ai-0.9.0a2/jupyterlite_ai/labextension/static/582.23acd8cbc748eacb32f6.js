"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[582],{6582:(t,e,o)=>{o.r(e),o.d(e,{AiSdkModel:()=>m,TwilioRealtimeTransportLayer:()=>r,aisdk:()=>c,getResponseFormat:()=>l,itemsToLanguageV2Messages:()=>a,parseArguments:()=>g,toolChoiceToLanguageV2Format:()=>y,toolToLanguageV2Tool:()=>d});var n=o(885),s=o(4472);class r extends n.OpenAIRealtimeWebSocket{#t;#e=null;#o=0;#n=0;#s=null;#r=(0,s.getLogger)("openai-agents:extensions:twilio");constructor(t){super(t),this.#t=t.twilioWebSocket}_setInputAndOutputAudioFormat(t){let e={};return t?e={...t,inputAudioFormat:t.inputAudioFormat??"g711_ulaw",outputAudioFormat:t.outputAudioFormat??"g711_ulaw"}:(e.inputAudioFormat="g711_ulaw",e.outputAudioFormat="g711_ulaw"),e}async connect(t){t.initialSessionConfig=this._setInputAndOutputAudioFormat(t.initialSessionConfig),this.#t.addEventListener("message",t=>{try{const e=JSON.parse(t.data.toString());switch(this.#r.dontLogModelData?this.#r.debug("Twilio message:",e.event):this.#r.debug("Twilio message:",e),this.emit("*",{type:"twilio_message",message:e}),e.event){case"media":"connected"===this.status&&this.sendAudio(n.utils.base64ToArrayBuffer(e.media.payload));break;case"mark":if(!e.mark.name.startsWith("done:")&&e.mark.name.includes(":")){const t=Number(e.mark.name.split(":")[1]);Number.isFinite(t)?this.#n=t:this.#r.warn("Invalid mark name received:",e.mark.name)}else e.mark.name.startsWith("done:")&&(this.#n=0);break;case"start":this.#e=e.start.streamSid}}catch(e){this.#r.error("Error parsing message:",e,"Message:",t),this.emit("error",{type:"error",error:e})}}),this.#t.addEventListener("close",()=>{"disconnected"!==this.status&&this.close()}),this.#t.addEventListener("error",t=>{this.emit("error",{type:"error",error:t}),this.close()}),this.on("audio_done",()=>{this.#t.send(JSON.stringify({event:"mark",mark:{name:`done:${this.currentItemId}`},streamSid:this.#e}))}),await super.connect(t)}updateSessionConfig(t){const e=this._setInputAndOutputAudioFormat(t);super.updateSessionConfig(e)}_interrupt(t,e=!0){const o=this.#n+50;this.#r.debug(`Interruption detected, clearing Twilio audio and truncating OpenAI audio after ${o}ms`),this.#t.send(JSON.stringify({event:"clear",streamSid:this.#e})),super._interrupt(o,e)}_onAudio(t){this.#r.debug(`Sending audio to Twilio ${t.responseId}: (${t.data.byteLength} bytes)`);const e={event:"media",streamSid:this.#e,media:{payload:n.utils.arrayBufferToBase64(t.data)}};this.#s!==this.currentItemId&&this.currentItemId&&(this.#s=this.currentItemId,this.#o=0),this.#o+=t.data.byteLength/8,this.#t.send(JSON.stringify(e)),this.#t.send(JSON.stringify({event:"mark",streamSid:this.#e,mark:{name:`${this.currentItemId}:${this.#o}`}})),this.emit("audio",t)}}var i=o(7962);function a(t,e){const o=[];let n;for(const t of e){if("message"===t.type||void 0===t.type){const{role:e,content:r,providerData:i}=t;if("system"===e){o.push({role:"system",content:r,providerOptions:{...i??{}}});continue}if("user"===e){o.push({role:e,content:"string"==typeof r?[{type:"text",text:r}]:r.map(t=>{const{providerData:e}=t;if("input_text"===t.type)return{type:"text",text:t.text,providerOptions:{...e??{}}};if("input_image"===t.type)return{type:"file",data:new URL(t.image),mediaType:"image/*",providerOptions:{...e??{}}};if("input_file"===t.type){if("string"!=typeof t.file)throw new s.UserError("File ID is not supported");return{type:"file",file:t.file,mediaType:"application/octet-stream",data:t.file,providerOptions:{...e??{}}}}throw new s.UserError(`Unknown content type: ${t.type}`)}),providerOptions:{...i??{}}});continue}if("assistant"===e){n&&(o.push(n),n=void 0),o.push({role:e,content:r.filter(t=>"output_text"===t.type).map(t=>{const{providerData:e}=t;return{type:"text",text:t.text,providerOptions:{...e??{}}}}),providerOptions:{...i??{}}});continue}throw new Error(`Unknown message type: ${t}`)}if("function_call"===t.type){if(n||(n={role:"assistant",content:[],providerOptions:{...t.providerData??{}}}),Array.isArray(n.content)&&"assistant"===n.role){const e={type:"tool-call",toolCallId:t.callId,toolName:t.name,input:g(t.arguments),providerOptions:{...t.providerData??{}}};n.content.push(e)}continue}if("function_call_result"===t.type){n&&(o.push(n),n=void 0);const e={type:"tool-result",toolCallId:t.callId,toolName:t.name,output:u(t.output),providerOptions:{...t.providerData??{}}};o.push({role:"tool",content:[e],providerOptions:{...t.providerData??{}}});continue}if("hosted_tool_call"===t.type)throw new s.UserError("Hosted tool calls are not supported");if("computer_call"===t.type)throw new s.UserError("Computer calls are not supported");if("computer_call_result"===t.type)throw new s.UserError("Computer call results are not supported");if("reasoning"===t.type&&t.content.length>0&&"string"==typeof t.content[0].text){o.push({role:"assistant",content:[{type:"reasoning",text:t.content[0].text,providerOptions:{...t.providerData??{}}}],providerOptions:{...t.providerData??{}}});continue}if("unknown"===t.type){o.push({...t.providerData??{}});continue}if(t)throw new s.UserError(`Unknown item type: ${t.type}`);const e=t;throw new s.UserError(`Unknown item type: ${e}`)}return n&&o.push(n),o}function p(t,e){return{type:"function",name:e.toolName,description:e.toolDescription,inputSchema:e.inputJsonSchema}}function u(t){const e=t;if("text"===e?.type&&"string"==typeof e.text)return{type:"text",value:e.text};if("image"===e?.type&&"string"==typeof e.data&&"string"==typeof e.mediaType)return{type:"content",value:[{type:"media",data:e.data,mediaType:e.mediaType}]};throw new s.UserError(`Unsupported tool output type: ${String(e?.type)}`)}function d(t,e){if("function"===e.type)return{type:"function",name:e.name,description:e.description,inputSchema:e.parameters};if("hosted_tool"===e.type)return{type:"provider-defined",id:`${t.provider}.${e.name}`,name:e.name,args:e.providerData?.args??{}};if("computer"===e.type)return{type:"provider-defined",id:`${t.provider}.${e.name}`,name:e.name,args:{environment:e.environment,display_width:e.dimensions[0],display_height:e.dimensions[1]}};throw new Error(`Unsupported tool type: ${e}`)}function l(t){return"text"===t?{type:"text"}:{type:"json",name:t.name,schema:t.schema}}class m{#i;#r=(0,s.getLogger)("openai-agents:extensions:ai-sdk");constructor(t){this.#i=t}async getResponse(t){return(0,s.withGenerationSpan)(async e=>{try{e.spanData.model=this.#i.provider+":"+this.#i.modelId,e.spanData.model_config={provider:this.#i.provider,model_impl:"ai-sdk"};let o="string"==typeof t.input?[{role:"user",content:[{type:"text",text:t.input}]}]:a(this.#i,t.input);t.systemInstructions&&(o=[{role:"system",content:t.systemInstructions},...o]);const n=t.tools.map(t=>d(this.#i,t));if(t.handoffs.forEach(t=>{n.push(p(this.#i,t))}),e&&!0===t.tracing&&(e.spanData.input=o),(0,i.f3)(t.outputType))throw new s.UserError("Zod output type is not yet supported");const r=l(t.outputType),u={tools:n,toolChoice:y(t.modelSettings.toolChoice),prompt:o,temperature:t.modelSettings.temperature,topP:t.modelSettings.topP,frequencyPenalty:t.modelSettings.frequencyPenalty,presencePenalty:t.modelSettings.presencePenalty,maxOutputTokens:t.modelSettings.maxTokens,responseFormat:r,abortSignal:t.signal,...t.modelSettings.providerData??{}};this.#r.dontLogModelData?this.#r.debug("Request sent"):this.#r.debug("Request:",JSON.stringify(u,null,2));const m=await this.#i.doGenerate(u),c=[],g=m.content??[],h=g.filter(t=>t&&"tool-call"===t.type),f=h.length>0;for(const t of h)c.push({type:"function_call",callId:t.toolCallId,name:t.toolName,arguments:"string"==typeof t.input?t.input:JSON.stringify(t.input??{}),status:"completed",providerData:f?m.providerMetadata:void 0});if(!f){const t=g.find(t=>t&&"text"===t.type&&"string"==typeof t.text);t&&c.push({type:"message",content:[{type:"output_text",text:t.text}],role:"assistant",status:"completed",providerData:m.providerMetadata})}e&&!0===t.tracing&&(e.spanData.output=c);const k={responseId:m.response?.id??"FAKE_ID",usage:new s.Usage({inputTokens:Number.isNaN(m.usage?.inputTokens)?0:m.usage?.inputTokens??0,outputTokens:Number.isNaN(m.usage?.outputTokens)?0:m.usage?.outputTokens??0,totalTokens:(Number.isNaN(m.usage?.inputTokens)?0:m.usage?.inputTokens??0)+(Number.isNaN(m.usage?.outputTokens)?0:m.usage?.outputTokens??0)||0}),output:c,providerData:m};return e&&!0===t.tracing&&(e.spanData.usage={input_tokens:k.usage.inputTokens,output_tokens:k.usage.outputTokens}),this.#r.dontLogModelData?this.#r.debug("Response ready"):this.#r.debug("Response:",JSON.stringify(k,null,2)),k}catch(o){throw o instanceof Error?e.setError({message:!0===t.tracing?o.message:"Unknown error",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}):e.setError({message:"Unknown error",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}),o}})}async*getStreamedResponse(t){const e=t.tracing?(0,s.createGenerationSpan)():void 0;try{e&&(e.start(),(0,s.setCurrentSpan)(e)),e?.spanData&&(e.spanData.model=this.#i.provider+":"+this.#i.modelId,e.spanData.model_config={provider:this.#i.provider,model_impl:"ai-sdk"});let o="string"==typeof t.input?[{role:"user",content:[{type:"text",text:t.input}]}]:a(this.#i,t.input);t.systemInstructions&&(o=[{role:"system",content:t.systemInstructions},...o]);const n=t.tools.map(t=>d(this.#i,t));t.handoffs.forEach(t=>{n.push(p(this.#i,t))}),e&&!0===t.tracing&&(e.spanData.input=o);const r=l(t.outputType),i={tools:n,prompt:o,temperature:t.modelSettings.temperature,topP:t.modelSettings.topP,frequencyPenalty:t.modelSettings.frequencyPenalty,presencePenalty:t.modelSettings.presencePenalty,maxOutputTokens:t.modelSettings.maxTokens,responseFormat:r,abortSignal:t.signal,...t.modelSettings.providerData??{}};this.#r.dontLogModelData?this.#r.debug("Request received (streamed)"):this.#r.debug("Request (streamed):",JSON.stringify(i,null,2));const{stream:u}=await this.#i.doStream(i);let m,c=!1,g=0,y=0;const h={};let f;for await(const t of u)switch(c||(c=!0,yield{type:"response_started"}),yield{type:"model",event:t},t.type){case"text-delta":f||(f={type:"output_text",text:""}),f.text+=t.delta,yield{type:"output_text_delta",delta:t.delta};break;case"tool-call":{const e=t.toolCallId;e&&(h[e]={type:"function_call",callId:e,name:t.toolName,arguments:t.input??"",status:"completed"});break}case"response-metadata":t.id&&(m=t.id);break;case"finish":g=Number.isNaN(t.usage?.inputTokens)?0:t.usage?.inputTokens??0,y=Number.isNaN(t.usage?.outputTokens)?0:t.usage?.outputTokens??0;break;case"error":throw t.error}const k=[];f&&k.push({type:"message",role:"assistant",content:[f],status:"completed"});for(const t of Object.values(h))k.push(t);const v={type:"response_done",response:{id:m??"FAKE_ID",usage:{inputTokens:g,outputTokens:y,totalTokens:g+y},output:k}};e&&!0===t.tracing&&(e.spanData.output=k,e.spanData.usage={input_tokens:v.response.usage.inputTokens,output_tokens:v.response.usage.outputTokens}),this.#r.dontLogModelData?this.#r.debug("Response ready (streamed)"):this.#r.debug("Response (streamed):",JSON.stringify(v.response,null,2)),yield v}catch(o){throw e&&e.setError({message:"Error streaming response",data:{error:!0===t.tracing?String(o):o instanceof Error?o.name:void 0}}),o}finally{e&&(e.end(),(0,s.resetCurrentSpan)())}}}function c(t){return new m(t)}function g(t){if(!t)return{};try{return JSON.parse(t)}catch(t){return{}}}function y(t){if(t)switch(t){case"auto":return{type:"auto"};case"required":return{type:"required"};case"none":return{type:"none"};default:return{type:"tool",toolName:t}}}}}]);