"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[197],{8197:(e,t,o)=>{o.r(t),o.d(t,{createOllama:()=>_,ollama:()=>x});var s=o(2100),n=o(116),a=o(2278),r=a.Ik({error:a.Ik({message:a.Yj(),type:a.Yj().nullish(),param:a.bz().nullish(),code:a.KC([a.Yj(),a.ai()]).nullish()})}),i=(0,n.createJsonErrorResponseHandler)({errorSchema:r,errorToMessage:e=>e.error.message});function l(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}function p({model:e,created_at:t}){return{id:void 0,modelId:null!=e?e:void 0,timestamp:null!=t?new Date(t):void 0}}var u=a.Ik({think:a.zM().optional(),user:a.Yj().optional(),suffix:a.Yj().optional(),echo:a.zM().optional()}),d=class{constructor(e,t,o){this.specificationVersion="v2",this.supportedUrls={},this.modelId=e,this.settings=t,this.config=o}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:o,topP:a,topK:r,frequencyPenalty:i,presencePenalty:l,stopSequences:p,responseFormat:d,tools:c,toolChoice:h,seed:m,providerOptions:g}){var f;const y=[],v=null!=(f=await(0,n.parseProviderOptions)({provider:"ollama",providerOptions:g,schema:u}))?f:{};null!=r&&y.push({type:"unsupported-setting",setting:"topK"}),(null==c?void 0:c.length)&&y.push({type:"unsupported-setting",setting:"tools"}),null!=h&&y.push({type:"unsupported-setting",setting:"toolChoice"}),null!=d&&"text"!==d.type&&y.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:w,stopSequences:b}=function({prompt:e,user:t="user",assistant:o="assistant"}){let n="";"system"===e[0].role&&(n+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:a,content:r}of e)switch(a){case"system":throw new s.M3({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":n+=`${t}:\n${r.map(e=>{if("text"===e.type)return e.text}).filter(Boolean).join("")}\n\n`;break;case"assistant":n+=`${o}:\n${r.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new s.b8({functionality:"tool-call messages"})}}).join("")}\n\n`;break;case"tool":throw new s.b8({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${a}`)}return n+=`${o}:\n`,{prompt:n,stopSequences:[`\n${t}:`]}}({prompt:e}),k=[...null!=b?b:[],...null!=p?p:[]];return{args:{model:this.modelId,user:v.user,think:v.think,max_tokens:t,temperature:o,top_p:a,frequency_penalty:i,presence_penalty:l,stop:k,prompt:w,suffix:v.suffix,echo:v.echo,stream:!1},warnings:y}}async doGenerate(e){var t,o,s,a;const{args:r,warnings:u}=await this.getArgs(e),{responseHeaders:d,value:h,rawValue:m}=await(0,n.postJsonToApi)({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:(0,n.combineHeaders)(this.config.headers(),e.headers),body:{...r,stream:!1},failedResponseHandler:i,successfulResponseHandler:(0,n.createJsonResponseHandler)(c),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:g,...f}=r;return{content:[{type:"text",text:h.response}],usage:{inputTokens:null!=(t=h.prompt_eval_count)?t:void 0,outputTokens:null!=(o=h.eval_count)?o:void 0,totalTokens:(null!=(s=h.prompt_eval_count)?s:0)+(null!=(a=h.eval_count)?a:0)},finishReason:l("stop"),request:{body:JSON.stringify(r)},response:{...p(h),headers:d,body:m},warnings:u,providerMetadata:{ollama:{}}}}async doStream(e){const{args:t,warnings:o}=await this.getArgs(e),s={...t,stream:!0},{responseHeaders:a,value:r}=await(0,n.postJsonToApi)({url:this.config.url({path:"/generate",modelId:this.modelId}),headers:(0,n.combineHeaders)(this.config.headers(),e.headers),body:s,failedResponseHandler:i,successfulResponseHandler:(0,n.createJsonStreamResponseHandler)(c),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:u,...d}=t;let h="unknown",m={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},g=!0;return{stream:r.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return h="error",void t.enqueue({type:"error",error:e.error});const o=e.value;if("error"in o)return h="error",void t.enqueue({type:"error",error:o.error});g&&(g=!1,t.enqueue({type:"response-metadata",...p(o)})),o.done&&(h=l("stop")),null!=o.response&&t.enqueue({type:"text-delta",id:"0",delta:o.response})},flush(e){e.enqueue({type:"finish",finishReason:h,usage:m})}})),request:{body:JSON.stringify(s)},response:{headers:a}}}},c=a.Ik({model:a.Yj(),created_at:a.Yj(),response:a.Yj(),done:a.zM(),context:a.YO(a.ai()),eval_count:a.ai().optional(),eval_duration:a.ai().optional(),load_duration:a.ai().optional(),total_duration:a.ai().optional(),prompt_eval_count:a.ai().optional(),prompt_eval_duration:a.ai().optional()}),h=class{constructor(e,t,o){this.specificationVersion="v2",this.modelId=e,this.settings=t,this.config=o}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return null!=(e=this.settings.maxEmbeddingsPerCall)?e:2048}get supportsParallelCalls(){var e;return null==(e=this.settings.supportsParallelCalls)||e}async doEmbed({values:e,headers:t,abortSignal:o,providerOptions:a}){if(e.length>this.maxEmbeddingsPerCall)throw new s.Ch({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:r,value:l,rawValue:p}=await(0,n.postJsonToApi)({url:this.config.url({path:"/embed",modelId:this.modelId}),headers:(0,n.combineHeaders)(this.config.headers(),t),body:{model:this.modelId,input:e},failedResponseHandler:i,successfulResponseHandler:(0,n.createJsonResponseHandler)(m),abortSignal:o,fetch:this.config.fetch});return{embeddings:l.embeddings.map(e=>e),usage:{tokens:l.prompt_eval_count},response:{headers:r,body:p}}}},m=a.Ik({model:a.Yj(),embeddings:a.YO(a.YO(a.ai())),total_duration:a.ai(),load_duration:a.ai(),prompt_eval_count:a.ai()});function g({prompt:e,systemMessageMode:t="system"}){const o=[];for(const{role:s,content:n}of e)switch(s){case"system":switch(t){case"system":o.push({role:"system",content:n});break;case"developer":o.push({role:"developer",content:n});break;case"remove":break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":{if(1===n.length&&"text"===n[0].type){o.push({role:"user",content:n[0].text});break}const e=n.filter(e=>"text"===e.type).map(e=>e.text).join(""),t=n.filter(e=>"file"===e.type&&e.mediaType.startsWith("image/")).map(e=>e.data);o.push({role:"user",content:e.length>0?e:[],images:t.length>0?t:void 0});break}case"assistant":{let e="",t="";const s=[];for(const o of n)switch(o.type){case"text":e+=o.text;break;case"tool-call":s.push({id:o.toolCallId,type:"function",function:{name:o.toolName,arguments:o.input}});break;case"reasoning":t+=o.text;break;default:throw new Error(`Unsupported part: ${o}`)}o.push({role:"assistant",content:e,...t&&{thinking:t},tool_calls:s.length>0?s:void 0});break}case"tool":for(const e of n){const t=e.output;let s;switch(t.type){case"text":case"error-text":s=t.value;break;case"content":case"json":case"error-json":s=JSON.stringify(t.value)}o.push({role:"tool",tool_call_id:e.toolCallId,content:s})}break;default:throw new Error(`Unsupported role: ${s}`)}return o}var f=a.Ik({think:a.zM().optional(),options:a.Ik({num_ctx:a.ai().optional(),repeat_last_n:a.ai().optional(),repeat_penalty:a.ai().optional(),temperature:a.ai().optional(),seed:a.ai().optional(),stop:a.YO(a.Yj()).optional(),num_predict:a.ai().optional(),top_k:a.ai().optional(),top_p:a.ai().optional(),min_p:a.ai().optional()}).optional()}),y=class{async buildRequest({modelId:e,maxOutputTokens:t,temperature:o,stopSequences:n,topP:a,topK:r,presencePenalty:i,frequencyPenalty:l,seed:p,prompt:u,providerOptions:d,tools:c,toolChoice:h,responseFormat:m}){const g=this.collectUnsupportedSettingsWarnings({topK:r,seed:p,presencePenalty:i,frequencyPenalty:l,stopSequences:n}),{messages:f,warnings:y}=function({prompt:e,systemMessageMode:t}){const o=[],n=[];for(const{role:a,content:r}of e)switch(a){case"system":switch(t){case"system":o.push({role:"system",content:r});break;case"developer":o.push({role:"developer",content:r});break;case"remove":n.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":o.push({role:"user",content:r.map((e,t)=>{var o,n,a;switch(e.type){case"text":return{type:"input_text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){const t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"input_image",image_url:e.data instanceof URL?e.data.toString():`data:${t};base64,${e.data}`,detail:null==(n=null==(o=e.providerOptions)?void 0:o.ollama)?void 0:n.imageDetail}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)throw new s.b8({functionality:"PDF file parts with URLs"});return{type:"input_file",filename:null!=(a=e.filename)?a:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`}}throw new s.b8({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":for(const e of r)switch(e.type){case"text":o.push({role:"assistant",content:[{type:"output_text",text:e.text}]});break;case"tool-call":if(e.providerExecuted)break;o.push({type:"function_call",call_id:e.toolCallId,name:e.toolName,arguments:JSON.stringify(e.input)});break;case"tool-result":n.push({type:"other",message:"tool result parts in assistant messages are not supported for Ollama responses"})}break;case"tool":for(const e of r){const t=e.output;let s;switch(t.type){case"text":case"error-text":s=t.value;break;case"content":case"json":case"error-json":s=JSON.stringify(t.value)}o.push({type:"function_call_output",call_id:e.toolCallId,output:s})}break;default:throw new Error(`Unsupported role: ${a}`)}return{messages:o,warnings:n}}({prompt:u,systemMessageMode:"system"});g.push(...y);const v=await this.parseProviderOptions(d),w=this.buildBaseArgs({modelId:e,prompt:u,temperature:o,topP:a,maxOutputTokens:t,responseFormat:m,ollamaOptions:v}),{tools:b,toolChoice:k,toolWarnings:_}=function({tools:e,toolChoice:t}){const o=[];if(null==(e=(null==e?void 0:e.length)?e:void 0))return{tools:void 0,toolChoice:void 0,toolWarnings:o};const n=[];for(const t of e)switch(t.type){case"function":{let e=t.inputSchema;e?e&&"object"==typeof e&&"object"===e.type&&e.properties&&0===Object.keys(e.properties).length&&(e={...e,properties:{},required:[]}):e={type:"object",properties:{},required:[]},n.push({type:"function",function:{name:t.name,description:t.description,parameters:e}});break}default:o.push({type:"unsupported-tool",tool:t})}if(null==t)return{tools:n,toolChoice:void 0,toolWarnings:o};const a=t.type;switch(a){case"auto":case"none":case"required":return{tools:n,toolChoice:a,toolWarnings:o};case"tool":return{tools:n,toolChoice:"web_search_preview"==t.toolName?{type:"web_search_preview"}:{type:"function",name:t.toolName},toolWarnings:o};default:{const e=a;throw new s.b8({functionality:`tool choice type: ${e}`})}}}({tools:c,toolChoice:h});return{args:{...w,tools:b,tool_choice:k},warnings:[...g,..._]}}collectUnsupportedSettingsWarnings({topK:e,seed:t,presencePenalty:o,frequencyPenalty:s,stopSequences:n}){const a=[],r=[{value:e,name:"topK"},{value:t,name:"seed"},{value:o,name:"presencePenalty"},{value:s,name:"frequencyPenalty"},{value:n,name:"stopSequences"}];for(const{value:e,name:t}of r)null!=e&&a.push({type:"unsupported-setting",setting:t});return a}async parseProviderOptions(e){const t=await(0,n.parseProviderOptions)({provider:"ollama",providerOptions:e,schema:f});return null!=t?t:null}buildBaseArgs({modelId:e,prompt:t,temperature:o,topP:s,maxOutputTokens:n,responseFormat:a,ollamaOptions:r}){var i,l;return{model:e,messages:g({prompt:t,systemMessageMode:"system"}),temperature:o,top_p:s,max_output_tokens:n,..."json"===(null==a?void 0:a.type)&&{format:null!=a.schema?a.schema:"json"},think:null!=(i=null==r?void 0:r.think)&&i,options:null!=(l=null==r?void 0:r.options)?l:void 0}}},v=a.Ik({model:a.Yj(),created_at:a.Yj(),done:a.zM(),message:a.Ik({content:a.Yj(),role:a.Yj(),thinking:a.Yj().optional(),tool_calls:a.YO(a.Ik({function:a.Ik({name:a.Yj(),arguments:a.g1(a.Yj(),a.bz())}),id:a.Yj().optional()})).optional().nullable()}),done_reason:a.Yj().optional(),eval_count:a.ai().optional(),eval_duration:a.ai().optional(),load_duration:a.ai().optional(),prompt_eval_count:a.ai().optional(),prompt_eval_duration:a.ai().optional(),total_duration:a.ai().optional()}),w=class{constructor(e){this.config=e}processGenerateResponse(e){return{content:this.extractContent(e),finishReason:l(e.done_reason),usage:this.extractUsage(e),providerMetadata:{ollama:{}}}}extractContent(e){var t,o,s,a,r;const i=[],l=e.message.content;null!=l&&l.length>0&&i.push({type:"text",text:l});for(const l of null!=(t=e.message.tool_calls)?t:[])i.push({type:"tool-call",toolCallId:null!=(r=l.id)?r:null!=(a=null==(s=(o=this.config).generateId)?void 0:s.call(o))?a:(0,n.generateId)(),toolName:l.function.name,input:JSON.stringify(l.function.arguments)});return i}extractUsage(e){var t,o,s,n;return{inputTokens:null!=(t=e.prompt_eval_count)?t:void 0,outputTokens:null!=(o=e.eval_count)?o:void 0,totalTokens:(null!=(s=e.prompt_eval_count)?s:0)+(null!=(n=e.eval_count)?n:0),reasoningTokens:void 0,cachedInputTokens:void 0}}},b=class{constructor(e){this.config=e,this.state=this.initializeState()}createTransformStream(e,t){return new TransformStream({start:t=>{t.enqueue({type:"stream-start",warnings:e})},transform:(e,o)=>{this.processChunk(e,o,t)},flush:e=>{this.finalizeStream(e)}})}initializeState(){return{finishReason:"unknown",usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},responseId:null,ongoingToolCalls:{},hasToolCalls:!1,isFirstChunk:!0,hasTextStarted:!1,hasReasoningStarted:!1,textEnded:!1,reasoningEnded:!1,textId:(0,n.generateId)()}}processChunk(e,t,o){(null==o?void 0:o.includeRawChunks)&&t.enqueue({type:"raw",rawValue:e.rawValue});const s=function(e){var t;if(e.success)return[e.value];const o=[],s=null==(t=e.error)?void 0:t.text;if("string"!=typeof s||0===s.length)return o;const n=s.split(/\r?\n/);for(const e of n){const t=e.trim();if(""!==t)try{const e=JSON.parse(t),s=v.safeParse(e);s.success&&o.push(s.data)}catch(e){}}return o}(e);if(0!==s.length)for(const e of s)this.processResponseValue(e,t);else e.success||(this.state.finishReason="error",t.enqueue({type:"error",error:e.error}))}processResponseValue(e,t){if(e&&"object"==typeof e&&"error"in e)return this.state.finishReason="error",void t.enqueue({type:"error",error:e.error});this.state.isFirstChunk&&(this.state.isFirstChunk=!1,t.enqueue({type:"response-metadata",...p(e)})),e.done&&this.handleDoneChunk(e,t);const o=null==e?void 0:e.message;o&&this.processDelta(o,t)}handleDoneChunk(e,t){var o,s,n;this.state.finishReason=l(e.done_reason),this.state.usage={inputTokens:e.prompt_eval_count||0,outputTokens:null!=(o=e.eval_count)?o:void 0,totalTokens:(null!=(s=e.prompt_eval_count)?s:0)+(null!=(n=e.eval_count)?n:0)},this.state.hasTextStarted&&!this.state.textEnded&&(t.enqueue({type:"text-end",id:this.state.textId}),this.state.textEnded=!0),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&(t.enqueue({type:"reasoning-end",id:"0"}),this.state.reasoningEnded=!0)}processDelta(e,t){this.processTextContent(e,t),this.processThinking(e,t),this.processToolCalls(e,t)}processTextContent(e,t){null!=(null==e?void 0:e.content)&&(this.state.hasTextStarted||(t.enqueue({type:"text-start",id:this.state.textId}),this.state.hasTextStarted=!0),t.enqueue({type:"text-delta",id:this.state.textId,delta:e.content}))}processThinking(e,t){(null==e?void 0:e.thinking)&&(this.state.hasReasoningStarted||(t.enqueue({type:"reasoning-start",id:"0"}),this.state.hasReasoningStarted=!0),t.enqueue({type:"reasoning-delta",id:"0",delta:e.thinking}))}processToolCalls(e,t){var o,n,a,r;for(const i of null!=(o=e.tool_calls)?o:[]){if(null==(null==(n=i.function)?void 0:n.name))throw new s.xn({data:i,message:"Expected 'function.name' to be a string."});null!=(null==(a=i.function)?void 0:a.name)&&null!=(null==(r=i.function)?void 0:r.arguments)&&this.emitToolCall(i,t)}}emitToolCall(e,t){var o,s,a,r;const i=null!=(r=e.id)?r:null!=(a=null==(s=(o=this.config).generateId)?void 0:s.call(o))?a:(0,n.generateId)();t.enqueue({type:"tool-input-start",id:i,toolName:e.function.name}),t.enqueue({type:"tool-input-delta",id:i,delta:JSON.stringify(e.function.arguments)}),t.enqueue({type:"tool-input-end",id:i}),t.enqueue({type:"tool-call",toolCallId:i,toolName:e.function.name,input:JSON.stringify(e.function.arguments)}),this.state.hasToolCalls=!0}finalizeStream(e){this.state.hasTextStarted&&!this.state.textEnded&&e.enqueue({type:"text-end",id:"0"}),this.state.hasReasoningStarted&&!this.state.reasoningEnded&&e.enqueue({type:"reasoning-end",id:"0"}),e.enqueue({type:"finish",finishReason:this.state.finishReason,usage:this.state.usage,providerMetadata:{ollama:{responseId:this.state.responseId}}})}},k=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t,this.requestBuilder=new y,this.responseProcessor=new w(t)}get provider(){return this.config.provider}async doGenerate(e){const{args:t,warnings:o}=await this.prepareRequest(e),{responseHeaders:s,value:a,rawValue:r}=await(0,n.postJsonToApi)({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:(0,n.combineHeaders)(this.config.headers(),e.headers),body:{...t,stream:!1},failedResponseHandler:i,successfulResponseHandler:(0,n.createJsonResponseHandler)(v),abortSignal:e.abortSignal,fetch:this.config.fetch});return{...this.responseProcessor.processGenerateResponse(a),request:{body:JSON.stringify(t)},response:{modelId:this.modelId,timestamp:new Date,headers:s,body:r},warnings:o}}async doStream(e){const{args:t,warnings:o}=await this.prepareRequest(e),{responseHeaders:s,value:a}=await(0,n.postJsonToApi)({url:this.config.url({path:"/chat",modelId:this.modelId}),headers:(0,n.combineHeaders)(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:i,successfulResponseHandler:(0,n.createJsonStreamResponseHandler)(v),abortSignal:e.abortSignal,fetch:this.config.fetch}),r=new b(this.config);return{stream:a.pipeThrough(r.createTransformStream(o,e)),request:{body:t},response:{headers:s}}}async prepareRequest(e){return await this.requestBuilder.buildRequest({modelId:this.modelId,...e})}};function _(e={}){var t,o;const a=null!=(t=(0,n.withoutTrailingSlash)(e.baseURL))?t:"http://127.0.0.1:11434/api",r=null!=(o=e.name)?o:"ollama",i=()=>({"Ollama-Organization":e.organization,"Ollama-Project":e.project,...e.headers}),l=(t,o={})=>new h(t,o,{provider:`${r}.embedding`,url:({path:e})=>`${a}${e}`,headers:i,fetch:e.fetch}),p=e=>{if(new.target)throw new Error("The Ollama model function cannot be called with the new keyword.");return u(e)},u=t=>new k(t,{provider:`${r}.responses`,url:({path:e})=>`${a}${e}`,headers:i,fetch:e.fetch}),c=function(e){return p(e)};return c.languageModel=p,c.chat=p,c.completion=(t,o={})=>new d(t,o,{provider:`${r}.completion`,url:({path:e})=>`${a}${e}`,headers:i,fetch:e.fetch}),c.embedding=l,c.textEmbedding=l,c.textEmbeddingModel=l,c.imageModel=e=>{throw new s.eM({modelId:e,modelType:"imageModel",message:"Image generation is unsupported with Ollama"})},c}var x=_()}}]);