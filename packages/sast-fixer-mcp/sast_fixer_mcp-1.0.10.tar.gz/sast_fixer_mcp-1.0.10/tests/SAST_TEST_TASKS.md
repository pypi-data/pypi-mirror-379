# SAST Fixer MCP 多厂商支持架构设计

## 项目概述
设计并实现可扩展的SAST报告解析架构，支持多种厂商的SAST报告格式，包括默安、奇安信及未来可能的其他厂商。

## 测试数据结构
```
tests/
├── SAST_TEST_TASKS.md           # 本任务管理文件
├── parsers/                     # 解析器架构设计
│   ├── architecture.md          # 架构设计文档
│   └── parser_factory.py        # 解析器工厂实现
├── moan_report/                 # 默安报告测试数据
│   ├── sast_report.docx         # 默安SAST Word报告（待上传）
│   └── .scanissuefix/           # 转换后的JSON文件目录
├── qianxin_report/              # 奇安信报告测试数据
│   ├── sast_report.docx         # 奇安信SAST Word报告（待上传）
│   └── .scanissuefix/           # 转换后的JSON文件目录
├── other_vendors/               # 其他厂商报告测试数据
│   └── (未来扩展)
└── test_sast_mcp.py             # 综合测试脚本（待创建）
```

## 架构设计目标
1. **可扩展性**: 支持新厂商格式，无需修改核心逻辑
2. **统一输出**: 所有厂商格式转换为相同JSON结构
3. **自动识别**: 智能检测报告厂商和格式
4. **向后兼容**: 保持现有默安格式完全兼容
5. **容错性**: 优雅处理未知或损坏的格式

## 任务列表

### 任务0: 可扩展架构设计
- **状态**: ✅ 已完成
- **描述**: 设计支持多厂商SAST报告的可扩展架构
- **要求**:
  - ✅ 设计解析器接口和工厂模式
  - ✅ 定义统一的JSON输出格式规范
  - ✅ 实现厂商格式自动检测机制
  - ✅ 创建解析器注册和管理系统
- **输出**:
  - ✅ `src/sast_fixer_mcp/parsers/base.py` - 解析器接口定义
  - ✅ `src/sast_fixer_mcp/parsers/factory.py` - 解析器工厂实现
  - ✅ `src/sast_fixer_mcp/parsers/moan_parser.py` - 默安解析器实现
  - ✅ `tests/parsers/architecture.md` - 架构设计文档
  - ✅ 重构server.py集成多厂商架构

### 任务1: 默安SAST报告测试
- **状态**: ✅ 已完成
- **描述**: 为默安SAST报告创建测试用例
- **要求**:
  - ✅ 测试 `convert_sast_docx_to_json` 方法
  - ✅ 测试 `get_pending_vulnerability_json_files` 方法
  - ✅ 测试 `generate_csv_report` 方法
  - ✅ 验证JSON转换结果的正确性
- **依赖**: ✅ 默安SAST报告文件已存在
- **输出**:
  - ✅ `tests/test_sast_mcp.py` - 综合测试脚本
  - ✅ `tests/test_moan_parser.py` - 默安解析器测试
  - ✅ 验证现有转换逻辑工作正常
  - ✅ 多厂商架构功能测试通过

### 任务2: 奇安信SAST报告结构分析
- **状态**: ✅ 已完成
- **描述**: 分析奇安信Word文档结构，了解与默安的差异
- **要求**:
  - ✅ 解析奇安信Word文档结构
  - ✅ 识别标题、内容、表格格式差异
  - ✅ 对比与默安报告的结构差异
  - ✅ 设计兼容方案
- **依赖**: ✅ 奇安信SAST报告文件 webgoat.docx 已存在
- **输出**:
  - ✅ `tests/analyze_qianxin_structure.py` - 结构分析工具
  - ✅ `tests/qianxin_report/structure_analysis_report.md` - 结构分析报告
  - ✅ 兼容性改进方案已制定

### 任务3: 多厂商解析器实现
- **状态**: ✅ 已完成
- **描述**: 基于架构设计实现多厂商解析器系统
- **要求**:
  - ✅ 重构现有server.py为模块化架构
  - ✅ 实现默安解析器(保持兼容性)
  - ✅ 实现奇安信解析器
  - ✅ 实现解析器工厂和自动检测
  - ✅ 添加新厂商解析器的扩展机制
- **依赖**: ✅ 任务0的架构设计已完成
- **输出**:
  - ✅ 重构的 `server.py`
  - ✅ 独立的解析器模块
  - ✅ 厂商检测逻辑
  - ✅ `src/sast_fixer_mcp/parsers/qianxin_parser.py` - 奇安信解析器实现
  - ✅ 多厂商自动选择机制验证通过

### 任务4: 未来厂商扩展框架
- **状态**: ⏳ 待开始
- **描述**: 建立支持未来新厂商的扩展框架和文档
- **要求**:
  - 创建解析器开发指南
  - 提供解析器模板和示例
  - 建立测试框架和验证标准
  - 编写厂商集成文档
- **依赖**: 完成任务3的多厂商实现
- **输出**:
  - 开发者指南文档
  - 解析器模板代码
  - 测试框架

### 任务5: 综合测试验证
- **状态**: ⏳ 待开始
- **描述**: 测试多厂商解析器系统的完整功能
- **要求**:
  - 默安格式回归测试
  - 奇安信格式功能测试
  - 多厂商格式混合测试
  - 自动检测机制验证
  - 性能和容错性测试
- **依赖**: 完成任务1、2、3
- **输出**:
  - 完整测试报告
  - 性能基准数据
  - 兼容性验证结果

## 开发检查清单

### 代码质量
- [ ] 添加适当的错误处理
- [ ] 保持现有API接口不变
- [ ] 添加格式检测和验证
- [ ] 确保路径安全性

### 测试覆盖
- [ ] 单元测试覆盖所有新增功能
- [ ] 集成测试验证端到端流程
- [ ] 回归测试确保原功能正常
- [ ] 边界条件测试

### 文档更新
- [ ] 更新README.md说明支持的格式
- [ ] 添加奇安信格式的使用示例
- [ ] 更新API文档

## 执行日志

### 2024-09-17
- ✅ 创建测试目录结构
- ✅ 创建任务管理文档
- ✅ 设计可扩展架构方案
- ✅ 创建解析器接口和工厂模式原型
- ⏳ 等待用户上传测试数据

### 2024-09-18
- ✅ 完成多厂商解析器架构实现
- ✅ 创建src/sast_fixer_mcp/parsers包结构
- ✅ 实现ISASTParser接口和SASTParserFactory
- ✅ 实现MoAnParser默安解析器
- ✅ 重构server.py集成多厂商架构
- ✅ 创建综合测试套件tests/test_sast_mcp.py
- ✅ 验证多厂商架构正常工作
- ✅ 修复Unicode编码问题
- ✅ 完成Task 0和Task 1
- ✅ 完成Task 2: 奇安信SAST报告结构分析
  - ✅ 创建analyze_qianxin_structure.py分析工具
  - ✅ 生成结构分析报告
  - ✅ 识别奇安信与默安格式差异
- ✅ 完成Task 3: 多厂商解析器实现
  - ✅ 实现QiAnXinParser奇安信解析器
  - ✅ 验证奇安信文档解析功能(100个漏洞项)
  - ✅ 验证多厂商自动选择机制
  - ✅ 测试JSON输出格式一致性
- ✅ 优化风险级别过滤
  - ✅ 更新奇安信解析器只处理中危和高危漏洞
  - ✅ 验证两个解析器都正确过滤低危漏洞
  - ✅ 奇安信: 135个→38个漏洞(20高危+18中危)
  - ✅ 默安: 保持原有过滤逻辑(1高危+2中危)

---

## 注意事项
1. 保持向后兼容性 - 不能破坏现有默安格式的支持
2. 统一JSON输出格式 - 两种输入格式应产生相同结构的JSON
3. 错误处理 - 优雅处理不支持的文档格式
4. 性能考虑 - 大文档的处理效率
5. 安全性 - 文件路径验证和边界检查

## 联系方式
如有问题或需要协助，请在开发过程中及时反馈。