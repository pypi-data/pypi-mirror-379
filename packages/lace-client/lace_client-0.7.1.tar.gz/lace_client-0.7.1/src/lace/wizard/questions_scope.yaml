# EU AI Act Compliance - Scope Classification Questions
# Version: 1.1.0
# Last Updated: 2025-08-18
# Based on Commission Q&A and Template Guidance
#
# CRITICAL FIXES:
# - No EU rep carve-out for open-source
# - >= 10^25 for systemic risk
# - No 10^23 GPAI threshold
# - Significant modifiers are providers

version: "1.1.0"
schema_version: "2025-07"
generated_by: "lace-wizard"

# Scope determination questions (MUST BE FIRST)
gating_scope:
  - id: placing_date
    text: "When will/did you first make this model available in the EU?"
    type: date
    required: true
    critical: true
    help: |
      This is your "placing on the market" date.
      Includes: APIs, downloads, cloud services, integration into applications.
      Also includes internal processes that are:
      - Essential to providing your product/service, OR
      - Affecting individuals' rights
      
      This date determines your compliance deadlines:
      - Pre-Aug 2, 2025: 2-year grace for public summary (due Aug 2, 2027)
      - Post-Aug 2, 2025: All obligations due on placing date
    validate:
      regex: '^\d{4}-\d{2}-\d{2}$'
    determines: compliance_deadlines
    map_to: scope.placing_date
  
  - id: still_on_market
    text: "Is the model still (or will be) available in the EU?"
    type: boolean
    required: true
    show_if: placing_date < "2025-08-02"
    help: "Grace period only applies if model remains on market"
    map_to: scope.still_on_market
  
  - id: sme_status
    text: "Do you qualify as an EU SME (Small/Medium Enterprise)?"
    type: select
    required: true
    critical: true
    options:
      - value: "yes_sme"
        label: "Yes - We qualify as SME per EU definition"
        help: "<250 employees AND (≤€50M turnover OR ≤€43M balance sheet)"
      - value: "no_not_sme"
        label: "No - We are not an SME"
      - value: "unsure"
        label: "Unsure - We'll use standard (non-SME) rules"
    help: |
      SME per EU definition (must meet ALL criteria):
      - Fewer than 250 employees
      - Annual turnover ≤ €50 million OR balance sheet ≤ €43 million
      
      SME Benefit: Top domains disclosure is 5% or 1000 (whichever lower) instead of 10%
    determines: top_domain_rule
    map_to: scope.sme_status
  
  - id: eu_availability
    text: "Will this model or any system using it be available in the EU?"
    type: boolean
    required: true
    help: |
      "Available" includes:
      - APIs accessible from EU
      - Downloads to EU users
      - Cloud services used in EU
      - Integration into apps/services offered in EU
      - Internal use if essential OR affects rights
    map_to: scope.eu_availability
  
  # Triad questions for placement determination
  - id: offered_in_eu_market
    text: "Is the model directly offered in the EU market?"
    type: select
    required: true
    options:
      - value: "yes"
        label: "Yes - Directly offered in EU"
      - value: "no"
        label: "No - Not directly offered"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Answer YES if:
      - Model API accessible from EU
      - Model weights downloadable in EU
      - Model as a service offered to EU users
      - Model sold/licensed to EU entities
    map_to: scope.offered_in_eu_market
  
  - id: offered_in_eu_market_unsure_description
    text: "Please describe how the model is made available:"
    type: text
    show_if: offered_in_eu_market == "unsure"
    help: "Describe distribution method, access restrictions, geographic availability, etc."
    map_to: scope.offered_in_eu_market_unsure_description
  
  - id: integrated_into_own_system
    text: "Is the model integrated into your own AI system made available in EU?"
    type: select
    required: true
    options:
      - value: "yes"
        label: "Yes - Integrated into our system"
      - value: "no"
        label: "No - Not integrated"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Answer YES if the model powers:
      - Customer-facing features (chatbots, recommendations)
      - Internal tools essential to service delivery
      - Products/services offered in EU market
    map_to: scope.integrated_into_own_system
  
  - id: integrated_into_own_system_unsure_description
    text: "Please describe how the model is used in your system:"
    type: text
    show_if: integrated_into_own_system == "unsure"
    help: "Describe integration, purpose, whether customer-facing, etc."
    map_to: scope.integrated_into_own_system_unsure_description
  
  - id: internal_only_use
    text: "Is the model used ONLY internally (not customer-facing)?"
    type: select
    required: true
    options:
      - value: "yes"
        label: "Yes - Internal use only"
      - value: "no"
        label: "No - External/customer use"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Answer YES only if model is:
      - Never exposed to customers/clients
      - Used only by internal staff
      - Not part of any external product/service
    map_to: scope.internal_only_use
  
  - id: internal_only_use_unsure_description
    text: "Please describe who uses the model and how:"
    type: text
    show_if: internal_only_use == "unsure"
    help: "Describe users (internal staff, customers, partners), access methods, etc."
    map_to: scope.internal_only_use_unsure_description
  
  - id: essential_to_service
    text: "Is the model essential to providing your product/service?"
    type: select
    show_if: internal_only_use == "yes" || internal_only_use == "unsure"
    required: true
    options:
      - value: "yes"
        label: "Yes - Essential/critical"
      - value: "no"
        label: "No - Not essential"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Answer YES if:
      - Core to business operations (e.g., bank's credit scoring)
      - Service would fail without it
      - Customer experience depends on it
      - Key differentiator or value proposition
      
      Answer NO if:
      - Nice-to-have but not critical
      - R&D/experimental only
      - Could be removed without major impact
    map_to: scope.essential_to_service
  
  - id: essential_to_service_unsure_description
    text: "Please describe the model's role in your service:"
    type: text
    show_if: essential_to_service == "unsure"
    help: "Describe importance, what would happen if removed, business impact, etc."
    map_to: scope.essential_to_service_unsure_description
  
  - id: affects_individuals_rights
    text: "Could the model affect individuals' rights or freedoms?"
    type: select
    show_if: internal_only_use == "yes" || internal_only_use == "unsure"
    required: true
    options:
      - value: "yes"
        label: "Yes - Affects rights"
      - value: "no"
        label: "No - No rights impact"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Answer YES if model influences:
      - Credit/lending decisions
      - Fraud detection (account freezing)
      - Employment/HR decisions
      - Hiring/recruitment filters
      - Performance evaluations
      - Employee monitoring/surveillance
      - Access controls or permissions
      - Legal/medical recommendations
      - Content moderation
      - Eligibility determinations
      
      Answer NO if model only:
      - Generates internal analytics/dashboards
      - Formats code or documents
      - Summarizes meetings (no decisions)
      - Powers R&D experiments
      
      NOTE: This includes effects on employees, not just customers!
      When in doubt, answer YES (conservative default).
    map_to: scope.affects_individuals_rights
  
  - id: affects_individuals_rights_unsure_description
    text: "Please describe what the model does and who it affects:"
    type: text
    show_if: affects_individuals_rights == "unsure"
    help: "Describe decisions made, users affected (employees/customers), data used, etc."
    map_to: scope.affects_individuals_rights_unsure_description
  
  - id: provider_status
    text: "What is your role with this model?"
    type: select
    required: true
    options:
      - value: "built_model"
        label: "We built/commissioned this model"
      - value: "significant_modifier"
        label: "We're significantly modifying someone else's model (may be >33% compute)"
      - value: "light_finetuner"
        label: "We're lightly fine-tuning (≤33% compute)"
      - value: "api_user"
        label: "We're just using someone else's model via API"
      - value: "internal_only"
        label: "Internal use only (non-essential, no rights impact)"
      - value: "unsure"
        label: "Unsure - Need help determining"
    help: |
      Commission guidance on "placing on the market":
      - APIs/downloads/cloud = placing
      - Integration into your app = placing
      - Internal if essential to service = placing
      - Internal if affects rights = placing
      - Internal non-essential + no rights = NOT placing
    map_to: scope.provider_status
  
  - id: provider_status_unsure_description
    text: "Please describe your involvement with the model:"
    type: text
    show_if: provider_status == "unsure"
    help: "Describe training, modification, API usage, compute used, etc."
    map_to: scope.provider_status_unsure_description
  
  # Functional GPAI detection
  - id: general_purpose
    text: "Is this model designed for general-purpose tasks?"
    type: boolean
    required: true
    help: |
      General-purpose means the model can perform a wide range of tasks
      (text generation, translation, summarization, Q&A, etc.) rather than
      being specialized for a single narrow task.
    map_to: scope.general_purpose
  
  - id: multi_task_capable
    text: "Can this model handle multiple distinct task types?"
    type: boolean
    show_if: general_purpose == true
    help: "Examples: text + code, vision + language, multiple languages"
    map_to: scope.multi_task_capable
  
  # Indicative GPAI hints (non-gating)
  - id: indicative_gpai_hint
    text: "ℹ️ Indicative GPAI Signals (informational only)"
    type: info
    help: |
      Models are often general-purpose if they have:
      - ~10^23+ FLOP training compute (typical threshold)
      - ≥1B parameters (Recital 98 indicator)
      - Multi-modal capabilities
      - Wide task adaptability
      
      These are indicators, not legal requirements.
  
  - id: parameter_count_hint
    text: "Approximate parameter count (optional indicator):"
    type: select
    required: false
    options:
      - value: "under_1b"
        label: "Under 1 billion parameters"
        help: "Typically task-specific"
      - value: "over_1b"
        label: "1 billion or more parameters"
      - value: "unknown"
        label: "Unknown/Prefer not to say"
    help: |
      Per Recital 98: Models with ≥1B parameters are often general-purpose.
      This is an indicator, not a strict threshold.
    map_to: scope.parameter_count_hint
  
  # CRITICAL FIX: Precise bins for >1/3 threshold
  - id: modification_compute_ratio
    text: "Your compute as % of original training (if known):"
    type: select
    show_if: provider_status == "significant_modifier" || provider_status == "unsure"
    options:
      - value: "unknown"
        label: "Unknown/Cannot estimate"
      - value: "le_33"
        label: "≤ 33% (at or below one-third)"
      - value: "unsure"
        label: "Unsure - Need help calculating"
      - value: "gt_33_to_50"
        label: "> 33% to 50%"
      - value: "gt_50"
        label: "> 50%"
    help: |
      Commission guidance uses **more than one-third** (> 33%) as the indicative threshold.
      - 33% or less → NOT significant
      - Strictly greater than 33% → Significant
    map_to: scope.modification_compute_ratio
  
  - id: modification_compute_ratio_unsure_description
    text: "Please describe your training/modification process:"
    type: text
    show_if: modification_compute_ratio == "unsure"
    help: "Describe compute used, training time, base model size, your training details, etc."
    map_to: scope.modification_compute_ratio_unsure_description
  
  - id: believes_significant
    text: "Do you believe your modification significantly alters the model?"
    type: boolean
    show_if: modification_compute_ratio == "unknown"
    help: |
      Consider if your modification:
      - Adds new modalities (text→multimodal)
      - Changes primary use cases
      - Alters risk profile
      - Affects generality/capabilities
    map_to: scope.believes_significant
  
  # Systemic risk threshold (strictly greater than)
  - id: training_compute_flops
    text: "Total training compute (if known):"
    type: select
    options:
      - value: "unknown"
        label: "Unknown/Cannot estimate"
      - value: "under_1e23"
        label: "Under 10^23 FLOP"
        help: "Typically not general-purpose"
      - value: "1e23_to_1e25"
        label: "10^23 to 10^25 FLOP"
        help: "Typical range for general-purpose models (indicative)"
      - value: "exactly_1e25"
        label: "Exactly 10^25 FLOP"
        help: "NOT systemic risk (threshold is exceeded, not met)"
      - value: "over_1e25"
        label: "Over 10^25 FLOP"
        help: "Systemic risk - additional obligations apply"
    help: |
      Systemic risk: Models EXCEEDING 10^25 FLOP (strictly >)
      10^23 FLOP: Typical indicator of general-purpose (non-binding)
      Exactly 10^25: NOT systemic by compute presumption
    map_to: scope.training_compute_flops
  
  # FIX #1: Updated open-source text
  - id: open_source_release
    text: "Will you release this under a free/open-source license?"
    type: boolean
    help: |
      Requirements for open-source carve-outs:
      - Weights publicly available
      - Architecture disclosed
      - Usage information provided
      - Free/open-source license
      
      Note: You STILL need public summary & copyright policy!
      Carve-outs only for: tech docs to authorities, downstream docs
      EU representative still required if non-EU provider (no carve-out)
    map_to: scope.open_source_release
  
  - id: outside_eu_provider
    text: "Is the provider entity based outside the EU?"
    type: boolean
    help: |
      Non-EU providers need an EU authorized representative (Article 54)
      Exception: Open-source without monetisation + not systemic risk
    map_to: scope.outside_eu_provider
  
  # Additional open-source conditions
  - id: open_source_license_type
    text: "Which open-source license are you using?"
    type: select
    show_if: open_source_release == true
    required: true
    options:
      - value: "apache2"
        label: "Apache 2.0"
      - value: "mit"
        label: "MIT"
      - value: "unsure"
        label: "Unsure - Need help identifying"
      - value: "gpl3"
        label: "GPL v3"
      - value: "gpl2"
        label: "GPL v2"
      - value: "bsd"
        label: "BSD (2/3-clause)"
      - value: "mpl2"
        label: "Mozilla Public License 2.0"
      - value: "cc_by"
        label: "Creative Commons BY"
      - value: "other_oss"
        label: "Other OSI-approved license"
      - value: "custom"
        label: "Custom/proprietary license terms"
      - value: "none"
        label: "No license specified"
    help: |
      For carve-outs, must be a recognized free/open-source license.
      Custom licenses will trigger legal review warning.
    map_to: scope.open_source_license_type
  
  - id: open_source_license_type_unsure_description
    text: "Please describe your license or terms:"
    type: text
    show_if: open_source_license_type == "unsure"
    help: "Paste license text or describe terms"
    map_to: scope.open_source_license_type_unsure_description
  
  - id: access_gating_type
    text: "How is access to model weights provided?"
    type: select
    show_if: open_source_release == true
    required: true
    options:
      - value: "none"
        label: "No gating (direct public download)"
      - value: "login_only"
        label: "Free download but login/registration required"
      - value: "unsure"
        label: "Unsure - Need help determining"
      - value: "api_key_free"
        label: "API key required but free/unrestricted"
      - value: "rate_limited_free"
        label: "Rate-limited but free"
      - value: "waitlist"
        label: "Waitlist or approval required"
      - value: "geo_restricted"
        label: "Region-restricted access"
      - value: "paid"
        label: "Paid access required"
      - value: "enterprise_only"
        label: "Enterprise contract only"
    help: |
      Paid or enterprise-only access is NOT compatible with carve-outs.
      Login/API keys that are free and non-discretionary typically acceptable
      but will trigger a warning for verification.
    map_to: scope.access_gating_type
  
  - id: access_gating_type_unsure_description
    text: "Please describe how users access the model:"
    type: text
    show_if: access_gating_type == "unsure"
    help: "Describe download process, requirements, restrictions, etc."
    map_to: scope.access_gating_type_unsure_description
  
  - id: open_source_without_monetisation
    text: "Is the model released free to access without monetisation?"
    type: boolean
    required: true
    show_if: open_source_release == true
    help: "Carve-outs only apply if truly free and not monetised"
    map_to: scope.open_source_without_monetisation
  
  - id: weights_arch_usage_public
    text: "Are weights, architecture, and usage info publicly available?"
    type: boolean
    required: true
    show_if: open_source_release == true
    help: "All three must be public for carve-outs to apply"
    map_to: scope.weights_arch_usage_public
  
  # Systemic risk designation
  - id: designated_systemic_risk
    text: "Has the Commission designated this model as systemic risk?"
    type: boolean
    default: false
    help: "Models can be designated systemic even below compute threshold"
    map_to: scope.designated_systemic_risk
  
  # Notification requirements
  - id: will_exceed_1e25
    text: "Do you expect training to exceed 10^25 FLOP?"
    type: boolean
    help: "Triggers notification requirement to Commission"
    map_to: scope.will_exceed_1e25
  
  - id: threshold_known_date
    text: "When did you know the threshold would be/was exceeded?"
    type: date
    show_if: will_exceed_1e25 == true OR training_compute_flops == 'over_1e25'
    help: "Must notify Commission within 14 days of this date"
    map_to: scope.threshold_known_date
  
  # Base model reference (for modifiers)
  - id: base_model_name
    text: "Name of the base model you're modifying:"
    type: text
    required: true
    show_if: provider_status == 'significant_modifier'
    help: "E.g., 'GPT-4', 'Llama 3.1', 'Mistral 7B'"
    map_to: scope.base_model_name
  
  - id: base_model_provider
    text: "Provider of the base model:"
    type: text
    required: true
    show_if: provider_status == 'significant_modifier'
    help: "E.g., 'OpenAI', 'Meta', 'Mistral AI'"
    map_to: scope.base_model_provider
  
  - id: base_model_url
    text: "URL to base model's public summary (if available):"
    type: url
    show_if: provider_status == 'significant_modifier'
    help: "Link to the base model's Article 53 public summary"
    map_to: scope.base_model_url
  
  - id: modification_description
    text: "Brief description of your modification:"
    type: text
    show_if: provider_status == 'significant_modifier'
    help: "E.g., 'Fine-tuned for medical diagnosis', 'Adapted for French legal text'"
    map_to: scope.modification_description
  
  # Modification web scraping details
  - id: modification_web_top_domains
    text: "Top domains in your modification's web-scraped data:"
    type: textarea
    show_if: provider_status == 'significant_modifier' AND web_scraped_modification == true
    help: "List the top domains by volume used in modification (one per line)"
    map_to: scope.modification_web_top_domains
  
  - id: modification_web_volume_method
    text: "How did you measure domain volume?"
    type: select
    show_if: provider_status == 'significant_modifier' AND web_scraped_modification == true
    options:
      - value: "bytes"
        label: "Bytes"
      - value: "tokens"
        label: "Tokens"
      - value: "documents"
        label: "Documents"
    default: "bytes"
    help: "Method used to calculate top domains"
    map_to: scope.modification_web_volume_method
  
  # Update timing
  - id: last_summary_published_on
    text: "When was your last public summary published?"
    type: date
    show_if: is_update == true
    help: "Used to calculate next 6-month update deadline"
    map_to: scope.last_summary_published_on
  
  # Change detection for updates
  - id: is_update
    text: "Is this an update to an existing public summary?"
    type: boolean
    help: "Updates required every 6 months or sooner if significant changes"
    map_to: scope.is_update
  
  - id: changes_since_last
    text: "What has changed since your last summary?"
    type: multiselect
    show_if: is_update == true
    options:
      - "Training data sources"
      - "Top domains list (membership changes)"
      - "Domain coverage (>10% shift)"
      - "Dataset size/volume"
      - "Lawful basis"
      - "Opt-out implementation"
      - "PII handling methods"
      - "Nothing significant"
    determines: update_trigger
    map_to: scope.changes_since_last

# Question selection rules for scope
scope_selection_rules:
  # Questions that are ALWAYS asked regardless of confidence
  always_ask:
    - placing_date
    - sme_status
    - eu_availability
    - provider_status
    - general_purpose
    - open_source_release
    - outside_eu_provider
  
  # Additional questions based on conditions
  conditional:
    - modification_compute_ratio  # If significant_modifier
    - believes_significant  # If ratio unknown
    - multi_task_capable  # If general_purpose
    - parameter_count_hint  # Optional indicator
    - training_compute_flops  # For systemic risk
    - still_on_market  # If pre-existing
    - is_update  # For tracking changes
    - changes_since_last  # If update

# Controlled vocabularies
enums:
  compute_thresholds:
    systemic_risk: 1e25    # ≥10^25 FLOP (not >)
    # CRITICAL: "more than one-third" means STRICTLY GREATER
    significant_modification_ratio: 0.333333  # Use > not >=
    # Note: No official GPAI FLOP threshold
  
  generality_indicators:
    parameter_hint: 1e9  # ≥1B parameters per Recital 98
    note: "Functional test, not strict threshold"
  
  sme_criteria:
    max_employees: 249  # Fewer than 250
    max_turnover_eur: 50000000
    max_balance_sheet_eur: 43000000
  
  top_domain_rules:
    standard: "10% (min 1)"
    sme: "5% or 1000 (whichever lower, min 1)"
  
  open_source_carve_outs:
    # Only if not systemic risk (NO EU rep carve-out)
    - "Technical documentation for authorities (Art. 53(1)(a) partial)"
    - "Downstream documentation requirements (Art. 53(1)(b) partial)"
  
  open_source_still_requires:
    # Always required, even for open-source
    - "Public summary of training content (Art. 53(1)(d))"
    - "Copyright compliance policy (Art. 53(1)(c))"
    - "EU authorized representative if non-EU (Art. 54)"

# Notes for implementation
implementation_notes:
  - "Scope questions MUST be asked first to determine obligations"
  - "No EU rep carve-out for open-source (Commission guidance)"
  - "≥10^25 FLOP for systemic risk (exactly 10^25 IS systemic)"
  - "Significant modifiers are full providers"
  - "No 10^23 GPAI threshold - use functional criteria"
  - "Top domains need min 1 guard against empty results"
  - "Domain membership changes trigger immediate update"
  - "This is guidance, not legal advice"