<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>FIEライブラリ: リージョン処理 応用例</title>
<link href="fvalg-prod.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- 作成： Doxygen 1.5.6-FASTSP-p2 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="contents">
<h1>リージョン処理 応用例<br>
<small>
[<a class="el" href="group__fie__sample__code__list.html">サンプルコード一覧</a>]</small>
</h1><hr>
<h2><a class="anchor" name="smp_img_to_region">
" 指定した点を囲む輪郭を元にリージョンを生成"</a></h2>
<div class="fragment"><pre class="fragment"><span class="comment">// エラー処理は省略しているので注意して下さい。</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include "oal_aloc.h"</span>
<span class="preprocessor">#include "fie.h"</span>

<span class="comment">/*</span>
<span class="comment">  入力画像に映る目立った形状から2値化済みリージョン画像を生成するサンプルコード</span>
<span class="comment"></span>
<span class="comment">  このサンプルコードは入力画像に映っている目立った物体の輪郭を構成する点群をエッジ検出で獲得したのち</span>
<span class="comment">  得られた点を繋げてリージョンにして出力します。</span>
<span class="comment"></span>
<span class="comment">  また目立った形状をリージョンとしているのでマスクとして活用することができます。</span>
<span class="comment">  例えば生成後の画像に対して膨張処理を行った場合、他処理を行う際に処理範囲を限定して高速化したり</span>
<span class="comment">  収縮処理を行うことで輪郭より内側の部分を消したりすることができます。</span>
<span class="comment">  詳しくはfnFIE_fpm_feature_mask(),fnFIE_refilter_edge_by_mask(),fnFIE_img_meanpixel()</span>
<span class="comment">  などに記載されているサンプルコード等をご確認ください。</span>
<span class="comment"></span>
<span class="comment">*/</span>


FHANDLE fnSMP_img_to_region(FHANDLE himg, <a class="code" href="structDPNT__T.html" title="２次元座標指定用構造体(DOUBLE)">DPNT_T</a> point)
{
    FHANDLE             hreg = NULL;                           <span class="comment">//リージョン用のハンドル</span>

    <a class="code" href="structF__EDGE__SOBEL__PARAMS.html" title="Sobelエッジ用パラメータ構造体">F_EDGE_SOBEL_PARAMS</a> params;                                <span class="comment">//エッジ検出用パラメータ</span>
    UINT                feat_mode = <a class="code" href="group__fie__edge__detector.html#gf1b0219a1aaa48472cfc9f272687d30f" title="エッジ勾配方向、強度保持指定フラグ エッジの勾配方向を取得する...">F_EDGE_FEAT_DIRECT</a>;        <span class="comment">//エッジ検出時の勾配方向、強度データ保持の指定に関するパラメータ</span>
    INT                 border_mode = <a class="code" href="group__fie__std__operation.html#gg5d19240b9c8e02c83b5d8b40540ecd4f485fa63ed437a605b6fd5ed01bf68b9b" title="ボーダー処理無し">F_BORDER_NONE</a>;           <span class="comment">//エッジ検出時のボーダー処理の種類選択に関するパラメータ</span>
    <a class="code" href="structDPNT__T.html" title="２次元座標指定用構造体(DOUBLE)">DPNT_T</a>              offset = { 0,0 } ;                     <span class="comment">//エッジ検出時のオフセット量</span>

    <a class="code" href="structF__DEDGE.html" title="勾配方向、強度付エッジ点構造体(浮動小数点型)">F_DEDGE</a>*            edges = NULL;                          <span class="comment">//エッジ点配列の作業用ポインタ</span>
    INT                 edge_num = 0;                          <span class="comment">//検出されたエッジ点の個数    </span>
    INT                 index[1] = { 0 };                      <span class="comment">//処理対象エッジ点クラスタのインデックス配列 </span>
    DOUBLE              angle_range = 0.8 * PI;                <span class="comment">//クラスタリング時の探索角度範囲 単位: radian</span>
    INT                 distance_range = 2;                    <span class="comment">//クラスタリング時の探索距離範囲 単位: pixel</span>
    INT                 min_clust_elem = 2;                    <span class="comment">//クラスタに属するエッジ点個数の最小値</span>
    INT                 max_clust_elem = -1;                   <span class="comment">//クラスタに属するエッジ点個数の最大値</span>

    <a class="code" href="structF__EDGE__CLUST.html" title="エッジ点クラスタ構造体">F_EDGE_CLUST</a>*       edge_clust = NULL;                     <span class="comment">//抽出した曲線の配列</span>
    INT                 clust_num = 0;                         <span class="comment">//抽出した曲線の個数</span>
    <a class="code" href="structF__DEDGE.html" title="勾配方向、強度付エッジ点構造体(浮動小数点型)">F_DEDGE</a>*            dst_edges = NULL;                      <span class="comment">//出力エッジ点 配列</span>
    INT                 dst_edge_num = 0;                      <span class="comment">//出力エッジ点の個数</span>
    <a class="code" href="structPNT__T.html" title="２次元整数座標指定用構造体(INT)">PNT_T</a>*              out_point = NULL;                      <span class="comment">//出力座標点列</span>
    INT                 num_dst = 0;                           <span class="comment">//出力座標点列のサイズ </span>
    DOUBLE              threshold = 10;                        <span class="comment">//折れ線閾値</span>

    <a class="code" href="structPNT__T.html" title="２次元整数座標指定用構造体(INT)">PNT_T</a>*              point_cloud1 = NULL;                   <span class="comment">//F_DEDGE to PNT_T変換用配列</span>
    <a class="code" href="structDPNT__T.html" title="２次元座標指定用構造体(DOUBLE)">DPNT_T</a>*             point_cloud2 = NULL;                   <span class="comment">//PNT_T to DPNT_T変換用配列</span>

    INT                 i = 0;
    INT                 c_num = 0;
    INT                 result;

    <span class="comment">//パラメータの設定</span>
    params.<a class="code" href="structF__EDGE__SOBEL__PARAMS.html#ecd04096837807aa19a453ff060b3658">mag_threshold</a> = 30;                   <span class="comment">// 強度しきい値                    </span>
    params.<a class="code" href="structF__EDGE__SOBEL__PARAMS.html#d59647967a163cc6c3fda736ca440d10">nms_length</a> = 1;                       <span class="comment">// 非極大抑制のフィルタ片幅        </span>

    <span class="comment">//ソーベルフィルタを利用した２次元エッジ検出</span>
    <a class="code" href="group__fie__edge__detector.html#g4ec620016bd6eeec73e1ad5bc3ddd673" title="ソーベルフィルタを利用したエッジ検出(サブピクセル精度)">fnFIE_edge_sobel_subpix</a>(himg, NULL, &amp;params, feat_mode, border_mode, offset, &amp;edges, &amp;edge_num);

    <span class="comment">//エッジ点の連結により物体の輪郭を構成する曲線を作成</span>
    <a class="code" href="group__fie__edge__tools.html#g1f84988947c19bf2d4d312a69fabcc2a" title="エッジ点の連結">fnFIE_edge_connecting2</a>(edges, edge_num, angle_range, distance_range, min_clust_elem, max_clust_elem, &amp;edge_clust, &amp;clust_num);

    <span class="comment">//連結した曲線の数だけ繰り返す</span>
    <span class="keywordflow">for</span> (c_num = 0; c_num &lt; clust_num; c_num++)
    {
        <span class="comment">//曲線を構成するエッジ点群を抽出して使わないエッジ点を排除</span>
        index[0] = c_num;
        <a class="code" href="group__fie__edge__tools.html#g042f86e1016a1fe17de7cdd9e5a16a42" title="クラスタ情報による エッジ点群のフィルタリング">fnFIE_refilter_edge_by_clust</a>(edges, edge_num, edge_clust, clust_num, index, 1, &amp;dst_edges, &amp;dst_edge_num);

        <span class="comment">//出力エッジ点の個数ｘPNT_Tサイズのメモリを確保</span>
        point_cloud1 = <a class="code" href="group__memory__alloc.html#g80e0d9105acd3ea67cd8c5194a19f3d6" title="メモリブロックの割当">fnOAL_malloc</a>(dst_edge_num * (<span class="keyword">sizeof</span>(<a class="code" href="structPNT__T.html" title="２次元整数座標指定用構造体(INT)">PNT_T</a>)));
        out_point = <a class="code" href="group__memory__alloc.html#g80e0d9105acd3ea67cd8c5194a19f3d6" title="メモリブロックの割当">fnOAL_malloc</a>(dst_edge_num * (<span class="keyword">sizeof</span>(<a class="code" href="structPNT__T.html" title="２次元整数座標指定用構造体(INT)">PNT_T</a>)));

        <span class="comment">//座標の値をDOUBLEからINTに変換するため出力エッジ点群をPNT_T配列にコピー（四捨五入）</span>
        <span class="keywordflow">for</span> (i = 0; i &lt; dst_edge_num; i++) {
            point_cloud1[i].<a class="code" href="structPNT__T.html#4ff9a28ef8ff1a15f3536f989ad05010">x</a> = <a class="code" href="group__fie__math.html#g103dfeaed50d6ebc7b626efae675cdb4" title="入力数値(DOUBLE)の四捨五入した数値(INT)を返す">fnFIE_d4i5</a>(dst_edges[i].x);
            point_cloud1[i].<a class="code" href="structPNT__T.html#5dadbd324332104d1ccf225671098a30">y</a> = <a class="code" href="group__fie__math.html#g103dfeaed50d6ebc7b626efae675cdb4" title="入力数値(DOUBLE)の四捨五入した数値(INT)を返す">fnFIE_d4i5</a>(dst_edges[i].y);
        }

        <span class="comment">//点列の折れ線化で更に余計なエッジ点を取り除く。輪郭の頂点になる点を取得。</span>
        <a class="code" href="group__fie__cg__fitting.html#g00a3c5b44dc62afce4a9bfd054d40765" title="DP法による点列の折れ線化">fnFIE_cg_vectorize2d_dp</a>(point_cloud1, dst_edge_num, out_point, NULL, &amp;num_dst, threshold);

        <span class="comment">//出力座標点列の個数ｘDPNT_Tサイズのメモリを確保</span>
        point_cloud2 = <a class="code" href="group__memory__alloc.html#g80e0d9105acd3ea67cd8c5194a19f3d6" title="メモリブロックの割当">fnOAL_malloc</a>(num_dst * (<span class="keyword">sizeof</span>(<a class="code" href="structDPNT__T.html" title="２次元座標指定用構造体(DOUBLE)">DPNT_T</a>)));

        <span class="comment">//座標の値をINTからDOUBLEに変換するため出力座標点列をDPNT_T配列にコピー</span>
        <span class="keywordflow">for</span> (i = 0; i &lt; num_dst; i++) {
            point_cloud2[i].<a class="code" href="structDPNT__T.html#34727f2435dc53ff41a66def5d34e49e">x</a> = (DOUBLE)out_point[i].x;
            point_cloud2[i].<a class="code" href="structDPNT__T.html#e121a1fed9bcab2259dccc2f4002376f">y</a> = (DOUBLE)out_point[i].y;
        }

        <span class="comment">//多角形リージョンを作成</span>
        hreg = <a class="code" href="group__fie__region__create.html#g3095c28e034f240e04c80eb8bd67c6bd" title="多角形リージョンを作成する関数">fnFIE_create_region_polygon</a>(point_cloud2, num_dst);

        <span class="comment">//リージョンに指定座標が含まれているかを判別</span>
        <a class="code" href="group__fie__region__tools.html#gad4fa4b0b7f4d1f881e135e8df6efc55" title="リージョンが指定点を含むかの判定">fnFIE_region_includes_xy</a>(hreg, point.<a class="code" href="structDPNT__T.html#34727f2435dc53ff41a66def5d34e49e">x</a>, point.<a class="code" href="structDPNT__T.html#e121a1fed9bcab2259dccc2f4002376f">y</a>, &amp;result);

        <span class="comment">//メモリの開放</span>
        <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(dst_edges);                  dst_edges = NULL;
        <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(point_cloud1);            point_cloud1 = NULL;
        <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(out_point);                  out_point = NULL;
        <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(point_cloud2);            point_cloud2 = NULL;
        <span class="keywordflow">if</span> (result == 0) { <a class="code" href="group__fie__object.html#g5255bfc98226503d087b8614fcbb240c" title="オブジェクトを解放">fnFIE_free_object</a>(hreg);  hreg = NULL; }<span class="comment">//指定座標がリージョン外の場合</span>
        <span class="keywordflow">else</span> <span class="keywordflow">break</span>;                                                <span class="comment">// 指定座標がリージョン内の場合</span>
    }


    <span class="comment">//メモリの開放</span>
    <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(dst_edges);                 
    <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(point_cloud1);           
    <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(out_point);              
    <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(point_cloud2);           
    <a class="code" href="group__memory__alloc.html#g78ba9c03b7577b9c091ba42ca9cb7c95" title="メモリブロックの解放">fnOAL_free</a>(edges);
    <a class="code" href="group__fie__edge__tools.html#gc2a8c0de49ff2a65a308e04438c6d2c8" title="エッジ点クラスタ配列の解放">fnFIE_free_edge_clust</a>(edge_clust, clust_num);

    <span class="keywordflow">return</span> hreg;
}

INT main() {
    FHANDLE             himg = NULL;               <span class="comment">//入力画像用のハンドル</span>
    FHANDLE             hreg = NULL;               <span class="comment">//リージョン画像用のハンドル</span>
    FHANDLE             hresult = NULL;            <span class="comment">//結果画像用のハンドル</span>
    <a class="code" href="structDPNT__T.html" title="２次元座標指定用構造体(DOUBLE)">DPNT_T</a>              point = { 155.0,253.0 };       <span class="comment">//取得したいリージョンが含む座標</span>
    <a class="code" href="structPNT__T.html" title="２次元整数座標指定用構造体(INT)">PNT_T</a>              offset = { 0,0 };           <span class="comment">//リージョン描画用原点</span>
    INT                 width, height;             <span class="comment">//入力画像サイズ</span>

    <a class="code" href="group__fie__libinit.html#g12250eabf0163ce206c4caa007b33a80" title="FIEライブラリの初期化">fnFIE_setup</a>();

    <span class="comment">//画像読み込み</span>
    <a class="code" href="group__fie__file__image.html#gd328309665f32a8897ef428299a0816a" title="ビットマップ読込">fnFIE_load_bmp</a>(<span class="stringliteral">"gray_05.bmp"</span>, &amp;himg, <a class="code" href="group__fie__file__image.html#gge1ca4e0484c0d907a215a44931bbcc9adb9994a1f48569964f60a6dd2eb91234" title="F_IMG_UC8, 3chで読込">F_COLOR_IMG_TYPE_UC8</a>);

    <span class="comment">//入力画像のサイズ取得</span>
    <a class="code" href="group__fie__image.html#gbd877b77fb0ae99b4eabd32fa33044ae" title="画像情報取得">fnFIE_img_get_params</a>(himg, NULL, NULL, NULL, &amp;width, &amp;height);

    <span class="comment">//出力結果画像のメモリ確保及び白での塗りつぶし</span>
    hresult = <a class="code" href="group__fie__image.html#ge1fb319dbc93c5bbaba49d39904ca491" title="ルート画像の確保">fnFIE_img_root_alloc</a>(<a class="code" href="group__fie__image.html#ggd5e633c5daa48d827c052eb173c0effb8e708cf83f7fd2942b40f45fec46da92" title="２値画像(1bit/1画素)">F_IMG_BIN</a>, 1, width, height);
    <a class="code" href="group__fie__std__operation.html#g16f145c381736241d6a986ab00e7f310" title="画像クリア">fnFIE_img_clear</a>(hresult, 1);

    <span class="comment">//リージョン取得</span>
    hreg = fnSMP_img_to_region(himg, point);

    <span class="comment">//リージョンを黒で書き込み</span>
    <a class="code" href="group__fie__region__coding.html#g29393624aea303cf1a902418206b7b94" title="リージョンを画像に描画する">fnFIE_region_decode</a>(hreg, hresult, offset, 0);

    <span class="comment">//結果を保存</span>
    <a class="code" href="group__fie__file__image.html#g9e2ba61427e7e6597ae83ce4b30f9c7a" title="ビットマップ保存">fnFIE_save_bmp</a>(<span class="stringliteral">"result.bmp"</span>, hresult);

    <span class="comment">//メモリの開放</span>
    <a class="code" href="group__fie__object.html#g5255bfc98226503d087b8614fcbb240c" title="オブジェクトを解放">fnFIE_free_object</a>(himg);
    <a class="code" href="group__fie__object.html#g5255bfc98226503d087b8614fcbb240c" title="オブジェクトを解放">fnFIE_free_object</a>(hreg);
    <a class="code" href="group__fie__object.html#g5255bfc98226503d087b8614fcbb240c" title="オブジェクトを解放">fnFIE_free_object</a>(hresult);

    <a class="code" href="group__fie__libinit.html#gcf71693a1b50ed7ce9947ac8179cbfc3" title="FIEライブラリの終了処理">fnFIE_teardown</a>();


    <span class="keywordflow">return</span> 0;
}


</pre></div> 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
</div>
<hr size="1">
<address style="align: right; color: #cccccc;">
	<small>
	Documentation copyright &copy; 2009-2025 TOKYO ELECTRON DEVICE LIMITED. <br>
	Generated on Tue Sep 16 09:08:55 2025 for FIEライブラリ by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.5.6-FASTSP-p2
	</small>
</address>
</body>
</html>
