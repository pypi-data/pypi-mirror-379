<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Document Library MCP Server - Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        h3 {
            color: #764ba2;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .architecture-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .component {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .component h4 {
            margin-bottom: 5px;
            color: white;
        }

        .component p, .component ul, .component li {
            color: white;
        }

        .component ul {
            padding-left: 20px;
        }

        .component pre, .component code {
            background: rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .file-list ul {
            list-style-type: none;
            padding-left: 20px;
        }

        .file-list li {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .file-list li:last-child {
            border-bottom: none;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            color: white;
            font-size: 2em;
            margin: 0;
        }

        .stat-card p {
            margin-top: 5px;
            opacity: 0.9;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .flow-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px;
            border: 2px solid #667eea;
        }

        .flow-arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 10px;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin: 0 3px;
        }

        .badge-new {
            background: #28a745;
            color: white;
        }

        .badge-count {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🔮 Personal Document Library MCP Server</h1>
            <p>Production-Ready Architecture Documentation</p>
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin-top: 15px;">
                <strong>✅ FULLY OPERATIONAL</strong> - Package structure, 17 tools, 5 prompts, 4 resources, 768-dim embeddings
            </div>
        </header>

        <div class="section">
            <h2>System Overview</h2>
            <p>The Personal Document Library MCP Server is a sophisticated system that enables Claude to access and analyze a personal collection of documents through RAG (Retrieval-Augmented Generation). Now distributed as a Python package with enhanced MCP protocol support including tools, prompts, and resources.</p>

            <div class="stats">
                <div class="stat-card">
                    <h3>17</h3>
                    <p>MCP Tools</p>
                </div>
                <div class="stat-card">
                    <h3>5</h3>
                    <p>Prompt Templates</p>
                </div>
                <div class="stat-card">
                    <h3>4</h3>
                    <p>Dynamic Resources</p>
                </div>
                <div class="stat-card">
                    <h3>100%</h3>
                    <p>Local Processing</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Package Architecture</h2>

            <div class="architecture-diagram">
                <h3>System Flow</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Claude Desktop</strong>
                        <p>MCP Client</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>MCP Server</strong>
                        <p>17 Tools + 5 Prompts + 4 Resources</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>SharedRAG</strong>
                        <p>Search & Synthesis</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>ChromaDB</strong>
                        <p>Vector Storage</p>
                    </div>
                </div>
            </div>

            <div class="component">
                <h4>1. Python Package Structure <span class="badge badge-new">NEW</span></h4>
                <p>✅ Properly structured as `personal_doc_library` package with pyproject.toml configuration</p>
                <ul>
                    <li>CLI commands: pdlib-cli, pdlib-mcp, pdlib-indexer, pdlib-webmonitor</li>
                    <li>Package installation: pip install -e .</li>
                    <li>Module imports: from personal_doc_library.core.shared_rag import SharedRAG</li>
                </ul>
            </div>

            <div class="component">
                <h4>2. MCP Complete Server <span class="badge badge-count">17 Tools</span></h4>
                <p>✅ Full MCP protocol implementation with tools, prompts, and resources</p>
                <p>Location: src/personal_doc_library/servers/mcp_complete_server.py</p>
            </div>

            <div class="component">
                <h4>3. Vector Database (ChromaDB)</h4>
                <p>✅ Stores 768-dimensional embeddings using sentence-transformers/all-mpnet-base-v2</p>
                <p>Telemetry disabled via CHROMA_TELEMETRY=false</p>
            </div>
        </div>

        <div class="section">
            <h2>MCP Protocol Features</h2>

            <h3>🔧 Tools <span class="badge badge-count">17</span></h3>

            <div class="architecture-diagram">
                <h4>Search & Discovery</h4>
                <ul>
                    <li><strong>search</strong> - Semantic search with optional book filtering and synthesis</li>
                    <li><strong>list_books</strong> - List books by pattern, author, or directory</li>
                    <li><strong>recent_books</strong> - Find recently indexed books by time period</li>
                    <li><strong>find_practices</strong> - Find specific practices or techniques</li>
                </ul>
            </div>

            <div class="architecture-diagram">
                <h4>Content Extraction</h4>
                <ul>
                    <li><strong>extract_pages</strong> - Extract specific pages from any book</li>
                    <li><strong>extract_quotes</strong> - Find notable quotes on specific topics</li>
                    <li><strong>summarize_book</strong> - Generate AI summary of entire books</li>
                </ul>
            </div>

            <div class="architecture-diagram">
                <h4>Analysis & Synthesis</h4>
                <ul>
                    <li><strong>compare_perspectives</strong> - Compare perspectives across multiple sources</li>
                    <li><strong>question_answer</strong> - Direct Q&A from your library</li>
                    <li><strong>daily_reading</strong> - Get suggested passages for daily reading</li>
                </ul>
            </div>

            <div class="architecture-diagram">
                <h4>System Management</h4>
                <ul>
                    <li><strong>library_stats</strong> - Get library statistics and indexing status</li>
                    <li><strong>index_status</strong> - Get detailed indexing progress</li>
                    <li><strong>refresh_cache</strong> - Refresh search cache and reload book index</li>
                    <li><strong>warmup</strong> - Initialize RAG system to prevent timeouts</li>
                    <li><strong>find_unindexed</strong> - Find documents not yet indexed <span class="badge badge-new">NEW</span></li>
                    <li><strong>reindex_book</strong> - Force reindex of specific book <span class="badge badge-new">NEW</span></li>
                    <li><strong>clear_failed</strong> - Clear failed document list <span class="badge badge-new">NEW</span></li>
                </ul>
            </div>

            <h3>📝 Prompts <span class="badge badge-count">5</span> <span class="badge badge-new">NEW</span></h3>

            <div class="architecture-diagram">
                <ul>
                    <li><strong>analyze_theme</strong> - Analyze a theme across your library</li>
                    <li><strong>compare_authors</strong> - Compare writing styles and perspectives</li>
                    <li><strong>extract_practices</strong> - Extract practical techniques from books</li>
                    <li><strong>research_topic</strong> - Deep research on a specific topic</li>
                    <li><strong>daily_wisdom</strong> - Get daily wisdom from your library</li>
                </ul>
            </div>

            <h3>📊 Resources <span class="badge badge-count">4</span> <span class="badge badge-new">NEW</span></h3>

            <div class="architecture-diagram">
                <ul>
                    <li><strong>library://stats</strong> - Current library statistics and metrics</li>
                    <li><strong>library://recent</strong> - Recently indexed documents</li>
                    <li><strong>library://search-tips</strong> - Search tips and query examples</li>
                    <li><strong>library://config</strong> - Current configuration settings</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Current File Structure</h2>

            <div class="file-list">
                <h3>Package Structure <span class="badge badge-new">NEW</span></h3>
                <ul>
                    <li><strong>src/personal_doc_library/</strong> - Main package directory
                        <ul>
                            <li><strong>__init__.py</strong> - Package initialization</li>
                            <li><strong>cli.py</strong> - Command-line interface</li>
                            <li><strong>core/</strong> - Core functionality
                                <ul>
                                    <li>config.py - Configuration management</li>
                                    <li>shared_rag.py - RAG implementation</li>
                                    <li>logging_config.py - Logging setup</li>
                                </ul>
                            </li>
                            <li><strong>servers/</strong> - MCP server
                                <ul>
                                    <li>mcp_complete_server.py - Main MCP server</li>
                                </ul>
                            </li>
                            <li><strong>indexing/</strong> - Document indexing
                                <ul>
                                    <li>index_monitor.py - Background monitor</li>
                                    <li>execute_indexing.py - Indexing logic</li>
                                </ul>
                            </li>
                            <li><strong>monitoring/</strong> - Web dashboard
                                <ul>
                                    <li>monitor_web_enhanced.py - Web interface</li>
                                </ul>
                            </li>
                            <li><strong>utils/</strong> - Utility modules</li>
                        </ul>
                    </li>
                    <li><strong>pyproject.toml</strong> - Package configuration</li>
                    <li><strong>requirements.txt</strong> - Dependencies</li>
                </ul>
            </div>

            <div class="file-list">
                <h3>Data Directories</h3>
                <ul>
                    <li><strong>books/</strong> - Document library (configurable via PERSONAL_LIBRARY_DOC_PATH)</li>
                    <li><strong>chroma_db/</strong> - Vector database storage (768-dim embeddings)</li>
                    <li><strong>venv_mcp/</strong> - ✅ Python 3.12 virtual environment (ARM64 compatible)</li>
                    <li><strong>logs/</strong> - Application and service logs</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>🔧 Installation - Package-Based Approach</h2>

            <div class="architecture-diagram">
                <h3>Installation Options</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Development</strong>
                        <p>pip install -e .</p>
                        <p style="font-size: 0.9em;">Editable install</p>
                    </div>
                    <span class="flow-arrow">OR</span>
                    <div class="flow-item">
                        <strong>With Extras</strong>
                        <p>pip install -e ".[services]"</p>
                        <p style="font-size: 0.9em;">All features</p>
                    </div>
                    <span class="flow-arrow">OR</span>
                    <div class="flow-item">
                        <strong>Traditional</strong>
                        <p>./serviceInstall.sh</p>
                        <p style="font-size: 0.9em;">Shell scripts</p>
                    </div>
                </div>
            </div>

            <h3>Package Installation <span class="badge badge-new">RECOMMENDED</span></h3>
            <pre><code># Clone and install as package
git clone https://github.com/hpoliset/PersonalDocLibraryRAGMCP
cd PersonalDocLibraryRAGMCP
pip install -e .

# Or with optional extras
pip install -e ".[document-processing,services]"

# Use CLI commands from anywhere
pdlib-cli --help
pdlib-mcp            # Start MCP server
pdlib-indexer        # Start indexer
pdlib-webmonitor     # Start web dashboard</code></pre>

            <h3>✅ Claude Desktop Configuration</h3>
            <div class="success">
                <p>After installation, update Claude Desktop config:</p>
                <pre><code>{
  "mcpServers": {
    "personal-library": {
      "command": "/path/to/venv_mcp/bin/python",
      "args": ["-m", "personal_doc_library.servers.mcp_complete_server"],
      "env": {
        "PYTHONPATH": "/path/to/DocumentIndexerMCP/src",
        "PYTHONUNBUFFERED": "1",
        "CHROMA_TELEMETRY": "false"
      }
    }
  }
}</code></pre>
            </div>
        </div>

        <div class="section">
            <h2>CLI Commands <span class="badge badge-new">NEW</span></h2>

            <div class="component">
                <h4>Main CLI Tool: pdlib-cli</h4>
                <pre><code>pdlib-cli --help                    # Show all commands
pdlib-cli ensure-dirs                # Create necessary directories
pdlib-cli config                     # View configuration
pdlib-cli check-indexing-status      # Check indexing progress
pdlib-cli find-unindexed            # Find unindexed documents
pdlib-cli manage-failed-pdfs        # Manage failed documents
pdlib-cli show-config               # Display detailed config</code></pre>
            </div>

            <div class="component">
                <h4>Service Launchers</h4>
                <pre><code>pdlib-mcp            # Start MCP server
pdlib-indexer        # Start background indexer
pdlib-webmonitor     # Start web dashboard (localhost:8888)</code></pre>
            </div>
        </div>

        <div class="section">
            <h2>📚 Document Processing Pipeline</h2>

            <div class="architecture-diagram">
                <h3>Processing Workflow</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Document</strong>
                        <p>PDF/DOCX/EPUB/MOBI</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>MD5 Hash</strong>
                        <p>Change Detection</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>Text Extraction</strong>
                        <p>Format-specific</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>Chunking</strong>
                        <p>1200 chars</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>Embedding</strong>
                        <p>768-dim vectors</p>
                    </div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-item">
                        <strong>ChromaDB</strong>
                        <p>Vector Storage</p>
                    </div>
                </div>
            </div>

            <div class="warning">
                <strong>⚠️ Supported Formats:</strong>
                <ul>
                    <li>PDF (.pdf) - Including scanned PDFs with OCR</li>
                    <li>Word (.docx, .doc) - Requires LibreOffice</li>
                    <li>PowerPoint (.pptx, .ppt) - Requires LibreOffice</li>
                    <li>EPUB (.epub) - Requires pandoc</li>
                    <li>MOBI/Kindle (.mobi, .azw, .azw3) - Uses Calibre</li>
                    <li>Text (.txt) - Plain text files</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>🖥️ Web Monitoring Interface</h2>

            <div class="architecture-diagram">
                <h3>Real-Time Dashboard</h3>
                <p>Access at <strong>http://localhost:8888</strong></p>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                    <div class="component">
                        <h4>Live Information</h4>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>📊 Current indexing status</li>
                            <li>📈 Progress with percentage</li>
                            <li>📚 Library statistics</li>
                            <li>🔒 Lock status and health</li>
                            <li>📄 Page extraction progress</li>
                            <li>📦 Chunk generation count</li>
                        </ul>
                    </div>

                    <div class="component">
                        <h4>Interactive Features</h4>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>🔍 Search with Enter key</li>
                            <li>🔄 Auto-refresh (2s)</li>
                            <li>📝 Activity log</li>
                            <li>⚠️ Failed document alerts</li>
                            <li>⏸️ Pause/Resume controls</li>
                            <li>📊 Sortable book table</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Technical Details</h2>

            <div class="success">
                <strong>✅ Current Performance:</strong>
                <ul>
                    <li>Startup time: < 1 second (lazy initialization)</li>
                    <li>Search latency: ~1.75s per query (768-dim embeddings)</li>
                    <li>Memory usage: ~4GB for embedding model</li>
                    <li>Package-based distribution with pyproject.toml</li>
                    <li>Full MCP protocol support (tools, prompts, resources)</li>
                </ul>
            </div>

            <div class="component">
                <h4>Embedding Model</h4>
                <p><strong>Model:</strong> sentence-transformers/all-mpnet-base-v2</p>
                <p><strong>Dimensions:</strong> 768</p>
                <p><strong>Chunk Size:</strong> 1200 characters</p>
                <p><strong>Overlap:</strong> 150 characters</p>
            </div>

            <div class="warning">
                <strong>⚠️ Environment Variables:</strong>
                <ul>
                    <li>PERSONAL_LIBRARY_DOC_PATH - Document directory</li>
                    <li>PERSONAL_LIBRARY_DB_PATH - Database directory</li>
                    <li>PERSONAL_LIBRARY_LOGS_PATH - Logs directory</li>
                    <li>CHROMA_TELEMETRY=false - Disable telemetry</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>🔒 Security & Privacy</h2>

            <div class="success">
                <h4>✅ Privacy Features</h4>
                <ul>
                    <li>100% local processing - no external API calls</li>
                    <li>No telemetry (CHROMA_TELEMETRY=false)</li>
                    <li>User permissions only</li>
                    <li>Sandboxed MCP process</li>
                    <li>File-based locking with 30-minute timeout</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>🔧 Detailed Tool Implementation Flows</h2>

            <h3>Search & Discovery Tools</h3>

            <div class="architecture-diagram">
                <h4>1. search Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Query Input  │────▶│ Embedding Gen   │────▶│ Vector Search│
│              │     │ (768-dim)       │     │ (ChromaDB)   │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Format Output│◀────│ Apply Filters   │◀────│ Rank Results │
│              │     │ (book/category) │     │ (similarity) │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Lazy RAG initialization, HuggingFace embedding generation, cosine similarity search, optional synthesis</p>
            </div>

            <div class="architecture-diagram">
                <h4>2. list_books Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Pattern/     │────▶│ Load Book Index │────▶│ Apply Filter │
│ Author/Dir   │     │ (JSON file)     │     │ (fnmatch)    │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
                                              ┌──────────────┐
                                              │ Enrich with  │
                                              │ Metadata     │
                                              └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> JSON index reading, pattern matching, metadata enrichment (chunks, pages, indexed_at)</p>
            </div>

            <div class="architecture-diagram">
                <h4>3. recent_books Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Time Period  │────▶│ Calculate       │────▶│ Filter Books │
│ (hours/days) │     │ Cutoff Time     │     │ by Timestamp │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
                                              ┌──────────────┐
                                              │ Format with  │
                                              │ Relative Time│
                                              └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Datetime parsing, relative time calculation, chronological sorting</p>
            </div>

            <div class="architecture-diagram">
                <h4>4. find_practices Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Practice     │────▶│ Build Semantic  │────▶│ Category     │
│ Type         │     │ Query           │     │ Filter       │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Group by     │◀────│ Deduplicate     │◀────│ Extract      │
│ Type         │     │ Similar         │     │ Practices    │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Practice-focused queries, category filtering, similarity deduplication</p>
            </div>

            <h3>Content Extraction Tools</h3>

            <div class="architecture-diagram">
                <h4>5. extract_pages Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Book Pattern │────▶│ Find Book       │────▶│ Parse Page   │
│ + Pages      │     │ in Index        │     │ Specification│
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Return Text  │◀────│ Extract Text    │◀────│ Load PDF     │
│              │     │ per Page        │     │ (PyPDF2)     │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Book resolution, page range parsing, PDF text extraction</p>
            </div>

            <div class="architecture-diagram">
                <h4>6. extract_quotes Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Topic        │────▶│ Search for      │────▶│ Detect Quote │
│              │     │ Quotes          │     │ Patterns     │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Format with  │◀────│ Select Top      │◀────│ Score by     │
│ Attribution  │     │ Quotes          │     │ Relevance    │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Quote pattern regex, relevance scoring, attribution preservation</p>
            </div>

            <div class="architecture-diagram">
                <h4>7. summarize_book Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Book Name    │────▶│ Find Book       │────▶│ Get All      │
│ + Length     │     │ in Index        │     │ Chunks       │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Build        │◀────│ Extract Themes  │◀────│ Sample/Use   │
│ Summary      │     │ (TF-IDF)        │     │ All Chunks   │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Chunk retrieval by metadata, theme extraction, structured summarization</p>
            </div>

            <h3>Analysis & Synthesis Tools</h3>

            <div class="architecture-diagram">
                <h4>8. compare_perspectives Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Topic        │────▶│ Search All      │────▶│ Group by     │
│              │     │ Sources         │     │ Source Book  │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Format as    │◀────│ Build           │◀────│ Extract      │
│ Comparison   │     │ Comparison      │     │ Viewpoints   │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Multi-source search, viewpoint extraction, comparison matrix generation</p>
            </div>

            <div class="architecture-diagram">
                <h4>9. question_answer Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Question     │────▶│ Analyze Q Type  │────▶│ Optimize     │
│ + Detail     │     │ (fact/concept)  │     │ Query        │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Add Citations│◀────│ Synthesize      │◀────│ Rank & Select│
│              │     │ Answer          │     │ Chunks       │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Question classification, relevance ranking, citation formatting</p>
            </div>

            <div class="architecture-diagram">
                <h4>10. daily_reading Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Theme +      │────▶│ Check Reading   │────▶│ Filter Recent│
│ Length       │     │ History         │     │ Selections   │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Log Selection│◀────│ Add Reflection  │◀────│ Select       │
│              │     │ Prompts         │     │ Passages     │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> History tracking, weighted selection, reflection prompt generation</p>
            </div>

            <h3>System Management Tools</h3>

            <div class="architecture-diagram">
                <h4>11. library_stats Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Stats Request│────▶│ Initialize RAG  │────▶│ Count Books  │
│              │     │ (if needed)     │     │ in Index     │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Format Stats │◀────│ Calculate       │◀────│ Query DB     │
│              │     │ Metrics         │     │ Counts       │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Multi-source aggregation, storage calculation, comprehensive metrics</p>
            </div>

            <div class="architecture-diagram">
                <h4>12. index_status Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Status Req   │────▶│ Read Status     │────▶│ Check Lock   │
│              │     │ Files           │     │ File         │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Return Status│◀────│ Format Progress │◀────│ Check PID    │
│              │     │ Info            │     │ Active       │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Status file reading, process verification, progress calculation</p>
            </div>

            <div class="architecture-diagram">
                <h4>13. refresh_cache Tool - Internal Flow</h4>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px;">
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Refresh Req  │────▶│ Clear Memory    │────▶│ Reload Index │
│              │     │ Caches          │     │ Files        │
└──────────────┘     └─────────────────┘     └──────────────┘
                                                     │
                                                     ▼
┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│ Return Status│◀────│ Get Updated     │◀────│ Reconnect DB │
│              │     │ Counts          │     │              │
└──────────────┘     └─────────────────┘     └──────────────┘
                </pre>
                <p><strong>Key Operations:</strong> Singleton clearing, forced reload, connectivity verification</p>
            </div>

            <div class="architecture-diagram">
                <h4>14-17. Additional Management Tools</h4>
                <ul style="list-style: none; padding: 10px;">
                    <li><strong>14. warmup:</strong> Pre-loads embedding model (~4GB), runs test query, prevents timeout</li>
                    <li><strong>15. find_unindexed:</strong> Directory scan, hash comparison, categorization (new/modified/failed)</li>
                    <li><strong>16. reindex_book:</strong> Full cleanup, chunk deletion, re-processing pipeline</li>
                    <li><strong>17. clear_failed:</strong> Backup creation, list reset, retry enablement</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Troubleshooting</h2>

            <h3>Package Installation Issues</h3>
            <pre><code># Ensure editable install
pip install -e .

# Set PYTHONPATH if needed
export PYTHONPATH="/path/to/DocumentIndexerMCP/src:${PYTHONPATH:-}"</code></pre>

            <h3>Common Issues</h3>
            <ul>
                <li><strong>Import errors:</strong> Ensure package is installed with pip install -e .</li>
                <li><strong>Telemetry errors:</strong> Set CHROMA_TELEMETRY=false</li>
                <li><strong>MCP not responding:</strong> Check capability advertisement in initialize</li>
                <li><strong>Resources not visible:</strong> Claude Desktop UI limitation (use other MCP clients)</li>
            </ul>

            <h3>Logs Location</h3>
            <ul>
                <li><code>logs/mcp_server_stdout.log</code> - Server output</li>
                <li><code>logs/mcp_server_stderr.log</code> - Error logs</li>
                <li><code>logs/index_monitor_stdout.log</code> - Indexer output</li>
                <li><code>logs/webmonitor_stdout.log</code> - Web dashboard logs</li>
            </ul>
        </div>
    </div>
</body>
</html>