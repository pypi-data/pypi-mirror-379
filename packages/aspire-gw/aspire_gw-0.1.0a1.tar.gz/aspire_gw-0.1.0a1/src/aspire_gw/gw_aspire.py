from typing import TYPE_CHECKING

from aspire import Aspire

if TYPE_CHECKING:
    import bilby


class GWAspire(Aspire):
    """A Aspire class for gravitational-wave inference.

    This class extends the `Aspire` class to facilitate gravitational-wave
    inference tasks. It includes methods to initialize from a Bilby Pipe
    INI file and to fit using samples from a Bilby result.

    """

    @classmethod
    def from_bilby_pipe_ini(
        cls,
        *,
        ini_file,
        data_dump_file,
        suppress_bilby_logger: bool = True,
        **kwargs,
    ):
        """Generate a `GWAspire` instance from a Bilby Pipe INI file.

        Parameters
        ----------
        ini_file : str
            Path to the Bilby Pipe INI file.
        data_dump_file : str
            Path to the data dump file generated by Bilby Pipe.
        suppress_bilby_logger : bool, optional
            Whether to suppress the Bilby logger output. Default is True.
        **kwargs
            Additional keyword arguments to pass to the `GWAspire` constructor.
        """
        from aspire_bilby.utils import get_inputs_from_bilby_pipe_ini

        inputs = get_inputs_from_bilby_pipe_ini(
            ini_file,
            data_dump_file,
            suppress_bilby_logger=suppress_bilby_logger,
        )
        return cls(
            log_likelihood=inputs.log_likelihood,
            log_prior=inputs.log_prior,
            dims=inputs.dims,
            parameters=inputs.parameters,
            prior_bounds=inputs.prior_bounds,
            periodic_parameters=inputs.periodic_parameters,
            **kwargs,
        )

    def fit_from_bilby_result(
        self,
        result: "bilby.core.result.Result" = None,
        result_file: str = None,
        **kwargs,
    ):
        """Fit the flow using samples from a Bilby result.

        Parameters
        ----------
        result : bilby.core.result.Result, optional
            A Bilby result object containing the samples. If not provided,
            `result_file` must be specified to load the result from a file.
        result_file : str, optional
            Path to the Bilby result file. Required if `result` is not provided.
        **kwargs
            Additional keyword arguments to pass to the `fit` method.
        """
        from aspire_bilby.utils import samples_from_bilby_result
        from bilby.core.result import read_in_result

        if result is None:
            result = read_in_result(result_file)
        samples = samples_from_bilby_result(result, self.parameters)
        return self.fit(samples, **kwargs)
