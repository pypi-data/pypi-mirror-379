import{ce as U,l as ve,jX as M,hs as pe,j3 as te,tX as Ie,cq as y,kk as D,cB as g,k4 as Ge,D as k,tY as Te,ka as T,E as C,km as p,g as $,hz as ie,cT as Q,bi as G,i9 as _e,tZ as x,j$ as J,aw as F,ax as be,at as X,kB as Z,ct as A,i as W,j as u,bm as Me,mj as re,hu as we,jU as P,jV as m,i8 as N,t_ as Ue,z as ke,kj as We,bh as xe,eM as Fe,er as L,mg as V,t$ as Pe,oB as Ne,tU as Le,jT as B,j_ as Y,cs as H,u0 as q,U as f,ek as ge,k5 as Se,jZ as Ce,cv as Ve,b1 as se,u1 as oe,u2 as v,cH as Be,Z as ye,bo as Ae,cj as Ye,ic as ee,kF as Oe,tW as He,dM as De,p5 as qe,cE as je,jY as j,jS as Ke,jf as ne,ot as ae,k8 as ze,ox as de,p6 as $e,u3 as S,u4 as E,tn as ce,t as Qe,p1 as Je,bN as Xe,im as Ze,W as et,oD as tt,a0 as it,a1 as rt,tz as st,tp as ue}from"./main-BY5dYOjU.js";function he(h,e,t){const i=h.get(U),r=h.get(ve),s=ot(e,t,i,r);return s instanceof Promise?s.then(o=>le(o,e,t,i)):le(s,e,t,i)}function le(h,e,t,i){let r;return i.activeGroup!==h&&e.options&&!e.options.inactive&&e.options.preserveFocus&&typeof e.options.activation!="number"&&t!==pe&&(r=Ge.ACTIVATE),[h,r]}function ot(h,e,t,i){let r;const s=M(h)?h.editor:h,o=h.options;if(e&&typeof e!="number")r=e;else if(typeof e=="number"&&e>=0)r=t.getGroup(e);else if(e===pe){const n=te(i);let a=t.findGroup({direction:n});(!a||b(a,s))&&(a=t.addGroup(t.activeGroup,n)),r=a}else if(e===Ie)r=t.createAuxiliaryEditorPart().then(n=>n.activeGroup);else if(!o||typeof o.index!="number"){const n=t.getGroups(y.MOST_RECENTLY_ACTIVE);if(o!=null&&o.revealIfVisible){for(const a of n)if(nt(a,s)){r=a;break}}if(!r&&(o!=null&&o.revealIfOpened||i.getValue("workbench.editor.revealIfOpen")||D(s)&&s.hasCapability(g.Singleton))){let a,d;for(const c of n)if(Re(c,s)&&(d||(d=c),!a&&c.isActive(s)&&(a=c)),d&&a)break;r=a||d}}if(!r){let n=t.activeGroup;if(b(n,s)){for(const a of t.getGroups(y.MOST_RECENTLY_ACTIVE))if(!b(a,s)){n=a;break}b(n,s)?r=t.addGroup(n,te(i)):r=n}else r=n}return r}function b(h,e){return!(!h.isLocked||Re(h,e))}function nt(h,e){return h.activeEditor?h.activeEditor.matches(e):!1}function Re(h,e){for(const t of h.editors)if(t.matches(e))return!0;return!1}var I,O;let K=(O=class extends k{get count(){return this.mostRecentEditorsMap.size}get editors(){return[...this.mostRecentEditorsMap.values()]}hasEditor(e){const t=this.editorsPerResourceCounter.get(e.resource);return(t==null?void 0:t.has(this.toIdentifier(e)))??!1}hasEditors(e){return this.editorsPerResourceCounter.has(e)}toIdentifier(e,t){return typeof e!="string"?this.toIdentifier(e.typeId,e.editorId):t?`${e}/${t}`:e}constructor(e,t,i){super(),this.editorGroupService=t,this.storageService=i,this.keyMap=new Map,this.mostRecentEditorsMap=new Te,this.editorsPerResourceCounter=new T,this._onDidMostRecentlyActiveEditorsChange=this._register(new C),this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event,this.editorGroupsContainer=e??t,this.isScoped=!!e,this.registerListeners(),this.loadState()}registerListeners(){this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.onGroupAdded(e))),this._register(this.editorGroupService.onDidChangeEditorPartOptions(e=>this.onDidChangeEditorPartOptions(e))),this._register(this.storageService.onWillSaveState(()=>this.saveState()))}onGroupAdded(e){const t=e.getEditors(p.MOST_RECENTLY_ACTIVE);for(let i=t.length-1;i>=0;i--)this.addMostRecentEditor(e,t[i],!1,!0);this.editorGroupsContainer.activeGroup===e&&e.activeEditor&&this.addMostRecentEditor(e,e.activeEditor,!0,!1),this.registerGroupListeners(e)}registerGroupListeners(e){const t=new $;t.add(e.onDidModelChange(i=>{switch(i.kind){case ie.GROUP_ACTIVE:{this.editorGroupsContainer.activeGroup===e&&e.activeEditor&&this.addMostRecentEditor(e,e.activeEditor,!0,!1);break}case ie.EDITOR_OPEN:{i.editor&&(this.addMostRecentEditor(e,i.editor,!1,!0),this.ensureOpenedEditorsLimit({groupId:e.id,editor:i.editor},e.id));break}}})),t.add(e.onDidCloseEditor(i=>{this.removeMostRecentEditor(e,i.editor)})),t.add(e.onDidActiveEditorChange(i=>{i.editor&&this.addMostRecentEditor(e,i.editor,this.editorGroupsContainer.activeGroup===e,!1)})),Q.once(e.onWillDispose)(()=>G(t))}onDidChangeEditorPartOptions(e){if(!_e(e.newPartOptions.limit,e.oldPartOptions.limit)){const t=this.editorGroupsContainer.activeGroup;let i;t.activeEditor&&(i={editor:t.activeEditor,groupId:t.id}),this.ensureOpenedEditorsLimit(i)}}addMostRecentEditor(e,t,i,r){const s=this.ensureKey(e,t),o=this.mostRecentEditorsMap.first;i||!o?this.mostRecentEditorsMap.set(s,s,o?x.AsOld:void 0):(this.mostRecentEditorsMap.set(s,s,x.AsOld),this.mostRecentEditorsMap.set(o,o,x.AsOld)),r&&this.updateEditorResourcesMap(t,!0),this._onDidMostRecentlyActiveEditorsChange.fire()}updateEditorResourcesMap(e,t){let i,r,s;if(e instanceof J?(i=e.primary.resource,r=e.primary.typeId,s=e.primary.editorId):(i=e.resource,r=e.typeId,s=e.editorId),!i)return;const o=this.toIdentifier(r,s);if(t){let n=this.editorsPerResourceCounter.get(i);n||(n=new Map,this.editorsPerResourceCounter.set(i,n)),n.set(o,(n.get(o)??0)+1)}else{const n=this.editorsPerResourceCounter.get(i);if(n){const a=n.get(o)??0;a>1?n.set(o,a-1):(n.delete(o),n.size===0&&this.editorsPerResourceCounter.delete(i))}}}removeMostRecentEditor(e,t){this.updateEditorResourcesMap(t,!1);const i=this.findKey(e,t);if(i){this.mostRecentEditorsMap.delete(i);const r=this.keyMap.get(e.id);r&&r.delete(i.editor)&&r.size===0&&this.keyMap.delete(e.id),this._onDidMostRecentlyActiveEditorsChange.fire()}}findKey(e,t){const i=this.keyMap.get(e.id);if(i)return i.get(t)}ensureKey(e,t){let i=this.keyMap.get(e.id);i||(i=new Map,this.keyMap.set(e.id,i));let r=i.get(t);return r||(r={groupId:e.id,editor:t},i.set(t,r)),r}async ensureOpenedEditorsLimit(e,t){var r,s;if(!((r=this.editorGroupService.partOptions.limit)!=null&&r.enabled)||typeof this.editorGroupService.partOptions.limit.value!="number"||this.editorGroupService.partOptions.limit.value<=0)return;const i=this.editorGroupService.partOptions.limit.value;if((s=this.editorGroupService.partOptions.limit)!=null&&s.perEditorGroup)if(typeof t=="number"){const o=this.editorGroupsContainer.getGroup(t);o&&await this.doEnsureOpenedEditorsLimit(i,o.getEditors(p.MOST_RECENTLY_ACTIVE).map(n=>({editor:n,groupId:t})),e)}else for(const o of this.editorGroupsContainer.groups)await this.ensureOpenedEditorsLimit(e,o.id);else await this.doEnsureOpenedEditorsLimit(i,[...this.mostRecentEditorsMap.values()],e)}async doEnsureOpenedEditorsLimit(e,t,i){var a;let r;if((a=this.editorGroupService.partOptions.limit)!=null&&a.excludeDirty?r=t.filter(({editor:d})=>!(d.isDirty()&&!d.isSaving()||d.hasCapability(g.Scratchpad))):r=t,e>=r.length)return;const s=r.reverse().filter(({editor:d,groupId:c})=>{var l;return!(d.isDirty()&&!d.isSaving()||d.hasCapability(g.Scratchpad)||i&&d===i.editor&&c===i.groupId||(l=this.editorGroupsContainer.getGroup(c))!=null&&l.isSticky(d))});let o=r.length-e;const n=new Map;for(const{groupId:d,editor:c}of s){let l=n.get(d);if(l||(l=[],n.set(d,l)),l.push(c),o--,o===0)break}for(const[d,c]of n){const l=this.editorGroupsContainer.getGroup(d);l&&await l.closeEditors(c,{preserveFocus:!0})}}saveState(){this.isScoped||(this.mostRecentEditorsMap.isEmpty()?this.storageService.remove(I.STORAGE_KEY,F.WORKSPACE):this.storageService.store(I.STORAGE_KEY,JSON.stringify(this.serialize()),F.WORKSPACE,be.MACHINE))}serialize(){const e=X.as(Z.EditorFactory),t=[...this.mostRecentEditorsMap.values()],i=new Map;return{entries:A(t.map(({editor:r,groupId:s})=>{const o=this.editorGroupsContainer.getGroup(s);if(!o)return;let n=i.get(o);n||(n=o.getEditors(p.SEQUENTIAL).filter(d=>{const c=e.getEditorSerializer(d);return c==null?void 0:c.canSerialize(d)}),i.set(o,n));const a=n.indexOf(r);if(a!==-1)return{groupId:s,index:a}}))}}async loadState(){(this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService)&&await this.editorGroupService.whenReady;let e=!1;if(!this.isScoped){const t=this.storageService.get(I.STORAGE_KEY,F.WORKSPACE);t&&(e=!0,this.deserialize(JSON.parse(t)))}if(!e){const t=this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE);for(let i=t.length-1;i>=0;i--){const r=t[i],s=r.getEditors(p.MOST_RECENTLY_ACTIVE);for(let o=s.length-1;o>=0;o--)this.addMostRecentEditor(r,s[o],!0,!0)}}for(const t of this.editorGroupsContainer.groups)this.registerGroupListeners(t)}deserialize(e){const t=[];for(const{groupId:i,index:r}of e.entries){const s=this.editorGroupsContainer.getGroup(i);if(!s)continue;const o=s.getEditorByIndex(r);if(!o)continue;const n=this.ensureKey(s,o);t.push([n,n]),this.updateEditorResourcesMap(o,!0)}this.mostRecentEditorsMap.fromJSON(t)}},I=O,O.STORAGE_KEY="editors.mru",O);K=I=W([u(1,U),u(2,Me)],K);var z;let fe=z=class extends k{constructor(e,t,i,r,s,o,n,a,d,c,l){super(),this.editorGroupService=t,this.instantiationService=i,this.fileService=r,this.configurationService=s,this.contextService=o,this.uriIdentityService=n,this.editorResolverService=a,this.workspaceTrustRequestService=d,this.hostService=c,this.textEditorService=l,this._onDidActiveEditorChange=this._register(new C),this.onDidActiveEditorChange=this._onDidActiveEditorChange.event,this._onDidVisibleEditorsChange=this._register(new C),this.onDidVisibleEditorsChange=this._onDidVisibleEditorsChange.event,this._onDidEditorsChange=this._register(new C),this.onDidEditorsChange=this._onDidEditorsChange.event,this._onWillOpenEditor=this._register(new C),this.onWillOpenEditor=this._onWillOpenEditor.event,this._onDidCloseEditor=this._register(new C),this.onDidCloseEditor=this._onDidCloseEditor.event,this._onDidOpenEditorFail=this._register(new C),this.onDidOpenEditorFail=this._onDidOpenEditorFail.event,this._onDidMostRecentlyActiveEditorsChange=this._register(new C),this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event,this.lastActiveEditor=void 0,this.activeOutOfWorkspaceWatchers=new T,this.closeOnFileDelete=!1,this.editorGroupsContainer=e??t,this.editorsObserver=this._register(this.instantiationService.createInstance(K,this.editorGroupsContainer)),this.onConfigurationUpdated(),this.registerListeners()}createScoped(e,t){return t.add(new z(e==="main"?this.editorGroupService.mainPart:e,this.editorGroupService,this.instantiationService,this.fileService,this.configurationService,this.contextService,this.uriIdentityService,this.editorResolverService,this.workspaceTrustRequestService,this.hostService,this.textEditorService))}registerListeners(){this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService?this.editorGroupService.whenReady.then(()=>this.onEditorGroupsReady()):this.onEditorGroupsReady(),this._register(this.editorGroupsContainer.onDidChangeActiveGroup(e=>this.handleActiveEditorChange(e))),this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.registerGroupListeners(e))),this._register(this.editorsObserver.onDidMostRecentlyActiveEditorsChange(()=>this._onDidMostRecentlyActiveEditorsChange.fire())),this._register(this.onDidVisibleEditorsChange(()=>this.handleVisibleEditorsChange())),this._register(this.fileService.onDidRunOperation(e=>this.onDidRunFileOperation(e))),this._register(this.fileService.onDidFilesChange(e=>this.onDidFilesChange(e))),this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e)))}onEditorGroupsReady(){for(const e of this.editorGroupsContainer.groups)this.registerGroupListeners(e);this.activeEditor&&(this.doHandleActiveEditorChangeEvent(),this._onDidVisibleEditorsChange.fire())}handleActiveEditorChange(e){e===this.editorGroupsContainer.activeGroup&&(!this.lastActiveEditor&&!e.activeEditor||this.doHandleActiveEditorChangeEvent())}doHandleActiveEditorChangeEvent(){const e=this.editorGroupsContainer.activeGroup;this.lastActiveEditor=e.activeEditor??void 0,this._onDidActiveEditorChange.fire()}registerGroupListeners(e){const t=new $;t.add(e.onDidModelChange(i=>{this._onDidEditorsChange.fire({groupId:e.id,event:i})})),t.add(e.onDidActiveEditorChange(()=>{this.handleActiveEditorChange(e),this._onDidVisibleEditorsChange.fire()})),t.add(e.onWillOpenEditor(i=>{this._onWillOpenEditor.fire(i)})),t.add(e.onDidCloseEditor(i=>{this._onDidCloseEditor.fire(i)})),t.add(e.onDidOpenEditorFail(i=>{this._onDidOpenEditorFail.fire({editor:i,groupId:e.id})})),Q.once(e.onWillDispose)(()=>{G(t)})}handleVisibleEditorsChange(){const e=new re;for(const t of this.visibleEditors){const i=we(A([P.getCanonicalUri(t,{supportSideBySide:m.PRIMARY}),P.getCanonicalUri(t,{supportSideBySide:m.SECONDARY})]),r=>r.toString());for(const r of i)this.fileService.hasProvider(r)&&!this.contextService.isInsideWorkspace(r)&&e.add(r)}for(const t of this.activeOutOfWorkspaceWatchers.keys())e.has(t)||(G(this.activeOutOfWorkspaceWatchers.get(t)),this.activeOutOfWorkspaceWatchers.delete(t));for(const t of e.keys())if(!this.activeOutOfWorkspaceWatchers.get(t)){const i=this.fileService.watch(t);this.activeOutOfWorkspaceWatchers.set(t,i)}}async onDidRunFileOperation(e){e.isOperation(N.MOVE)&&this.handleMovedFile(e.resource,e.target.resource),(e.isOperation(N.DELETE)||e.isOperation(N.MOVE))&&this.handleDeletedFile(e.resource,!1,e.target?e.target.resource:void 0)}onDidFilesChange(e){e.gotDeleted()&&this.handleDeletedFile(e,!0)}async handleMovedFile(e,t){for(const i of this.editorGroupsContainer.groups){const r=[];for(const s of i.editors){const o=s.resource;if(!o||!this.uriIdentityService.extUri.isEqualOrParent(o,e))continue;let n;if(this.uriIdentityService.extUri.isEqual(e,o))n=t;else{const c=Ue(o.path,e.path,this.uriIdentityService.extUri.ignorePathCasing(o));n=ke(t,o.path.substr(c+e.path.length+1))}const a=await s.rename(i.id,n);if(!a)return;const d={preserveFocus:!0,pinned:i.isPinned(s),sticky:i.isSticky(s),index:i.getIndexOfEditor(s),inactive:!i.isActive(s)};D(a.editor)?r.push({editor:s,replacement:a.editor,options:{...a.options,...d}}):r.push({editor:s,replacement:{...a.editor,options:{...a.editor.options,...d}}})}r.length&&this.replaceEditors(r,i)}}onConfigurationUpdated(e){var i,r;if(e&&!e.affectsConfiguration("workbench.editor.closeOnFileDelete"))return;const t=this.configurationService.getValue();typeof((r=(i=t.workbench)==null?void 0:i.editor)==null?void 0:r.closeOnFileDelete)=="boolean"?this.closeOnFileDelete=t.workbench.editor.closeOnFileDelete:this.closeOnFileDelete=!1}handleDeletedFile(e,t,i){for(const r of this.getAllNonDirtyEditors({includeUntitled:!1,supportSideBySide:!0}))(async()=>{const s=r.resource;if(s&&(this.closeOnFileDelete||!t)){if(i&&this.uriIdentityService.extUri.isEqualOrParent(s,i))return;let o=!1;if(e instanceof We?o=e.contains(s,xe.DELETED):o=this.uriIdentityService.extUri.isEqualOrParent(s,e),!o)return;let n=!1;t&&this.fileService.hasProvider(s)&&(await Fe(100),n=await this.fileService.exists(s)),!n&&!r.isDisposed()&&r.dispose()}})()}getAllNonDirtyEditors(e){const t=[];function i(r){r.hasCapability(g.Untitled)&&!e.includeUntitled||r.isDirty()||t.push(r)}for(const r of this.editors)e.supportSideBySide&&r instanceof J?(i(r.primary),i(r.secondary)):i(r);return t}get activeEditorPane(){var e;return(e=this.editorGroupsContainer.activeGroup)==null?void 0:e.activeEditorPane}get activeTextEditorControl(){const e=this.activeEditorPane;if(e){const t=e.getControl();if(L(t)||V(t))return t;if(Pe(t)&&L(t.activeCodeEditor))return t.activeCodeEditor}}get activeTextEditorLanguageId(){var i;let e;const t=this.activeTextEditorControl;return V(t)?e=t.getModifiedEditor():e=t,(i=e==null?void 0:e.getModel())==null?void 0:i.getLanguageId()}get count(){return this.editorsObserver.count}get editors(){return this.getEditors(p.SEQUENTIAL).map(({editor:e})=>e)}getEditors(e,t){switch(e){case p.MOST_RECENTLY_ACTIVE:return t!=null&&t.excludeSticky?this.editorsObserver.editors.filter(({groupId:i,editor:r})=>{var s;return!((s=this.editorGroupsContainer.getGroup(i))!=null&&s.isSticky(r))}):this.editorsObserver.editors;case p.SEQUENTIAL:{const i=[];for(const r of this.editorGroupsContainer.getGroups(y.GRID_APPEARANCE))i.push(...r.getEditors(p.SEQUENTIAL,t).map(s=>({editor:s,groupId:r.id})));return i}}}get activeEditor(){const e=this.editorGroupsContainer.activeGroup;return e?e.activeEditor??void 0:void 0}get visibleEditorPanes(){return A(this.editorGroupsContainer.groups.map(e=>e.activeEditorPane))}get visibleTextEditorControls(){return this.doGetVisibleTextEditorControls(this.visibleEditorPanes)}doGetVisibleTextEditorControls(e){var i,r;const t=[];for(const s of e){const o=[];s instanceof Ne?(o.push((i=s.getPrimaryEditorPane())==null?void 0:i.getControl()),o.push((r=s.getSecondaryEditorPane())==null?void 0:r.getControl())):o.push(s.getControl());for(const n of o)(L(n)||V(n))&&t.push(n)}return t}getVisibleTextEditorControls(e){return this.doGetVisibleTextEditorControls(A(this.editorGroupsContainer.getGroups(e===p.SEQUENTIAL?y.GRID_APPEARANCE:y.MOST_RECENTLY_ACTIVE).map(t=>t.activeEditorPane)))}get visibleEditors(){return A(this.editorGroupsContainer.groups.map(e=>e.activeEditor))}async openEditor(e,t,i){let r,s=D(e)?t:e.options,o;if(Le(t)&&(i=t),!D(e)){const n=await this.editorResolverService.resolveEditor(e,i);if(n===B.ABORT)return;Y(n)&&(r=n.editor,s=n.options,o=n.group)}if(r||(r=D(e)?e:await this.textEditorService.resolveTextEditor(e)),!o){let n;const a=this.instantiationService.invokeFunction(he,{editor:r,options:s},i);a instanceof Promise?[o,n]=await a:[o,n]=a,n&&(s={...s,activation:n})}return o.openEditor(r,s)}async openEditors(e,t,i){if(i!=null&&i.validateTrust&&!await this.handleWorkspaceTrust(e))return[];const r=new Map;for(const o of e){let n,a;if(!M(o)){const c=await this.editorResolverService.resolveEditor(o,t);if(c===B.ABORT)continue;Y(c)&&(n=c,a=c.group)}if(n||(n=M(o)?o:{editor:await this.textEditorService.resolveTextEditor(o),options:o.options}),!a){const c=this.instantiationService.invokeFunction(he,n,t);c instanceof Promise?[a]=await c:[a]=c}let d=r.get(a);d||(d=[],r.set(a,d)),d.push(n)}const s=[];for(const[o,n]of r)s.push(o.openEditors(n));return A(await H.settled(s))}async handleWorkspaceTrust(e){const{resources:t,diffMode:i,mergeMode:r}=this.extractEditorResources(e);switch(await this.workspaceTrustRequestService.requestOpenFilesTrust(t)){case q.Open:return!0;case q.OpenInNewWindow:return await this.hostService.openWindow(t.map(o=>({fileUri:o})),{forceNewWindow:!0,diffMode:i,mergeMode:r}),!1;case q.Cancel:return!1}}extractEditorResources(e){const t=new re;let i=!1,r=!1;for(const s of e)if(M(s)){const o=P.getOriginalUri(s.editor,{supportSideBySide:m.BOTH});f.isUri(o)?t.add(o):o&&(o.primary&&t.add(o.primary),o.secondary&&t.add(o.secondary),i=s.editor instanceof ge)}else Se(s)&&(f.isUri(s.input1)&&t.add(s.input1.resource),f.isUri(s.input2)&&t.add(s.input2.resource),f.isUri(s.base)&&t.add(s.base.resource),f.isUri(s.result)&&t.add(s.result.resource),r=!0),Ce(s)?(f.isUri(s.original.resource)&&t.add(s.original.resource),f.isUri(s.modified.resource)&&t.add(s.modified.resource),i=!0):Ve(s)&&t.add(s.resource);return{resources:Array.from(t.keys()),diffMode:i,mergeMode:r}}isOpened(e){return this.editorsObserver.hasEditor({resource:this.uriIdentityService.asCanonicalUri(e.resource),typeId:e.typeId,editorId:e.editorId})}isVisible(e){var t;for(const i of this.editorGroupsContainer.groups)if((t=i.activeEditor)!=null&&t.matches(e))return!0;return!1}async closeEditor({editor:e,groupId:t},i){const r=this.editorGroupsContainer.getGroup(t);await(r==null?void 0:r.closeEditor(e,i))}async closeEditors(e,t){const i=new Map;for(const{editor:r,groupId:s}of e){const o=this.editorGroupsContainer.getGroup(s);if(!o)continue;let n=i.get(o);n||(n=[],i.set(o,n)),n.push(r)}for(const[r,s]of i)await r.closeEditors(s,t)}findEditors(e,t,i){const r=f.isUri(e)?e:e.resource,s=f.isUri(e)?void 0:e.typeId;if((t==null?void 0:t.supportSideBySide)!==m.ANY&&(t==null?void 0:t.supportSideBySide)!==m.SECONDARY&&!this.editorsObserver.hasEditors(r))return f.isUri(e)||se(i)?[]:void 0;if(se(i)){const o=[];for(const n of this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE)){const a=[];if(f.isUri(e))a.push(...this.findEditors(e,t,n));else{const d=this.findEditors(e,t,n);d&&a.push(d)}o.push(...a.map(d=>({editor:d,groupId:n.id})))}return o}else{const o=typeof i=="number"?this.editorGroupsContainer.getGroup(i):i;if(f.isUri(e))return o?o.findEditors(r,t):[];{if(!o)return;const n=o.findEditors(r,t);for(const a of n)if(a.typeId===s)return a;return}}}async replaceEditors(e,t){const i=typeof t=="number"?this.editorGroupsContainer.getGroup(t):t,r=[];for(const s of e){let o;if(!D(s.replacement)){const n=await this.editorResolverService.resolveEditor(s.replacement,i);if(n===B.ABORT)continue;Y(n)&&(o={editor:s.editor,replacement:n.editor,options:n.options,forceReplaceDirty:s.forceReplaceDirty})}o||(o={editor:s.editor,replacement:oe(s)?s.replacement:await this.textEditorService.resolveTextEditor(s.replacement),options:oe(s)?s.options:s.replacement.options,forceReplaceDirty:s.forceReplaceDirty}),r.push(o)}return i==null?void 0:i.replaceEditors(r)}async save(e,t){Array.isArray(e)||(e=[e]);const i=this.getUniqueEditors(e),r=[],s=[];if(t!=null&&t.saveAs)s.push(...i);else for(const{groupId:n,editor:a}of i)a.hasCapability(g.Untitled)?s.push({groupId:n,editor:a}):r.push({groupId:n,editor:a});const o=await H.settled(r.map(({groupId:n,editor:a})=>{var d;return(t==null?void 0:t.reason)===v.EXPLICIT&&((d=this.editorGroupsContainer.getGroup(n))==null||d.pinEditor(a)),a.save(n,t)}));for(const{groupId:n,editor:a}of s){if(a.isDisposed())continue;const d=await this.openEditor(a,n),c={pinned:!0,viewState:d==null?void 0:d.getViewState()},l=t!=null&&t.saveAs?await a.saveAs(n,t):await a.save(n,t);if(o.push(l),!l)break;if(!a.matches(l)){const me=a.hasCapability(g.Untitled)?this.editorGroupsContainer.groups.map(_=>_.id):[n];for(const _ of me)l instanceof Be?await this.replaceEditors([{editor:a,replacement:l,options:c}],_):await this.replaceEditors([{editor:a,replacement:{...l,options:c}}],_)}}return{success:o.every(n=>!!n),editors:A(o)}}saveAll(e){return this.save(this.getAllModifiedEditors(e),e)}async revert(e,t){Array.isArray(e)||(e=[e]);const i=this.getUniqueEditors(e);return await H.settled(i.map(async({groupId:r,editor:s})=>{var o;return(o=this.editorGroupsContainer.getGroup(r))==null||o.pinEditor(s),s.revert(r,t)})),!i.some(({editor:r})=>r.isDirty())}async revertAll(e){return this.revert(this.getAllModifiedEditors(e),e)}getAllModifiedEditors(e){var i;const t=[];for(const r of this.editorGroupsContainer.getGroups(y.MOST_RECENTLY_ACTIVE))for(const s of r.getEditors(p.MOST_RECENTLY_ACTIVE))s.isModified()&&((typeof(e==null?void 0:e.includeUntitled)=="boolean"||!((i=e==null?void 0:e.includeUntitled)!=null&&i.includeScratchpad))&&s.hasCapability(g.Scratchpad)||!(e!=null&&e.includeUntitled)&&s.hasCapability(g.Untitled)||e!=null&&e.excludeSticky&&r.isSticky(s)||t.push({groupId:r.id,editor:s}));return t}getUniqueEditors(e){const t=[];for(const{editor:i,groupId:r}of e)t.some(s=>s.editor.matches(i))||t.push({editor:i,groupId:r});return t}dispose(){super.dispose(),this.activeOutOfWorkspaceWatchers.forEach(e=>G(e)),this.activeOutOfWorkspaceWatchers.clear()}};fe=z=W([u(1,U),u(2,ye),u(3,Ae),u(4,ve),u(5,Ye),u(6,ee),u(7,Oe),u(8,He),u(9,De),u(10,qe)],fe);let Ee=class extends k{constructor(e,t,i,r,s){super(),this.untitledTextEditorService=e,this.instantiationService=t,this.uriIdentityService=i,this.fileService=r,this.editorResolverService=s,this.editorInputCache=new T,this.fileEditorFactory=X.as(Z.EditorFactory).getFileEditorFactory(),this.registerDefaultEditor()}registerDefaultEditor(){this._register(this.editorResolverService.registerEditor("*",{id:j.id,label:j.displayName,detail:j.providerDisplayName,priority:je.builtin},{},{createEditorInput:e=>({editor:this.createTextEditor(e)}),createUntitledEditorInput:e=>({editor:this.createTextEditor(e)}),createDiffEditorInput:e=>({editor:this.createTextEditor(e)})}))}async resolveTextEditor(e){return this.createTextEditor(e)}createTextEditor(e){var r;if(Se(e))return this.createTextEditor(e.result);if(Ce(e)){const s=this.createTextEditor(e.original),o=this.createTextEditor(e.modified);return this.instantiationService.createInstance(ge,e.label,e.description,s,o,void 0)}if(Ke(e)){const s=this.createTextEditor(e.primary),o=this.createTextEditor(e.secondary);return this.instantiationService.createInstance(J,e.label,e.description,o,s)}const t=e;if(t.forceUntitled||!t.resource||t.resource.scheme===ne.untitled){const s={languageId:t.languageId,initialValue:t.contents,encoding:t.encoding};let o;return((r=t.resource)==null?void 0:r.scheme)===ne.untitled?o=this.untitledTextEditorService.create({untitledResource:t.resource,...s}):o=this.untitledTextEditorService.create({associatedResource:t.resource,...s}),this.createOrGetCached(o.resource,()=>this.instantiationService.createInstance(ae,o))}const i=e;if(i.resource instanceof f){const s=i.label||ze(i.resource),o=i.resource,n=this.uriIdentityService.asCanonicalUri(o);return this.createOrGetCached(n,()=>i.forceFile||this.fileService.hasProvider(n)?this.fileEditorFactory.createFileEditor(n,o,i.label,i.description,i.encoding,i.languageId,i.contents,this.instantiationService):this.instantiationService.createInstance(de,n,i.label,i.description,i.languageId,i.contents),a=>{a instanceof ae||(a instanceof de?(s&&a.setName(s),i.description&&a.setDescription(i.description),i.languageId&&a.setPreferredLanguageId(i.languageId),typeof i.contents=="string"&&a.setPreferredContents(i.contents)):(a.setPreferredResource(o),i.label&&a.setPreferredName(i.label),i.description&&a.setPreferredDescription(i.description),i.encoding&&a.setPreferredEncoding(i.encoding),i.languageId&&a.setPreferredLanguageId(i.languageId),typeof i.contents=="string"&&a.setPreferredContents(i.contents)))})}throw new Error(`ITextEditorService: Unable to create texteditor from ${JSON.stringify(e)}`)}createOrGetCached(e,t,i){let r=this.editorInputCache.get(e);return r?(i==null||i(r),r):(r=t(),this.editorInputCache.set(e,r),Q.once(r.onWillDispose)(()=>this.editorInputCache.delete(e)),r)}};Ee=W([u(0,$e),u(1,ye),u(2,ee),u(3,Ae),u(4,Oe)],Ee);var R;let w=(R=class extends k{constructor(e,t,i,r,s,o,n,a){super(),this.filesConfigurationService=e,this.hostService=t,this.editorService=i,this.editorGroupService=r,this.workingCopyService=s,this.logService=o,this.markerService=n,this.uriIdentityService=a,this.scheduledAutoSavesAfterDelay=new Map,this.lastActiveEditor=void 0,this.lastActiveGroupId=void 0,this.lastActiveEditorControlDisposable=this._register(new $),this.waitingOnConditionAutoSaveWorkingCopies=new T(d=>this.uriIdentityService.extUri.getComparisonKey(d)),this.waitingOnConditionAutoSaveEditors=new T(d=>this.uriIdentityService.extUri.getComparisonKey(d));for(const d of this.workingCopyService.dirtyWorkingCopies)this.onDidRegister(d);this.registerListeners()}registerListeners(){this._register(this.hostService.onDidChangeFocus(e=>this.onWindowFocusChange(e))),this._register(this.hostService.onDidChangeActiveWindow(()=>this.onActiveWindowChange())),this._register(this.editorService.onDidActiveEditorChange(()=>this.onDidActiveEditorChange())),this._register(this.filesConfigurationService.onDidChangeAutoSaveConfiguration(()=>this.onDidChangeAutoSaveConfiguration())),this._register(this.workingCopyService.onDidRegister(e=>this.onDidRegister(e))),this._register(this.workingCopyService.onDidUnregister(e=>this.onDidUnregister(e))),this._register(this.workingCopyService.onDidChangeDirty(e=>this.onDidChangeDirty(e))),this._register(this.workingCopyService.onDidChangeContent(e=>this.onDidChangeContent(e))),this._register(this.markerService.onMarkerChanged(e=>this.onConditionChanged(e,S.ERRORS))),this._register(this.filesConfigurationService.onDidChangeAutoSaveDisabled(e=>this.onConditionChanged([e],S.DISABLED)))}onConditionChanged(e,t){for(const i of e){const r=this.waitingOnConditionAutoSaveWorkingCopies.get(i);if((r==null?void 0:r.condition)===t)r.workingCopy.isDirty()&&this.filesConfigurationService.getAutoSaveMode(r.workingCopy.resource,r.reason).mode!==E.OFF&&(this.discardAutoSave(r.workingCopy),this.logService.trace("[editor auto save] running auto save from condition change event",r.workingCopy.resource.toString(),r.workingCopy.typeId),r.workingCopy.save({reason:r.reason}));else{const s=this.waitingOnConditionAutoSaveEditors.get(i);(s==null?void 0:s.condition)===t&&!s.editor.editor.isDisposed()&&s.editor.editor.isDirty()&&this.filesConfigurationService.getAutoSaveMode(s.editor.editor,s.reason).mode!==E.OFF&&(this.waitingOnConditionAutoSaveEditors.delete(i),this.logService.trace(`[editor auto save] running auto save from condition change event with reason ${s.reason}`),this.editorService.save(s.editor,{reason:s.reason}))}}}onWindowFocusChange(e){e||this.maybeTriggerAutoSave(v.WINDOW_CHANGE)}onActiveWindowChange(){this.maybeTriggerAutoSave(v.WINDOW_CHANGE)}onDidActiveEditorChange(){this.lastActiveEditor&&typeof this.lastActiveGroupId=="number"&&this.maybeTriggerAutoSave(v.FOCUS_CHANGE,{groupId:this.lastActiveGroupId,editor:this.lastActiveEditor});const e=this.editorGroupService.activeGroup,t=this.lastActiveEditor=e.activeEditor??void 0;this.lastActiveGroupId=e.id,this.lastActiveEditorControlDisposable.clear();const i=this.editorService.activeEditorPane;t&&i&&this.lastActiveEditorControlDisposable.add(i.onDidBlur(()=>{this.maybeTriggerAutoSave(v.FOCUS_CHANGE,{groupId:e.id,editor:t})}))}maybeTriggerAutoSave(e,t){if(t){if(!t.editor.isDirty()||t.editor.isReadonly()||t.editor.hasCapability(g.Untitled))return;const i=this.filesConfigurationService.getAutoSaveMode(t.editor,e);i.mode!==E.OFF?(e===v.WINDOW_CHANGE&&(i.mode===E.ON_FOCUS_CHANGE||i.mode===E.ON_WINDOW_CHANGE)||e===v.FOCUS_CHANGE&&i.mode===E.ON_FOCUS_CHANGE)&&(this.logService.trace(`[editor auto save] triggering auto save with reason ${e}`),this.editorService.save(t,{reason:e})):t.editor.resource&&(i.reason===S.ERRORS||i.reason===S.DISABLED)&&this.waitingOnConditionAutoSaveEditors.set(t.editor.resource,{editor:t,reason:e,condition:i.reason})}else this.saveAllDirtyAutoSaveables(e)}onDidChangeAutoSaveConfiguration(){let e;switch(this.filesConfigurationService.getAutoSaveMode(void 0).mode){case E.ON_FOCUS_CHANGE:e=v.FOCUS_CHANGE;break;case E.ON_WINDOW_CHANGE:e=v.WINDOW_CHANGE;break;case E.AFTER_SHORT_DELAY:case E.AFTER_LONG_DELAY:e=v.AUTO;break}e&&this.saveAllDirtyAutoSaveables(e)}saveAllDirtyAutoSaveables(e){for(const t of this.workingCopyService.dirtyWorkingCopies){if(t.capabilities&ce.Untitled)continue;const i=this.filesConfigurationService.getAutoSaveMode(t.resource,e);i.mode!==E.OFF?t.save({reason:e}):(i.reason===S.ERRORS||i.reason===S.DISABLED)&&this.waitingOnConditionAutoSaveWorkingCopies.set(t.resource,{workingCopy:t,reason:e,condition:i.reason})}}onDidRegister(e){e.isDirty()&&this.scheduleAutoSave(e)}onDidUnregister(e){this.discardAutoSave(e)}onDidChangeDirty(e){e.isDirty()?this.scheduleAutoSave(e):this.discardAutoSave(e)}onDidChangeContent(e){e.isDirty()&&this.scheduleAutoSave(e)}scheduleAutoSave(e){if(e.capabilities&ce.Untitled)return;const t=this.filesConfigurationService.getAutoSaveConfiguration(e.resource).autoSaveDelay;if(typeof t!="number")return;this.discardAutoSave(e),this.logService.trace(`[editor auto save] scheduling auto save after ${t}ms`,e.resource.toString(),e.typeId);const i=setTimeout(()=>{if(this.discardAutoSave(e),e.isDirty()){const r=v.AUTO,s=this.filesConfigurationService.getAutoSaveMode(e.resource,r);s.mode!==E.OFF?(this.logService.trace("[editor auto save] running auto save",e.resource.toString(),e.typeId),e.save({reason:r})):(s.reason===S.ERRORS||s.reason===S.DISABLED)&&this.waitingOnConditionAutoSaveWorkingCopies.set(e.resource,{workingCopy:e,reason:r,condition:s.reason})}},t);this.scheduledAutoSavesAfterDelay.set(e,Qe(()=>{this.logService.trace("[editor auto save] clearing pending auto save",e.resource.toString(),e.typeId),clearTimeout(i)}))}discardAutoSave(e){G(this.scheduledAutoSavesAfterDelay.get(e)),this.scheduledAutoSavesAfterDelay.delete(e),this.waitingOnConditionAutoSaveWorkingCopies.delete(e.resource),this.waitingOnConditionAutoSaveEditors.delete(e.resource)}},R.ID="workbench.contrib.editorAutoSave",R);w=W([u(0,Je),u(1,De),u(2,Xe),u(3,U),u(4,Ze),u(5,et),u(6,tt),u(7,ee)],w);it(w.ID,w,rt.BlockRestore);X.as(Z.EditorFactory).registerFileEditorFactory({typeId:st,createFileEditor:(h,e,t,i,r,s,o,n)=>n.createInstance(ue,h,e,t,i,r,s,o),isFileEditor:h=>h instanceof ue});export{fe as E,Ee as T,he as f};
