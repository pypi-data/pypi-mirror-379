{% for frag in text.text_fragments %}
{% set lvl = frag.header_level|default(0)|int %}
{% if lvl > 0 %}
{% if lvl > 6 %}{% set lvl = 6 %}{% endif %}
<h{{ lvl }}>{{ frag.text }}</h{{ lvl }}>
{% else %}
{% if frag.text in ['\n', '\r\n'] %}
<br>
{% else %}
{% if frag.link_url %}
<a href="{{ frag.link_url|e }}">
    {% if frag.style.bold %}<strong>{% endif %}
        {% if frag.style.italic %}<em>{% endif %}
            {% if frag.style.underline %}<u>{% endif %}
                {{ frag.text }}
                {% if frag.style.underline %}</u>{% endif %}
            {% if frag.style.italic %}</em>{% endif %}
        {% if frag.style.bold %}</strong>{% endif %}
</a>
{% else %}
{% if frag.style.bold %}<strong>{% endif %}
    {% if frag.style.italic %}<em>{% endif %}
        {% if frag.style.underline %}<u>{% endif %}
            {{ frag.text }}
            {% if frag.style.underline %}</u>{% endif %}
        {% if frag.style.italic %}</em>{% endif %}
    {% if frag.style.bold %}</strong>{% endif %}
{% endif %}
{% endif %}
{% endif %}
{% endfor %}