{% extends 'generic/object_edit.html' %}
{% load form_helpers %}

{% block title %}EntraID Tools Configuration{% endblock %}

{% block form %}
{# ROW 1 - Global Settings (Full Width) #}
{% if perms.netbox_entraid_tools.contact_admin %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-header">
                Global Settings
            </h5>
            <div class="card-body">
                <p class="text-muted">Settings that apply to all jobs.</p>
                <div class="row">
                    <div class="col-md-6">
                        {% render_field form.storage_account_name %}
                    </div>
                    <div class="col-md-6">
                        {% render_field form.report_sender %}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        {% render_field form.debug_mode %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ROW 2 - Job-Specific Settings (Full Width) #}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-header">
                Job 1: Deprecate Inactive Contacts
            </h5>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% render_field form.job1_storage_table_name %}
                    </div>
                    <div class="col-md-6">
                        {% render_field form.job1_report_recipients_text %}
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-md-6">
                        {% render_field form.job1_interval_hours %}
                    </div>
                    <div class="col-md-6">
                        {% render_field form.job1_auto_schedule %}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        {% render_field form.job1_treat_disabled_as_missing %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ROW 3 - Job 2 Settings (Full Width) #}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-header">
                Job 2: Sync User Status
            </h5>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% render_field form.job2_storage_table_name %}
                    </div>
                    <div class="col-md-6">
                        {% render_field form.local_user_accounts_text %}
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-md-6">
                        {% render_field form.job2_interval_hours %}
                    </div>
                    <div class="col-md-6">
                        {% render_field form.job2_auto_schedule %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if settings.debug_mode %}
<!-- DEBUG INFO -->
<div class="row mt-3">
    <div class="col-md-12">
        <div class="alert alert-info">
            <strong>Debug Info:</strong><br>
            Permission check: {% if perms.netbox_entraid_tools.contact_admin %}PASSED{% else %}FAILED{% endif %}<br>
            Is superuser: {% if user.is_superuser %}YES{% else %}NO{% endif %}<br>
            Permission name: netbox_entraid_tools.contact_admin
        </div>
    </div>
</div>
<!-- END DEBUG INFO -->
{% endif %}

{% if perms.netbox_entraid_tools.contact_admin %}
{# ROW 4 - Run Jobs Manually (Full Width) #}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-header">
                Run Jobs Manually
            </h5>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <h6 class="card-header">
                                Job 1: Deprecate Inactive Contacts
                            </h6>
                            <div class="card-body">
                                <p class="text-muted">
                                    Manually trigger the "Deprecate Inactive Contacts" job. The job will be executed in the background.
                                </p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="job1_dry_run" id="job1_dry_run" checked>
                                    <label class="form-check-label" for="job1_dry_run">
                                        <strong>Dry Run:</strong> Preview changes without applying them.
                                    </label>
                                </div>
                            </div>
                            <div class="card-footer text-end">
                                <button type="submit" name="run_job1" class="btn btn-success">
                                    <i class="mdi mdi-play-circle-outline" aria-hidden="true"></i> Run Deprecation Job
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <h6 class="card-header">
                                Job 2: Sync User Status
                            </h6>
                            <div class="card-body">
                                <p class="text-muted">
                                    Manually trigger the "Sync User Status" job. The job will be executed in the background.
                                </p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="job2_dry_run" id="job2_dry_run" checked>
                                    <label class="form-check-label" for="job2_dry_run">
                                        <strong>Dry Run:</strong> Preview changes without applying them.
                                    </label>
                                </div>
                            </div>
                            <div class="card-footer text-end">
                                <button type="submit" name="run_job2" class="btn btn-success">
                                    <i class="mdi mdi-play-circle-outline" aria-hidden="true"></i> Run User Sync Job
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block buttons %}
    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
        Cancel
    </a>
    <button type="submit" name="_update" class="btn btn-primary">
        Save Settings
    </button>
{% endblock %}

{% block content %}
{{ block.super }}

{% comment %}
<!-- Debug info and duplicate job execution form removed.
     The job execution form is now only included once in the form block.
     If you want to restore debug info, add DEBUG_MODE=True to PLUGINS_CONFIG -->
{% endcomment %}
{% endblock %}