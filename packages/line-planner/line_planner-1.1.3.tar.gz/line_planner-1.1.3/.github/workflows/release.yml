name: Build and Release LinePlanner

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  id-token: write  # ç”¨äºPyPIå¯ä¿¡å‘å¸ƒ

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„Gitå†å²ï¼Œç¡®ä¿æ ‡ç­¾å¯è§
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build twine setuptools-scm[toml]
        uv sync --dev
        
    - name: Verify Git and version info
      run: |
        echo "Current Git tag: ${{ github.ref_name }}"
        echo "Git tags:"
        git tag --list
        echo "Package version detection:"
        python -c "from setuptools_scm import get_version; print(f'Detected version: {get_version()}')"
        
    - name: Run tests
      run: |
        echo "Testing LinePlanner functionality..."
        # æµ‹è¯•ä¸»è¦åŠŸèƒ½
        echo '{"kml_file":"test.kml","line_spacing":25,"rotation_angle":0,"save_dir":"./test_output"}' | uv run python interface.py
        echo "âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡"
        
    - name: Build package
      run: |
        echo "Building package..."
        python -m build
        echo "Build artifacts:"
        ls -la dist/
        
    - name: Verify package metadata
      run: |
        echo "Checking package distribution..."
        python -m twine check dist/*
        echo "Package contents:"
        python -c "
        import tarfile
        import glob
        for f in glob.glob('dist/*.tar.gz'):
            print(f'Contents of {f}:')
            with tarfile.open(f, 'r:gz') as tar:
                tar.list()
        "
        
    - name: Test local installation
      run: |
        echo "Testing local installation..."
        python -m pip install dist/*.whl
        python -c "
        import line_planner
        print(f'Installed version: {line_planner.__version__}')
        print('Installation test passed!')
        "
    
    - name: Publish to PyPI
      if: startsWith(github.ref, 'refs/tags/v')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        # skip-existing: true
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: LinePlanner ${{ github.ref_name }}
        body: |
          ## ğŸ‰ LinePlanner ${{ github.ref_name }} å‘å¸ƒ
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          
          ```bash
          # ä»PyPIå®‰è£…
          pip install line-planner==${{ github.ref_name }}
          
          # æˆ–è€…å®‰è£…æœ€æ–°ç‰ˆæœ¬  
          pip install line-planner
          
          # ä½¿ç”¨uvå®‰è£…ï¼ˆæ¨èï¼‰
          uv add line-planner
          ```
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          #### æ ‡å‡†è¾“å…¥æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼š
          ```bash
          # ç›´æ¥JSONé…ç½®
          echo '{"kml_file":"boundary.kml","line_spacing":25,"rotation_angle":0,"save_dir":"./output"}' | python interface.py
          
          # é€šè¿‡é…ç½®æ–‡ä»¶
          echo "config.json" | python interface.py
          ```
          
          #### Python APIä½¿ç”¨ï¼š
          ```python
          from line_planner import StandalonePlanner, StandaloneBoundaryParser
          
          # è§£æKMLè¾¹ç•Œ
          parser = StandaloneBoundaryParser()
          lats, lons = parser.parse_kml_coordinates("boundary.kml")
          
          # è§„åˆ’èˆªçº¿
          planner = StandalonePlanner()
          turn_points = planner.plan_flight_lines(
              boundary_lats=lats,
              boundary_lons=lons,
              line_spacing=25.0,
              rotation_angle=0.0
          )
          ```
          
          ### ğŸ“‹ ä¸»è¦åŠŸèƒ½
          - âœ… SIFè®¾å¤‡ä¸“ç”¨èˆªçº¿è§„åˆ’
          - âœ… è›‡å½¢è·¯å¾„è‡ªåŠ¨ä¼˜åŒ–
          - âœ… é«˜ç²¾åº¦WGS84åæ ‡ç³»ç»Ÿ
          - âœ… å†…ç½®å¯è§†åŒ–ç”Ÿæˆ
          - âœ… å¤šæ ¼å¼è¾“å‡ºï¼ˆJSON/PNG/LOGï¼‰
          - âœ… æç®€åŒ–æ¶æ„ï¼Œæ˜“äºç»´æŠ¤
          
          ### ğŸ¯ é¡¹ç›®ç‰¹ç‚¹
          - **ç®€åŒ–æ¶æ„**: åˆ é™¤å¤æ‚APIï¼Œä¸“æ³¨ç‹¬ç«‹å®ç°
          - **æ ‡å‡†è¾“å…¥**: é€šè¿‡JSONé…ç½®é©±åŠ¨
          - **ä¸€é”®è¿è¡Œ**: interface.pyç»Ÿä¸€å…¥å£
          - **å†…ç½®å¯è§†åŒ–**: è‡ªåŠ¨ç”Ÿæˆèˆªçº¿å›¾åƒ
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/1034378361/LinePlanner/issues)
          - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/1034378361/LinePlanner/discussions)
          - ğŸ“– [é¡¹ç›®æ–‡æ¡£](https://github.com/1034378361/LinePlanner/blob/main/CLAUDE.md)
          
          ### ğŸ“Š é…ç½®æ–‡ä»¶ç¤ºä¾‹
          
          ```json
          {
            "kml_file": "boundary.kml",
            "line_spacing": 25,
            "rotation_angle": 0,
            "save_dir": "./output"
          }
          ```
          
          ---
          
          **å®Œæ•´æ›´æ–°ä¿¡æ¯:** è¯·æŸ¥çœ‹é¡¹ç›®çš„ [Gitæäº¤å†å²](https://github.com/1034378361/LinePlanner/commits)
        files: |
          dist/*
        draft: false
        prerelease: false