#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

echo "Starting Flower (Sync Mode) with auto-reload..."

# Wait for Redis
while ! nc -z ${REDIS_HOST:-redis} ${REDIS_PORT:-6379}; do
    echo "Waiting for Redis..."
    sleep 1
done
echo "âœ“ Redis is ready"

FLOWER_CMD="celery \
  -A app.core.celery_app \
  -b ${CELERY_BROKER_URL:-redis://redis:6379/0} \
  flower \
  --address=0.0.0.0 \
  --port=5555 \
  --basic_auth=${CELERY_FLOWER_USER:-admin}:${CELERY_FLOWER_PASSWORD:-admin}"

exec watchfiles \
    --filter python \
    --ignore-paths '.venv,.git,__pycache__,*.pyc,logs' \
    "${FLOWER_CMD}"