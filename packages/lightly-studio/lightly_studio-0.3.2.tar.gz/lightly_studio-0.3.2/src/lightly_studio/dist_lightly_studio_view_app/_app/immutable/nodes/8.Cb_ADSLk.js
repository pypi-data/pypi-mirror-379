import{p as R,f as C,n as Kt,a as H,w as Nt,l as Y,$ as pt,g as t,d as s,c as m,r as _,s as w,t as F,J as Wt,a7 as qt,ax as Mt}from"../chunks/DcGCxgpH.js";import{c as Jt}from"../chunks/Cpy-nab_.js";import{u as bt}from"../chunks/BBoGk9hq.js";import"../chunks/CWj6FrbW.js";import{c as X,a as f,t as k,n as Vt}from"../chunks/Crk-jcvV.js";import{i as O,a as j,s as q}from"../chunks/DqUGznj_.js";import{e as gt}from"../chunks/C98Hk3r5.js";import{I as Zt,j as tt,F as Qt,H as st,J as Yt,K as Xt,M as ta,N as aa,y as ht,B as ea,h as na,O as oa,p as sa,C as Bt,w as Ct,v as Dt,f as ia,n as ra,_ as da,S as la,P as ca,k as ua,Q as va}from"../chunks/BRnH9v23.js";import{g as ot,c as _a}from"../chunks/2O287xak.js";import{f as Pt,S as ma}from"../chunks/M1Q1F7bw.js";import{r as z}from"../chunks/H7C68rOM.js";import"../chunks/gLNdjSzu.js";import{p as E}from"../chunks/Df3aMO5B.js";import"../chunks/69_IOA4Y.js";import{s as fa}from"../chunks/C0JiMuYn.js";import{S as pa}from"../chunks/CzgC3GFB.js";import{S as ga,B as ha,a as ba,b as nt,c as mt,H as xa,d as ft,D as Ia,e as Aa,Z as wa,g as Sa,u as ya}from"../chunks/DFRh-Spp.js";import{S as $a}from"../chunks/DRZO-E-T.js";import{s as ka,r as Ma,a as Pa}from"../chunks/D8GZDMNN.js";import{s as W}from"../chunks/KpAtIldw.js";import{C as Na}from"../chunks/OH7-C_mc.js";function Ba(v,a){R(a,!0);let o=Ma(a,["$$slots","$$events","$$legacy"]);Zt(v,ka({name:"square-dashed"},()=>o,{iconNode:[["path",{d:"M5 3a2 2 0 0 0-2 2"}],["path",{d:"M19 3a2 2 0 0 1 2 2"}],["path",{d:"M21 19a2 2 0 0 1-2 2"}],["path",{d:"M5 21a2 2 0 0 1-2-2"}],["path",{d:"M9 3h1"}],["path",{d:"M9 21h1"}],["path",{d:"M14 3h1"}],["path",{d:"M14 21h1"}],["path",{d:"M3 9v1"}],["path",{d:"M21 9v1"}],["path",{d:"M3 14v1"}],["path",{d:"M21 14v1"}]],children:(e,i)=>{var l=X(),h=C(l);fa(h,()=>a.children??Kt),f(e,l)},$$slots:{default:!0}})),H()}const Ca=({annotationIndex:v,...a})=>{const o=Nt({isLoading:!1});return(async()=>{o.update(e=>({...e,isLoading:!0}));try{const{data:e}=await Jt({path:{dataset_id:a.dataset_id},query:{cursor:v>0?v-1:0,limit:3,annotation_label_ids:a.annotation_label_ids,tag_ids:a.tag_ids}});if(!e){o.update(n=>({...n,isLoading:!1,error:"No annotations data received",data:void 0}));return}const{setAnnotationsTotalCount:i}=bt();i(e.total_count);let l;const h=v>0?e.data[0]:void 0;e.data.length>1&&(l=v===0?e.data[1]:e.data[2]),o.update(n=>({...n,isLoading:!1,error:void 0,data:{annotationNext:l,annotationPrevious:h}}))}catch(e){o.update(i=>({...i,isLoading:!1,error:String(e)}))}})(),o},Da=async({parent:v,params:{dataset_id:a,annotationId:o,annotationIndex:u}})=>{const{annotationsSelectedTagsIds:e,annotationsSelectedAnnotationLabelsIds:i,dataset:l}=await v(),h=parseInt(u,10),n=Nt();if(!l)throw new Error("Dataset data not found");return Ca({annotationIndex:h,dataset_id:a,currentAnnotationId:o,annotation_label_ids:Array.from(Y(i)),tag_ids:Array.from(Y(e))}).subscribe(({data:D})=>{n.set(D)}),{annotationAdjacents:n,annotationIndex:h,annotationId:o,dataset:l}},ke=Object.freeze(Object.defineProperty({__proto__:null,load:Da},Symbol.toStringTag,{value:"Module"}));function La(v,a){R(a,!0);const[o,u]=q(),e=()=>j(t(l),"$annotationAdjacents",o),i=s(()=>E.data.annotationIndex),l=s(()=>E.data.annotationAdjacents),h=()=>{e().annotationNext&&ot(z.toSampleWithAnnotation({datasetId:e().annotationNext.dataset_id,sampleId:e().annotationNext.sample_id,annotationId:e().annotationNext.annotation_id,annotationIndex:t(i)+1}))},n=()=>{e().annotationPrevious&&ot(z.toSampleWithAnnotation({datasetId:e().annotationPrevious.dataset_id,sampleId:e().annotationPrevious.sample_id,annotationId:e().annotationPrevious.annotation_id,annotationIndex:t(i)-1}))},D=p=>{switch(p.key){case"ArrowRight":h();break;case"ArrowLeft":n();break}};var S=X();gt("keydown",pt,D);var y=C(S);{var x=p=>{const M=s(()=>!!e().annotationPrevious),$=s(()=>!!e().annotationNext);$a(p,{get hasPrevious(){return t(M)},get hasNext(){return t($)},onPrevious:n,onNext:h})};O(y,p=>{e()&&p(x)})}f(v,S),H(),u()}const ja={object_detection:"Object Detection",bbox:"Bounding Box",instance_segmentation:"Instance Segmentation",semantic_segmentation:"Semantic Segmentation",classification:"Classification"};var Ta=k('<span class="text-sm"> </span> <span class="break-all text-sm"> </span>',1);function Ea(v,a){var o=Ta(),u=C(o),e=m(u,!0);_(u);var i=w(u,2),l=m(i,!0);_(i),F(()=>{W(e,a.label),tt(i,"data-testid",`annotation-metadata-${a.id}`),W(l,a.value)}),f(v,o)}var Ra=k('<span class="break-all text-sm"> </span>'),Ha=k('<span class="text-sm"> </span> <!>',1);function Ua(v,a){R(a,!0);const[o,u]=q(),e=()=>j(l,"$result",o),i=()=>j(a.isEditingMode,"$isEditingMode",o),l=Qt(),{updateAnnotation:h}=st({datasetId:a.datasetId,annotationId:a.annotationId,onUpdate:a.onUpdate}),n=s(()=>ta(e().data||[])),D=s(()=>{const I=t(n).find(c=>c.value===a.value);return I||{value:a.value,label:a.value}});var S=Ha(),y=C(S),x=m(y,!0);_(y);var p=w(y,2);{var M=I=>{Yt(I,{get items(){return t(n)},get value(){return t(D)},name:"annotation-label",placeholder:"Select a label",onSelect:r=>{h({annotation_id:a.annotationId,dataset_id:a.datasetId,label_name:r.value})},notFound:(r,A)=>{let g=()=>A==null?void 0:A().inputValue;Xt(r,{get label(){return g()}})},$$slots:{notFound:!0}})},$=I=>{var c=Ra();tt(c,"data-testid","annotation-metadata-label");var r=m(c,!0);_(c),F(()=>W(r,a.value)),f(I,c)};O(p,I=>{i()?I(M):I($,!1)})}F(()=>W(x,a.label)),f(v,S),H(),u()}var za=k('<div class="flex flex-col gap-4"><div class="grid grid-cols-[6rem_1fr] gap-y-3 text-diffuse-foreground"></div></div>');function Fa(v,a){R(a,!0);const[o,u]=q(),e=()=>j(t(h),"$annotationResp",o),{datasetId:i}=E.data,l=s(()=>st({datasetId:i,annotationId:a.annotationId})),h=s(()=>t(l).annotation);let n=s(()=>e().data);const D=s(oa),S=s(()=>t(D).taskMap),y=s(()=>t(n)&&t(n).annotation_task_id&&Y(t(S)).has(t(n).annotation_task_id)?Y(t(S)).get(t(n).annotation_task_id).is_prediction:!1),x=s(()=>{var r,A;if(!t(n))return[];let c=[{id:"label",label:"Label:",value:(A=(r=t(n))==null?void 0:r.annotation_label)==null?void 0:A.annotation_label_name},{id:"type",label:"Type:",value:ja[t(n).annotation_type]||"Unknown"},{id:"status",label:"Status:",value:t(y)?"Prediction":"Ground Truth"}];if(t(n)&&!aa(t(n))){const{height:g,width:P}=ht(t(n));c=[{id:"height",label:"Height:",value:Pt(Math.round(g))+"px"},{id:"width",label:"Width:",value:Pt(Math.round(P))+"px"},...c]}return c}),{isEditingMode:p}=E.data.globalStorage;var M=X(),$=C(M);{var I=c=>{ea(c,{title:"Annotation details",children:(r,A)=>{var g=za(),P=m(g);na(P,21,()=>t(x),({label:B,value:b,id:N})=>B,(B,b)=>{let N=()=>t(b).label,d=()=>t(b).value,G=()=>t(b).id;var at=X(),it=C(at);{var J=T=>{Ua(T,{get onUpdate(){return a.onUpdate},get annotationId(){return a.annotationId},datasetId:i,get label(){return N()},get value(){return d()},isEditingMode:p})},V=T=>{Ea(T,{get label(){return N()},get id(){return G()},get value(){return d()}})};O(it,T=>{G()==="label"&&p?T(J):T(V,!1)})}f(B,at)}),_(P),_(g),f(r,g)}})};O($,c=>{t(x).length>0&&c(I)})}f(v,M),H(),u()}var Oa=k('<!> <h2 class="py-2 text-lg font-semibold"><a>Check all sample annotations</a></h2>',1),Ga=k('<div class="flex h-full w-full items-center justify-center"><!></div>'),Ka=k('<div class="flex h-full min-h-0 flex-col space-y-4 overflow-hidden dark:[color-scheme:dark]"><!> <!></div>');function Wa(v,a){R(a,!0);const{datasetId:o}=E.data;let u=qt(void 0);st({datasetId:o,annotationId:a.annotationId}).annotation.subscribe(n=>{n.isSuccess&&Wt(u,Pa(n.data.sample))});const i=sa(),[l,h]=i;Bt(v,{className:"h-full",children:(n,D)=>{Ct(n,{className:"h-full flex flex-col",children:(S,y)=>{var x=Ka(),p=m(x);Fa(p,{get annotationId(){return a.annotationId},get onUpdate(){return a.onUpdate}});var M=w(p,2);{var $=c=>{var r=Oa(),A=C(r);ga(A,{get sample(){return t(u)},showCustomMetadata:!1});var g=w(A,2),P=m(g);_(g),F(B=>tt(P,"href",B),[()=>l(z.toSample({sampleId:t(u).sample_id,datasetId:t(u).dataset_id}),void 0)]),f(c,r)},I=c=>{var r=Ga(),A=m(r);Dt(A,{size:"large",align:"center"}),_(r),f(c,r)};O(M,c=>{t(u)?c($):c(I,!1)})}_(x),f(S,x)},$$slots:{default:!0}})},$$slots:{default:!0}}),H()}var qa=k('<!> <span class="hidden sm:inline">Home</span>',1),Ja=k('<!> <span class="max-w-[150px] truncate"> </span>',1),Va=k('<!> <span class="hidden sm:inline">Annotations</span>',1),Za=k('<!> <span class="max-w-[200px] truncate"> </span>',1),Qa=k("<!> <!> <!> <!> <!> <!> <!>",1);function Ya(v,a){R(a,!0);const[o,u]=q(),e=()=>j(i,"$annotationsTotalCount",o),{annotationsTotalCount:i}=bt();ha(v,{class:"mb-2",children:(l,h)=>{ba(l,{children:(n,D)=>{var S=Qa(),y=C(S);nt(y,{children:(r,A)=>{const g=s(()=>z.toHome());mt(r,{get href(){return t(g)},class:"flex items-center gap-2",children:(P,B)=>{var b=qa(),N=C(b);xa(N,{class:"h-4 w-4"}),Mt(2),f(P,b)},$$slots:{default:!0}})},$$slots:{default:!0}});var x=w(y,2);ft(x,{});var p=w(x,2);nt(p,{children:(r,A)=>{const g=s(()=>z.toAnnotations(a.dataset.dataset_id));mt(r,{get href(){return t(g)},class:"flex items-center gap-2",get title(){return a.dataset.directory},children:(P,B)=>{var b=Ja(),N=C(b);Ia(N,{class:"h-4 w-4"});var d=w(N,2),G=m(d,!0);_(d),F(()=>{tt(d,"title",a.dataset.directory),W(G,a.dataset.name)}),f(P,b)},$$slots:{default:!0}})},$$slots:{default:!0}});var M=w(p,2);ft(M,{});var $=w(M,2);nt($,{children:(r,A)=>{const g=s(()=>z.toAnnotations(a.dataset.dataset_id));mt(r,{get href(){return t(g)},class:"flex items-center gap-2",children:(P,B)=>{var b=Va(),N=C(b);Na(N,{class:"h-4 w-4"}),Mt(2),f(P,b)},$$slots:{default:!0}})},$$slots:{default:!0}});var I=w($,2);ft(I,{});var c=w(I,2);nt(c,{children:(r,A)=>{Aa(r,{class:"flex items-center gap-2",children:(g,P)=>{var B=Za(),b=C(B);Ba(b,{class:"h-4 w-4"});var N=w(b,2),d=m(N);_(N),F(()=>W(d,`Annotation ${a.annotationIndex+1} of ${e()??""}`)),f(g,B)},$$slots:{default:!0}})},$$slots:{default:!0}}),f(n,S)},$$slots:{default:!0}})},$$slots:{default:!0}}),H(),u()}var Xa=Vt("<image></image><g><!></g>",1),te=k('<div class="h-full w-full overflow-hidden"><div class="sample relative h-full w-full"><div class="absolute right-4 top-2 z-30"><!></div> <!> <!></div></div>'),ae=k('<div class="flex h-full w-full items-center justify-center"><!></div>'),ee=k('<div class="flex h-full w-full flex-col space-y-4"><div class="flex w-full items-center"><!></div> <!> <div class="flex min-h-0 flex-1 gap-4"><div class="flex-1"><!></div> <div class="relative w-[375px]"><!></div></div></div>');function ne(v,a){R(a,!0);const[o,u]=q(),e=()=>j(t(P),"$annotationResp",o),i=()=>j(D,"$selectedSampleAnnotationCropIds",o),l=()=>j(x,"$isHidden",o),h=()=>j(it,"$isEditingMode",o),{toggleSampleAnnotationCropSelection:n,selectedSampleAnnotationCropIds:D,clearReversibleActionsByGroupId:S,addReversibleAction:y}=bt(),{isHidden:x,handleKeyEvent:p}=ia(),{settingsStore:M}=ra(),$=" ",I=Y(M).key_go_back,c=()=>{var L;(L=a.sample)!=null&&L.dataset_id?ot(z.toAnnotations(a.sample.dataset_id)):ot("/")},r=L=>{switch(L.key){case I:c();break;case $:L.preventDefault(),n(a.annotationId);break}p(L)},A=E.data.datasetId,g=s(()=>st({datasetId:A,annotationId:a.annotationId})),P=s(()=>t(g).annotation),B=s(()=>t(g).updateAnnotation),b="bbox-change-annotation-details";_a(()=>{S(b)});const N=da.debounce(L=>{if(t(d)){const Z={annotation_id:t(d).annotation_id,dataset_id:t(d).dataset_id,bounding_box:L},dt=ht(t(d)),wt=async()=>{const Q={annotation_id:t(d).annotation_id,dataset_id:t(d).dataset_id,bounding_box:dt};await t(B)(Q)};(async()=>{try{await t(B)(Z),y({id:`bbox-change-${t(d).annotation_id}-${Date.now()}`,description:`Revert bounding box change for annotation ${t(d).annotation_id}`,execute:wt,timestamp:new Date,groupId:b})}catch(Q){va.error("Failed to update annotations:"+Q.message)}})()}},300);let d=s(()=>e().data),G=s(()=>{var L,Z;return Sa(((Z=(L=t(d))==null?void 0:L.sample)==null?void 0:Z.sample_id)||"")}),at=s(()=>t(d)?ht(t(d)):void 0);const{isEditingMode:it}=E.data.globalStorage;var J=ee();gt("keydown",pt,r),gt("keyup",pt,p);var V=m(J),T=m(V);Ya(T,{get dataset(){return a.dataset},get annotationIndex(){return a.annotationIndex}}),_(V);var xt=w(V,2);ma(xt,{class:"mb-4 bg-border-hard"});var It=w(xt,2),rt=m(It),Lt=m(rt);Bt(Lt,{className:"h-full",children:(L,Z)=>{Ct(L,{className:"h-full",children:(dt,wt)=>{var lt=X(),Q=C(lt);{var Tt=K=>{var U=te(),et=m(U),ct=m(et),Rt=m(ct);const Ht=s(()=>i().has(a.annotationId));la(Rt,{onSelect:()=>n(a.annotationId),get isSelected(){return t(Ht)}}),_(ct);var St=w(ct,2);La(St,{});var Ut=w(St,2);wa(Ut,{get width(){return t(d).sample.width},get height(){return t(d).sample.height},get boundingBox(){return t(at)},zoomableContent:(zt,ut)=>{let Ft=()=>ut==null?void 0:ut().scale;var yt=Xa(),$t=C(yt),vt=w($t);let kt;var Ot=m(vt);ca(Ot,()=>e().dataUpdatedAt,_t=>{const Gt=s(()=>({x:0,y:0,width:t(d).sample.width,height:t(d).sample.height}));pa(_t,{get annotation(){return t(d)},showLabel:!0,get scale(){return Ft()},get imageWidth(){return t(d).sample.width},get isResizable(){return h()},onBoundingBoxChange:N,get constraintBox(){return t(Gt)}})}),_(vt),F(_t=>{tt($t,"href",t(G)),kt=ua(vt,0,"",null,kt,_t)},[()=>({invisible:l()})]),f(zt,yt)},$$slots:{zoomableContent:!0}}),_(et),_(U),f(K,U)},Et=K=>{var U=ae(),et=m(U);Dt(et,{size:"large",align:"center"}),_(U),f(K,U)};O(Q,K=>{t(d)?K(Tt):K(Et,!1)})}f(dt,lt)},$$slots:{default:!0}})},$$slots:{default:!0}}),_(rt);var At=w(rt,2),jt=m(At);Wa(jt,{get annotationId(){return a.annotationId}}),_(At),_(It),_(J),f(v,J),H(),u()}var oe=k('<div class="flex h-full w-full space-x-4 px-4 pb-4" data-testid="annotation-details"><div class="h-full w-full space-y-6 rounded-[1vw] bg-card p-4"><!></div></div>');function Me(v,a){R(a,!0);const[o,u]=q(),e=()=>j(t(S),"$sample",o),i=s(()=>a.data.annotationId),l=s(()=>a.data.dataset),h=s(()=>a.data.annotationIndex),{sampleId:n}=E.params,D=s(()=>ya({sampleId:n,datasetId:t(l).dataset_id})),S=s(()=>t(D).sample);var y=oe(),x=m(y),p=m(x);{var M=$=>{ne($,{get annotationId(){return t(i)},get annotationIndex(){return t(h)},get dataset(){return t(l)},get sample(){return e().data}})};O(p,$=>{e().data&&t(i)&&t(l)&&$(M)})}_(x),_(y),f(v,y),H(),u()}export{Me as component,ke as universal};
