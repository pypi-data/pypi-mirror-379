{% extends 'payments/base.html' %}
{% load payments_tags %}
{% load static %}

{% block title %}Payment Dashboard - Django CFG{% endblock %}

{% block header_title %}Payment Dashboard{% endblock %}
{% block header_subtitle %}Monitor and manage payment transactions in real-time{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Debug Info (Collapsible) -->
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg mb-6">
        <button onclick="toggleDebug()" class="w-full px-4 py-3 text-left flex items-center justify-between text-yellow-800 dark:text-yellow-200 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition-colors duration-200">
            <span class="font-medium">üêõ Debug Information</span>
            <span id="debug-icon" class="material-icons text-sm transform transition-transform duration-200">expand_more</span>
        </button>
        <div id="debug-content" class="hidden px-4 pb-3 text-yellow-700 dark:text-yellow-300 text-sm">
            <div class="space-y-1">
                <p><strong>Payments:</strong> {{ payments|length }}</p>
                <p><strong>Payment Stats:</strong> {{ payment_stats }}</p>
                <p><strong>Provider Stats:</strong> {{ provider_stats|length }}</p>
                <p><strong>Context Keys:</strong> {{ view|default:"no view" }}</p>
            </div>
        </div>
    </div>
    
    <!-- Status Overview -->
    {% include 'payments/components/status_overview.html' %}
    
    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent Payments -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Payments</h3>
                        <a href="/admin/django_cfg_payments/universalpayment/" 
                           class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium">
                            View All ‚Üí
                        </a>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Debug: Payments Section -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200 px-4 py-3 rounded mb-4">
                        <strong>Payments Debug:</strong> Count={{ payments|length }}
                        {% if payments %}
                            <br><strong>First payment:</strong> {{ payments.0.user.email }} - ${{ payments.0.amount_usd }}
                        {% endif %}
                    </div>
                    
                    {% if payments %}
                        <div class="space-y-4">
                            {% for payment in payments %}
                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-4">
                                    <div class="w-3 h-3 rounded-full 
                                        {% if payment.provider == 'cryptapi' %}bg-orange-500
                                        {% elif payment.provider == 'cryptomus' %}bg-blue-500
                                        {% elif payment.provider == 'stripe' %}bg-purple-500
                                        {% elif payment.provider == 'nowpayments' %}bg-green-500
                                        {% else %}bg-gray-500{% endif %}">
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                                            ${{ payment.amount_usd|floatformat:2 }}
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">
                                            {{ payment.user.email }} ‚Ä¢ {{ payment.provider|capfirst }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-2 py-1 text-xs rounded-full bg-warning-100 text-warning-800 dark:bg-warning-900 dark:text-warning-200">
                                        {{ payment.status|capfirst }}
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        {{ payment.created_at|timesince }} ago
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-2">üí≥</div>
                            <p class="text-gray-600 dark:text-gray-400">No payments found</p>
                            <a href="/admin/django_cfg_payments/universalpayment/add/" 
                               class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium">
                                Create first payment
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar Stats -->
        <div class="space-y-6">
            <!-- Provider Performance -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Provider Status</h4>
                </div>
                <div class="p-6">
                    {% if provider_stats %}
                        <div class="space-y-3">
                            {% for provider in provider_stats %}
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 rounded-full 
                                        {% if provider.provider == 'cryptapi' %}bg-orange-500
                                        {% elif provider.provider == 'cryptomus' %}bg-blue-500
                                        {% elif provider.provider == 'stripe' %}bg-purple-500
                                        {% elif provider.provider == 'nowpayments' %}bg-green-500
                                        {% else %}bg-gray-500{% endif %}">
                                    </div>
                                    <span class="text-sm text-gray-700 dark:text-gray-300 capitalize">{{ provider.provider }}</span>
                                </div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ provider.count|default:"0" }} payments
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center">No provider data</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- System Status -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">System Status</h4>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">API Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                Online
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Webhook Queue</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                Processing
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Database</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                Connected
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Quick Actions</h4>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <a href="/cfg/admin/django_cfg_payments/admin/stats/" 
                           class="block w-full text-center px-3 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-md text-sm font-medium transition-colors duration-200">
                            View Analytics
                        </a>
                        <a href="/cfg/admin/django_cfg_payments/admin/test/" 
                           class="block w-full text-center px-3 py-2 bg-gray-600 hover:bg-gray-700 dark:bg-gray-500 dark:hover:bg-gray-600 text-white rounded-md text-sm font-medium transition-colors duration-200">
                            Test Providers
                        </a>
                        <a href="/admin/django_cfg_payments/universalpayment/add/" 
                           class="block w-full text-center px-3 py-2 border border-gray-300 dark:border-gray-500 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-md text-sm font-medium transition-colors duration-200">
                            Create Payment
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simplified dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('Payment Dashboard loaded');
    
    // Initialize any tooltips or interactive elements
    initializeDashboard();
});

function initializeDashboard() {
    // Add click handlers for any interactive elements
    const copyButtons = document.querySelectorAll('[data-copy]');
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const text = this.getAttribute('data-copy');
            if (window.paymentUtils) {
                window.paymentUtils.copyToClipboard(text);
            }
        });
    });
    
    // Auto-refresh timestamp every minute
    setInterval(updateTimestamps, 60000);
}

function updateTimestamps() {
    const timestampElements = document.querySelectorAll('[data-timestamp]');
    timestampElements.forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (timestamp && window.paymentUtils) {
            element.textContent = window.paymentUtils.timeAgo(timestamp);
        }
    });
}

// Quick action functions (from status_overview.html)
function createNewPayment() {
    window.location.href = '/admin/django_cfg_payments/universalpayment/add/';
}

function refreshPayments() {
    location.reload();
}

function exportPayments() {
    if (window.notificationManager) {
        window.notificationManager.info('Export functionality coming soon');
    }
}

// Debug panel toggle
function toggleDebug() {
    const content = document.getElementById('debug-content');
    const icon = document.getElementById('debug-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = 'expand_less';
        icon.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        icon.textContent = 'expand_more';
        icon.classList.remove('rotate-180');
    }
}
</script>
{% endblock %}