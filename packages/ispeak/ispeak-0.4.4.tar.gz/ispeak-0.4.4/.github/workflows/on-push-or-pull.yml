name: on-push-or-pull

on:
  push:
    branches:
      - dev
      - master
  pull_request:
    branches:
      - dev
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: install::deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            portaudio19-dev \
            libasound2-dev \
            libpulse-dev \
            libsndfile1-dev \
            ffmpeg \
            xvfb

      - name: install::python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: install::uv
        uses: astral-sh/setup-uv@v6

      - name: install::pdpmake
        run : |
          git clone https://github.com/rmyorston/pdpmake pdpmake-src
          cd pdpmake-src
          make
          mkdir -p "$HOME/.local/bin"
          mv ./make "$HOME/.local/bin/pdpmake"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          cd ..
          rm -rf pdpmake-src

      - name: make::install_cpu
        run : pdpmake install_cpu
      - name: make::install_plugin
        run : pdpmake install_plugin
      - name: make::install_dev
        run : pdpmake install_dev

      - name: make::check::format
        run: pdpmake format
      - name: make::check::lint
        run: pdpmake lint
      - name: make::check::type
        run: pdpmake type
      - name: make::check::test
        env:
          DISPLAY: :0
        run: xvfb-run -a -s "-screen 0 1024x768x24" pdpmake test

      - name: make::build
        env:
          DISPLAY: :0
        run: xvfb-run -a -s "-screen 0 1024x768x24" pdpmake build
