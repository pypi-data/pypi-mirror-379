<div id="view_panel_root">
  <div id="view_tabs"
    style="display:flex; align-items:center; gap:6px; border-bottom:1px solid #e5e7eb; padding:4px 0; margin-bottom:8px; overflow:auto;">
  </div>
  <div class="muted" id="view_panel_splash"
    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
    <h1>View Panel</h1>
    <p>Here will be displayed contextualized data.</p>
  </div>

  <div id="vp_error" style="display:none; margin:8px 0; padding:8px 10px; border:1px solid #fecaca; background:#fef2f2; color:#b91c1c; border-radius:6px; font-size:12px;"></div>

  <div id="vp_image" style="display:none; height:100%; overflow:auto;">
    <img id="vp_image_img" alt="image" style="max-width:100%; height:auto; display:block; margin: 0 auto;" />
  </div>

  <div id="vp_pdf" style="display:none; height:100%;">
    <iframe id="vp_pdf_iframe" title="PDF" style="width:100%; height:100%; border:0;"></iframe>
  </div>

  <div id="vp_text" style="display:none; height:100%; overflow:auto;">
    <pre id="vp_text_pre"
      style="white-space:pre-wrap; word-break:break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; line-height: 1.5; padding: 8px;"></pre>
  </div>

  <div id="vp_json" style="display:none; height:100%; overflow:auto;">
    <pre id="vp_json_pre"
      style="white-space:pre; word-break:normal; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; line-height: 1.5; padding: 8px;"></pre>
  </div>

  <div id="vp_table" style="display:none; height:100%; overflow:auto;">
    <div style="width:100%; overflow:auto;">
      <table id="vp_table_tbl" style="border-collapse: collapse; width:100%; min-width: 520px;">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="vp_sources" style="margin-top:10px;">
    <div id="vp_sources_container"
      style="display:grid; grid-template-columns: repeat( auto-fit, minmax(220px, 1fr) ); gap:10px;"></div>
  </div>
</div>

<script>
  (function () {
    var root = document.getElementById('view_panel_root');
    var viewTabsEl = document.getElementById('view_tabs');
    var splash = document.getElementById('view_panel_splash');
    var vpImage = document.getElementById('vp_image');
    var vpImageImg = document.getElementById('vp_image_img');
    var vpPdf = document.getElementById('vp_pdf');
    var vpPdfIframe = document.getElementById('vp_pdf_iframe');
    var vpText = document.getElementById('vp_text');
    var vpTextPre = document.getElementById('vp_text_pre');
    var vpJson = document.getElementById('vp_json');
    var vpJsonPre = document.getElementById('vp_json_pre');
    var vpTable = document.getElementById('vp_table');
    var vpTableTbl = document.getElementById('vp_table_tbl');
    var vpSources = document.getElementById('vp_sources');
    var vpSourcesContainer = document.getElementById('vp_sources_container');
    // Table incremental rendering state
    var tableState = { headers: [], rows: [], rendered: 0, pageSize: 200, isLoading: false, endReached: false };
    var tableScrollHandler = null;

    // --- Icons helpers (use public/sources-logos files) ---
    function getIconSrcForType(type) {
      var t = String(type || '').toLowerCase();
      function src(name) { return '/static/sources-logos/' + name; }
      if (!t) return src('database.svg');
      if (t.indexOf('folder') !== -1) return src('folder.svg');
      if (t === 'file') return src('file.svg');
      if (t.indexOf('image') !== -1 || t.indexOf('png') !== -1 || t.indexOf('jpg') !== -1 || t.indexOf('jpeg') !== -1) return src('picture.png');
      if (t.indexOf('csv') !== -1) return src('csv.svg');
      if (t.indexOf('xlsx') !== -1) return src('xlsx.svg');
      if (t.indexOf('xls') !== -1) return src('xls.svg');
      if (t.indexOf('excel') !== -1) return src('excel.svg');
      if (t.indexOf('json') !== -1) return src('json.png');
      if (t.indexOf('parquet') !== -1) return src('parquet.svg');
      if (t.indexOf('avro') !== -1) return src('avro.svg');
      if (t.indexOf('s3') !== -1) return src('s3.svg');
      if (t.indexOf('gcs') !== -1) return src('gcs.png');
      if (t.indexOf('azure_blob') !== -1 || t.indexOf('azure-blob') !== -1) return src('azure_blob.svg');
      if (t.indexOf('hdfs') !== -1) return src('hdfs.svg');
      if (t.indexOf('postgres') !== -1) return src('postgresql.svg');
      if (t.indexOf('mysql') !== -1) return src('mysql.svg');
      if (t.indexOf('mssql') !== -1 || t.indexOf('sqlserver') !== -1) return src('mssql.svg');
      if (t.indexOf('sqlite') !== -1) return src('sqlite.svg');
      if (t.indexOf('oracle') !== -1) return src('oracle.svg');
      if (t.indexOf('redshift') !== -1) return src('redshift.png');
      if (t.indexOf('snowflake') !== -1) return src('snowflake.png');
      if (t.indexOf('clickhouse') !== -1) return src('clickhouse.png');
      if (t.indexOf('duckdb') !== -1) return src('duckdb.png');
      if (t.indexOf('databricks') !== -1) return src('databricks.png');
      if (t.indexOf('cassandra') !== -1) return src('cassandra.svg');
      if (t.indexOf('elasticsearch') !== -1) return src('elasticsearch.svg');
      if (t.indexOf('mongodb') !== -1) return src('mongodb.svg');
      if (t.indexOf('cockroach') !== -1) return src('cockroach-db.png');
      if (t.indexOf('yugabyte') !== -1) return src('yugabyte-db.png');
      if (t.indexOf('questdb') !== -1) return src('questdb.png');
      if (t.indexOf('timescale') !== -1) return src('timescale.png');
      if (t.indexOf('alloy') !== -1) return src('alloy-db.png');
      if (t.indexOf('cloud sql') !== -1 || t.indexOf('cloud-sql') !== -1) return src('cloud-sql.png');
      if (t.indexOf('athena') !== -1) return src('amazon-athena.png');
      if (t.indexOf('rds') !== -1) return src('amazon-rds.png');
      if (t.indexOf('bigquery') !== -1) return src('bigquery.png');
      if (t.indexOf('synapse') !== -1) return src('azure-synapse-analytics.png');
      if (t.indexOf('single') !== -1 && t.indexOf('store') !== -1) return src('single-store.png');
      if (t.indexOf('starburst') !== -1) return src('starburst.png');
      if (t.indexOf('teradata') !== -1) return src('teradata.png');
      if (t.indexOf('hana') !== -1 || t.indexOf('sap') !== -1) return src('sap-hana.png');
      if (t.indexOf('sftp') !== -1) return src('sftp.png');
      if (t.indexOf('stream') !== -1) return src('stream.png');
      if (t.indexOf('api') !== -1) return src('api.svg');
      return src('database.svg');
    }
    function iconHtmlForType(type) {
      var src = getIconSrcForType(type);
      var title = String(type || '').toUpperCase();
      return '<img src="' + src + '" alt="' + title.replace(/"/g, '') + '" title="' + title.replace(/"/g, '') + '" style="width:16px;height:16px;object-fit:contain;margin-right:6px;vertical-align:middle;" />';
    }

    function hideAll() {
      [vpImage, vpPdf, vpText, vpJson, vpTable].forEach(function (el) { if (el) el.style.display = 'none'; });
      if (splash) splash.style.display = 'none';
    }

    function toObjectRowsFromItems(items) {
      // items: array of objects -> { headers: string[], rows: string[][] }
      if (!Array.isArray(items) || !items.length) return { headers: [], rows: [] };
      var headers = Object.keys(items[0]);
      var rows = items.map(function (it) { return headers.map(function (h) { var v = it[h]; return v == null ? '' : String(v); }); });
      return { headers: headers, rows: rows };
    }

    function toRowsFromCsv(csv) {
      // naive CSV split (no advanced quoting); acceptable for simple cases
      var lines = String(csv || '').split(/\r?\n/).filter(Boolean);
      var rows = lines.map(function (line) { return line.split(',').map(function (cell) { return cell.trim(); }); });
      var headers = rows.length ? rows[0] : [];
      var body = rows.length > 1 ? rows.slice(1) : [];
      return { headers: headers, rows: body };
    }

    function appendTableRows(count) {
      var tbody = vpTableTbl.querySelector('tbody');
      var start = tableState.rendered;
      var end = Math.min(start + (count != null ? count : tableState.pageSize), tableState.rows.length);
      for (var i = start; i < end; i++) {
        var r = tableState.rows[i];
        var tr = document.createElement('tr');
        r.forEach(function (c) {
          var td = document.createElement('td');
          td.textContent = c == null ? '' : String(c);
          td.style.borderBottom = '1px solid #f3f4f6';
          td.style.padding = '6px 8px';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      tableState.rendered = end;
      if (end >= tableState.rows.length) { tableState.endReached = true; }
    }
    function setupTableIncrementalRendering(data) {
      // Normalize data to headers/rows
      var headers = [];
      var rows = [];
      if (data && Array.isArray(data.headers) && Array.isArray(data.rows)) {
        headers = data.headers; rows = data.rows;
      } else if (data && Array.isArray(data.items)) {
        var obj = toObjectRowsFromItems(data.items);
        headers = obj.headers; rows = obj.rows;
      } else if (data && typeof data.csv === 'string') {
        var parsed = toRowsFromCsv(data.csv);
        headers = parsed.headers; rows = parsed.rows;
      }
      // Reset state
      tableState.headers = headers || [];
      tableState.rows = Array.isArray(rows) ? rows : [];
      tableState.rendered = 0;
      tableState.endReached = false;
      // Build header
      var thead = vpTableTbl.querySelector('thead');
      var tbody = vpTableTbl.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if (tableState.headers.length) {
        var trh = document.createElement('tr');
        tableState.headers.forEach(function (h) {
          var th = document.createElement('th');
          th.textContent = String(h);
          th.style.textAlign = 'left';
          th.style.borderBottom = '1px solid #e5e7eb';
          th.style.padding = '6px 8px';
          th.style.position = 'sticky';
          th.style.top = '0';
          th.style.background = '#ffffff';
          trh.appendChild(th);
        });
        thead.appendChild(trh);
      }
      // Initial 200-row preview
      appendTableRows(tableState.pageSize);
      // Attach scroll listener for infinite scroll
      if (tableScrollHandler && vpTable) { try { vpTable.removeEventListener('scroll', tableScrollHandler); } catch (e) { } }
      tableScrollHandler = function () {
        if (!vpTable || tableState.endReached || tableState.isLoading) return;
        var remaining = (vpTable.scrollHeight - vpTable.scrollTop - vpTable.clientHeight);
        if (remaining < 200) {
          tableState.isLoading = true;
          // Lazy append next chunk after a frame to keep UI responsive
          requestAnimationFrame(function () {
            appendTableRows(tableState.pageSize);
            tableState.isLoading = false;
          });
        }
      };
      if (vpTable) vpTable.addEventListener('scroll', tableScrollHandler);
    }
    function renderTable(data) { setupTableIncrementalRendering(data); }

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch (e) { return String(obj); }
    }

    function setView(conf) {
      conf = conf || {};
      var type = (conf.type || '').toLowerCase();
      hideAll();
      if (type === 'image') {
        var src = conf.src;
        if (conf.file instanceof Blob) { src = URL.createObjectURL(conf.file); }
        if (vpImageImg) vpImageImg.src = src || '';
        if (vpImage) vpImage.style.display = 'block';
        return;
      }
      if (type === 'pdf') {
        var psrc = conf.src;
        if (conf.file instanceof Blob) { psrc = URL.createObjectURL(conf.file); }
        if (vpPdfIframe) vpPdfIframe.src = psrc || '';
        if (vpPdf) vpPdf.style.display = 'block';
        return;
      }
      if (type === 'text') {
        if (vpTextPre) vpTextPre.textContent = conf.text || '';
        if (vpText) vpText.style.display = 'block';
        return;
      }
      if (type === 'json') {
        var raw = conf.data;
        var out = (typeof raw === 'string') ? raw : pretty(raw);
        if (vpJsonPre) vpJsonPre.textContent = out || '';
        if (vpJson) vpJson.style.display = 'block';
        return;
      }
      if (type === 'table') {
        renderTable(conf || {});
        if (vpTable) vpTable.style.display = 'block';
        return;
      }
      // fallback
      if (splash) splash.style.display = 'flex';
    }

    // Expose a simple API to other panels
    function reloadView() { try { renderViewTabs(); loadSources(); loadFromUrl(); } catch (e) { } }
    window.StudioViewPanel = { setView: setView, reload: reloadView };

    function readViewTabs() {
      try { return JSON.parse(sessionStorage.getItem('studio_view_tabs') || '[]'); } catch (e) { return []; }
    }
    function writeViewTabs(list) {
      try { sessionStorage.setItem('studio_view_tabs', JSON.stringify(Array.isArray(list) ? list : [])); } catch (e) { }
    }
    function readViewLabels() {
      try { return JSON.parse(sessionStorage.getItem('studio_view_labels') || '{}'); } catch (e) { return {}; }
    }
    function writeViewLabels(map) {
      try { sessionStorage.setItem('studio_view_labels', JSON.stringify(map || {})); } catch (e) { }
    }
    function readViewTypes() {
      try { return JSON.parse(sessionStorage.getItem('studio_view_types') || '{}'); } catch (e) { return {}; }
    }
    function writeViewTypes(map) {
      try { sessionStorage.setItem('studio_view_types', JSON.stringify(map || {})); } catch (e) { }
    }
    function currentSourceId() { try { return new URLSearchParams(window.location.search).get('source_id') || ''; } catch (e) { return ''; } }
    function ensureViewTab(id) {
      if (!id) return;
      var tabs = readViewTabs();
      if (tabs.indexOf(id) === -1) { tabs.unshift(id); writeViewTabs(tabs); }
      renderViewTabs();
    }
    function renderViewTabs() {
      var root = viewTabsEl; if (!root) return;
      root.innerHTML = '';
      // Plus button on the left: unset source_id and open/focus sources list
      var plus = document.createElement('button');
      plus.title = 'Ouvrir la liste des sources';
      plus.textContent = '+';
      plus.style.cssText = 'border:1px solid #e5e7eb; background:#ffffff; color:#374151; padding:4px 8px; border-radius:6px; cursor:pointer;';
      plus.addEventListener('click', function () {
        try {
          // Unset source_id in URL
          var p = new URLSearchParams(window.location.search);
          p.delete('source_id');
          var newUrl = window.location.pathname + (p.toString() ? ('?' + p.toString()) : '');
          window.history.replaceState({}, '', newUrl);
          // Hide any current preview
          hideAll();
          // Show sources list
          if (vpSources) { vpSources.style.display = 'block'; }
          // Scroll and highlight briefly
          if (vpSources) {
            vpSources.scrollIntoView({ behavior: 'smooth', block: 'start' });
            var prev = vpSources.style.boxShadow;
            vpSources.style.boxShadow = '0 0 0 2px rgba(65,105,225,0.35)';
            setTimeout(function () { vpSources.style.boxShadow = prev || ''; }, 1200);
          }
          renderViewTabs();
          loadSources();
        } catch (e) { }
      });
      root.appendChild(plus);
      // (project clear UI removed; handled in context-panel)
      // Tabs for recently viewed sources
      var tabs = readViewTabs();
      var selectedId = currentSourceId();
      var labels = readViewLabels();
      var types = readViewTypes();
      function removeViewTab(id) {
        var list = readViewTabs().filter(function (t) { return t !== id; });
        writeViewTabs(list);
        if (id === selectedId) {
          if (list.length) {
            var p = new URLSearchParams(window.location.search);
            p.set('source_id', list[0]);
            var newUrl = window.location.pathname + '?' + p.toString();
            window.history.replaceState({}, '', newUrl);
            loadSources();
            loadFromUrl();
          } else {
            var p2 = new URLSearchParams(window.location.search);
            p2.delete('source_id');
            var newUrl2 = window.location.pathname + (p2.toString() ? ('?' + p2.toString()) : '');
            window.history.replaceState({}, '', newUrl2);
            loadSources();
            loadFromUrl();
          }
        }
        renderViewTabs();
      }
      tabs.forEach(function (id) {
        var container = document.createElement('div');
        container.style.cssText = 'display:inline-flex; align-items:center; gap:4px; border:1px solid #e5e7eb; background:' + (id === selectedId ? '#eef2ff' : '#ffffff') + '; color:#111827; padding:2px 4px; border-radius:6px; white-space:nowrap;';
        var labelBtn = document.createElement('button');
        var label = (labels && labels[id]) ? String(labels[id]) : ('Source ' + id);
        var typeForId = (types && types[id]) ? String(types[id]) : '';
        var icon = iconHtmlForType(typeForId);
        labelBtn.innerHTML = icon + '<span>' + label.replace(/</g, '&lt;') + '</span>';
        labelBtn.title = label;
        labelBtn.style.cssText = 'background:transparent; border:0; color:inherit; padding:2px 4px; cursor:pointer;';
        labelBtn.addEventListener('click', function () {
          var p = new URLSearchParams(window.location.search);
          p.set('source_id', id);
          var newUrl = window.location.pathname + '?' + p.toString();
          window.history.replaceState({}, '', newUrl);
          loadSources();
          loadFromUrl();
          renderViewTabs();
        });
        var closeBtn = document.createElement('button');
        closeBtn.textContent = '×';
        closeBtn.title = 'Fermer';
        closeBtn.style.cssText = 'background:transparent; border:0; color:#6b7280; padding:2px 4px; cursor:pointer;';
        closeBtn.addEventListener('click', function (ev) { ev.stopPropagation(); removeViewTab(id); });
        container.appendChild(labelBtn);
        container.appendChild(closeBtn);
        root.appendChild(container);
      });
    }

    function readUrlParam(key) { try { return new URLSearchParams(window.location.search).get(key) || ''; } catch (e) { return ''; } }
    function showError(message) {
      try {
        hideAll();
        var err = document.getElementById('vp_error');
        if (err) { err.textContent = String(message || 'Error'); err.style.display = 'block'; }
        if (vpText) vpText.style.display = 'none';
      } catch (e) { /* noop */ }
    }
    async function loadFromUrl() {
      var srcId = readUrlParam('source_id');
      // Hide sources list if a source is selected
      try { if (vpSources) vpSources.style.display = srcId ? 'none' : 'block'; } catch (e) { }
      if (!srcId) { try { hideAll(); } catch (e) { } return; }
      try {
        // Always fetch full preview; render 200 rows first, then lazy-load more client-side
        var url = '/sources/preview?source_id=' + encodeURIComponent(srcId) + '&verbose=1';
        console.log('[ViewPanel] fetching preview:', url);
        var r = await fetch(url);
        var j = await r.json();
        if (j && j.ok && j.view) {
          var err = document.getElementById('vp_error'); if (err) { err.style.display = 'none'; err.textContent = ''; }
          if (j.debug) console.log('[ViewPanel] debug:', j.debug);
          setView(j.view);
          ensureViewTab(srcId);
        } else {
          console.warn('[ViewPanel] preview error:', j);
          showError((j && (j.message || j.error && (j.error.detail || j.error.message))) || 'Preview failed');
        }
      } catch (e) {
        console.error('[ViewPanel] preview request failed', e);
        showError('Preview request failed');
      }
    }
    function normalizeSources(j) {
      try {
        if (!j) return [];
        if (Array.isArray(j)) return j;
        if (Array.isArray(j.items)) return j.items;
        if (Array.isArray(j.data)) return j.data;
        if (Array.isArray(j.results)) return j.results;
        if (j.data && Array.isArray(j.data.items)) return j.data.items;
        if (Array.isArray(j.sources)) return j.sources;
        if (typeof j === 'object' && (j.id != null || j.name != null)) return [j];
      } catch (e) { }
      return [];
    }
    function renderSources(items) {
      var root = vpSourcesContainer; if (!root) return;
      root.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        var e = document.createElement('div');
        e.className = 'muted';
        e.textContent = 'No sources';
        root.appendChild(e);
        return;
      }
      var params = new URLSearchParams(window.location.search);
      var selectedId = params.get('source_id');
      items.forEach(function (it) {
        var id = String(it.id || it.source_id || '');
        var name = it.name || (it.source && it.source.name) || ('Source ' + id);
        var type = it.type || (it.source && it.source.type) || '';
        var localPresent = !!it.local_present;
        var localValidate = (it.local_validate || '').toLowerCase();
        var isInvalid = localValidate && localValidate !== 'valid';
        var disabled = (!localPresent) || isInvalid;
        var hoverMsg = '';
        if (!localPresent) {
          hoverMsg = 'Configuration de la source non disponible localement';
        } else if (isInvalid) {
          hoverMsg = 'Source non accéssible';
        }
        var card = document.createElement('div');
        card.className = 'card';
        card.style.cursor = disabled ? 'not-allowed' : 'pointer';
        card.style.padding = '8px 10px';
        card.style.border = '1px solid #e5e7eb';
        card.style.borderRadius = '8px';
        card.style.background = '#ffffff';
        if (hoverMsg) card.title = hoverMsg;
        if (disabled) {
          card.style.opacity = '0.5';
          card.style.filter = 'grayscale(100%)';
        }
        var icon = iconHtmlForType(type);
        card.innerHTML = '<div style="font-weight:600; color:#111827; display:flex; align-items:center; gap:6px;">' + icon + '<span>' + name.replace(/</g, '&lt;') + '</span></div>' +
          '<div class="muted" style="font-size:12px;">' + (type ? ('Type: ' + type) : '') + '</div>' +
          '<div class="muted" style="font-size:12px;">#' + id + '</div>';
        if (selectedId && id === selectedId) {
          card.style.boxShadow = '0 0 0 2px rgba(65,105,225,0.35)';
        }
        if (!disabled) {
          card.addEventListener('click', function () {
            var p = new URLSearchParams(window.location.search);
            p.set('source_id', id);
            var newUrl = window.location.pathname + '?' + p.toString();
            window.history.replaceState({}, '', newUrl);
            renderSources(items);
            loadFromUrl();
          });
        }
        root.appendChild(card);
      });
    }
    async function loadSources() {
      try {
        var projectId = readUrlParam('project_id');
        var url = '/studio/sources' + (projectId ? ('?project_id=' + encodeURIComponent(projectId)) : '');
        var r = await fetch(url);
        var j = await r.json();
        var items = normalizeSources(j && (j.items != null ? j.items : j));
        // Extra client-side filter by project_id as a safeguard
        if (projectId) {
          items = items.filter(function (it) {
            try {
              var pid = it.project_id != null ? String(it.project_id) : (it.project && it.project.id != null ? String(it.project.id) : '');
              return pid ? (pid === String(projectId)) : true;
            } catch (e) { return true; }
          });
        }
        // Build and cache labels map for view tabs
        try {
          var labelsMap = readViewLabels();
          var typesMap = readViewTypes();
          items.forEach(function (it) {
            var id = String(it.id || it.source_id || '');
            var name = it.name || (it.source && it.source.name) || ('Source ' + id);
            var type = it.type || (it.source && it.source.type) || '';
            if (id) labelsMap[id] = String(name);
            if (id) typesMap[id] = String(type);
          });
          writeViewLabels(labelsMap);
          writeViewTypes(typesMap);
          // Re-render tabs to reflect labels instead of IDs
          try { renderViewTabs(); } catch (e) { }
        } catch (e) { }
        renderSources(items);
      } catch (e) {
        renderSources([]);
      }
    }
    document.addEventListener('DOMContentLoaded', function () { renderViewTabs(); loadSources(); loadFromUrl(); });
    window.addEventListener('popstate', function () { renderViewTabs(); loadSources(); loadFromUrl(); });
    // React to project/issue changes from context-panel by listening to our own dispatched popstate
  })();
</script>