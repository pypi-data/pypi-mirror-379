<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QALITA CLI - Dashboard</title>
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>

<body style="background-repeat: no-repeat;">
  {% include 'navbar.html' %}

  <div class="container" style="margin-top: 0;">
    <div class="grid equal-3" style="margin-bottom: 24px;">
      {% if platform_url %}
      <div>
        <div class="platform-cta">
          <div class="noise"></div>
          <div class="inner">
            <div class="header">
              <div class="title">
                <h3>Platform</h3>
              </div>
              <img src="/static/platform.png" alt="Logo Platform" width="35" height="35"
                style="border-radius:8px;background:#fff;" />
            </div>
            <p>Collaborate, monitor and ensure the quality of your data assets. With Platform, you can manage your data
              and projects in one place.</p>
            <div>
              <a href="{{ platform_url }}"><button class="btn cyan" type="button"
                  style="width:100%;padding:12px 16px;">Go to
                  Platform</button></a>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div>
        <div class="platform-cta">
          <div class="noise"></div>
          <div class="inner">
            <div class="header">
              <div class="title">
                <h3>Platform</h3>
              </div>
              <img src="/static/platform.png" alt="Logo Platform" width="35" height="35"
                style="border-radius:8px;background:#fff;" />
            </div>
            <p>Collaborate, monitor and ensure the quality of your data assets. Create a free account to access Platform.</p>
            <div>
              <a href="https://cloud.platform.qalita.io/signup" target="_blank" rel="noopener noreferrer"><button
                  class="btn cyan" type="button" style="width:100%;padding:12px 16px;">Create a free
                  account</button></a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      <div>
        <div class="studio-cta">
          <div class="noise"></div>
          <div class="inner">
            <div class="header">
              <div class="title">
                <h3>Studio</h3>
                <span class="badge">Alpha 0</span>
              </div>
              <img src="/static/studio.png" alt="Logo Studio" width="35" height="35"
                style="border-radius:8px;background:#fff;" />
            </div>
            <p>Clean and improve your data at the speed of light. With Studio, take your data to the next level by
              creating clean and corrected versions of your datasets.
            </p>
            <div>
              <a href="/studio"><button class="btn blue" type="button" style="width:100%;padding:12px 16px;">Go to
                  Studio</button></a>
            </div>
          </div>
        </div>
      </div>
      <div class="documentation-cta">
        <div class="noise"></div>
        <div class="inner">
          <div class="header">
            <div class="title">
              <h3>Documentation</h3>
            </div>
          </div>
          <p>Learn how to use QALITA and its features.</p>
          <div>
            <a href="https://doc.qalita.io" target="_blank" rel="noopener noreferrer"><button class="btn black-white"
                type="button" style="width:100%;padding:12px 16px;">QALITA Docs</button></a>
          </div>
        </div>
      </div>
    </div>
    {% if feedback %}
    <div class="alert {{ 'alert-error' if feedback_level == 'error' else 'alert-info' }}" style="margin-bottom:12px;">{{
      feedback }}</div>
    {% endif %}
    <div class="grid">
      <div>
        <div style="display:flex;align-items:center; gap:12px;">
          <h2>Sources</h2>
          <div class="actions mb-12">
            <a class="btn" href="/sources/add">Add source</a>
            <form class="inline" method="post" action="/validate" style="display:inline;">
              <button class="btn secondary" type="submit">Validate</button>
            </form>
            <form class="inline" method="post" action="/push" style="display:inline;">
              <button class="btn secondary" type="submit">Push</button>
            </form>
          </div>
        </div>
        <div class="card">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Visibility</th>
                <th>Check</th>
              </tr>
            </thead>
            <tbody>
              {% for s in sources %}
              {% set icon_map = {
              'file':'file.svg', 'csv':'csv.svg', 'excel':'excel.svg', 'folder':'folder.svg',
              'postgresql':'postgresql.svg', 'mysql':'mysql.svg',
              'oracle':'oracle.svg', 'mssql':'mssql.svg',
              'sqlite':'sqlite.svg', 'mongodb':'mongodb.svg', 's3':'s3.svg', 'gcs':'gcs.png',
              'azure_blob':'azure_blob.svg', 'hdfs':'hdfs.svg',
              } %}
              {% set type_icon = icon_map.get(s.type, 'folder.svg') %}
              <tr>
                <td>
                  {% set _id = s.get('id') %}
                  {% if _id and platform_url %}
                  <a href="{{ platform_url.rstrip('/') }}/home/data-engineering/sources/{{ _id }}" target="_blank"
                    rel="noopener noreferrer">{{ s.name }}</a>
                  {% else %}
                  {{ s.name }}
                  {% endif %}
                  {% if s.description %}
                  <div class="subtle">{{ s.description }}</div>
                  {% endif %}
                </td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <img src="/static/sources-logos/{{ type_icon }}" alt="{{ s.type }}"
                      style="height:20px;max-width:30px;border-radius:4px;" />
                    <span>{{ s.type }}</span>
                  </div>
                </td>
                {% set vis = (s.visibility or '')|lower %}
                <td>
                  {% if vis == 'private' %}
                  <span title="private" class="badge badge-private">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="9" width="14" height="8" rx="2" stroke="#374151" stroke-width="2" />
                      <path d="M6 9V7a4 4 0 1 1 8 0v2" stroke="#374151" stroke-width="2" fill="none" />
                    </svg>
                    Private
                  </span>
                  {% elif vis == 'internal' %}
                  <span title="internal" class="badge badge-internal">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="6" width="14" height="10" rx="2" stroke="#0ea5e9" stroke-width="2" />
                      <path d="M7 6V4h6v2" stroke="#0ea5e9" stroke-width="2" />
                    </svg>
                    Internal
                  </span>
                  {% elif vis == 'public' %}
                  <span title="public" class="badge badge-public">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="10" cy="10" r="8" stroke="#16a34a" stroke-width="2" />
                      <path d="M2 10h16M10 2a12 12 0 0 1 0 16M10 2a12 12 0 0 0 0 16" stroke="#16a34a"
                        stroke-width="2" />
                    </svg>
                    Public
                  </span>
                  {% else %}
                  <span class="muted">{{ s.visibility }}</span>
                  {% endif %}
                </td>
                {% set val = (s.validate or '')|lower %}
                <td>
                  {% if val == 'valid' %}
                  <span title="valid" class="badge badge-valid">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="10" cy="10" r="9" stroke="#059669" stroke-width="2" />
                      <path d="M6 10.5l2.5 2.5L14 7.5" stroke="#059669" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Reachable
                  </span>
                  {% elif val == 'invalid' %}
                  <span title="invalid" class="badge badge-invalid">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="10" cy="10" r="9" stroke="#b91c1c" stroke-width="2" />
                      <path d="M7 7l6 6M13 7l-6 6" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Unreachable
                  </span>
                  {% else %}
                  <span class="muted">{{ s.validate or '' }}</span>
                  {% endif %}
                </td>
                <td class="muted"></td>
                <td>
                  <div class="actions">
                    <a class="btn secondary" href="/sources/edit/{{ s.name }}">Edit</a>
                    <form class="inline" method="post" action="/sources/delete/{{ s.name }}"
                      onsubmit="return confirm('Delete this source?');" style="display:inline;">
                      <button class="btn danger" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <div style="display:flex;align-items:center; gap: 10px;">
          <h2>Agent</h2>
          <div style="display:flex;gap:20px;align-items:center;">
            <div id="agent_switch"
              style="margin-top: -11px; position:relative;width:46px;height:26px;background:#e5e7eb;border-radius:9999px;cursor:pointer;display:inline-block;transition:background .15s ease;">
              <div id="agent_knob"
                style="position:absolute;top:3px;left:3px;width:20px;height:20px;background:#ffffff;border-radius:35%;box-shadow:0 1px 3px rgba(0,0,0,.2);transition:left .15s ease;">
              </div>
            </div>
            <input id="agent_toggle" type="checkbox" class="hidden" />
            <span id="agent_state" class="muted" style="margin-top: -13px;"></span>
          </div>
        </div>
        <div class="card" style="margin-bottom: 24px;">
          {% if agent_conf %}
          <div style="display:grid;grid-template-columns: 160px 1fr;row-gap:8px;column-gap:12px;">
            <div class="muted">Name</div>
            <div data-agent-name>
              {% if platform_url %}
              <a href="{{ platform_url.rstrip('/') }}/home/data-engineering/agents/?agent={{ agent_conf.get('name','') }}"
                target="_blank" rel="noopener noreferrer">{{ agent_conf.get('name','') }}</a>
              {% else %}
              {{ agent_conf.get('name','') }}
              {% endif %}
            </div>
            <div class="muted">Mode</div>
            <div data-agent-mode>{{ agent_conf.get('mode','') }}</div>
            <div class="muted">Backend URL</div>
            <div data-agent-url><a href="{{ agent_conf.get('url','') }}" target="_blank" rel="noopener noreferrer">{{
                agent_conf.get('url','') }}</a></div>
            <div class="muted">Agent ID</div>
            <div data-agent-id>{{ agent_conf.get('agent_id','') }}</div>
          </div>
          <div style="margin-top:12px;">
            <div class="muted" style="margin-bottom:6px;">Agent Runs</div>
            {% set list_runs = agent_runs_page if agent_runs_page is defined else (agent_runs[:10] if agent_runs is
            defined else []) %}
            {% if list_runs and list_runs|length > 0 %}
            <ul style="margin:0;padding-left:18px;">
              {% for r in list_runs %}
              <li><span class="muted">{{ r.when }}</span> —
                <code><a href="/agent/run/{{ r.name }}" target="_blank" rel="noopener noreferrer">{{ r.name }}</a></code>
              </li>
              {% endfor %}
            </ul>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
              <div class="muted">
                {% if runs_start is defined and runs_end is defined and runs_total is defined %}
                Showing {{ runs_start }}–{{ runs_end }} of {{ runs_total }}
                {% else %}
                Showing {{ (list_runs|length) }} recent run(s)
                {% endif %}
              </div>
              <div class="actions" style="display:flex;gap:8px;">
                {% set cur_page = runs_page if runs_page is defined else 1 %}
                {% set per_page = runs_per_page if runs_per_page is defined else 10 %}
                {% if runs_has_prev %}
                <a class="btn secondary" href="/?runs_page={{ cur_page - 1 }}&runs_per_page={{ per_page }}">Prev</a>
                {% else %}
                <button class="btn secondary" disabled>Prev</button>
                {% endif %}
                {% if runs_has_next %}
                <a class="btn secondary" href="/?runs_page={{ cur_page + 1 }}&runs_per_page={{ per_page }}">Next</a>
                {% else %}
                <button class="btn secondary" disabled>Next</button>
                {% endif %}
              </div>
            </div>
            {% else %}
            <div class="muted">No runs found.</div>
            {% endif %}
          </div>
          {% else %}
          <div class="muted">No agent configuration found. Use "qalita agent login" to configure.</div>
          {% endif %}
        </div>
        {% if platform_url %}
        <h2>Pack</h2>
        <div class="card" style="margin-bottom: 24px;">
          <form method="post" action="/pack/push">
            <label for="pack_dir">Pack folder</label>
            <div class="row" style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;">
              <input id="pack_dir" name="pack_dir" type="text" placeholder="/path/to/your_pack" />
              <button type="button" class="btn secondary" style="margin-top: 5px;" id="browse_pack">Browse…</button>
            </div>
            <div class="actions" style="margin-top:12px;">
              <button class="btn" type="submit">Push Pack</button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="inner">
      <div>
        <span>&copy; QALITA</span> — QALITA CLI
      </div>
      <div>
        <span id="cli_version"></span>
      </div>
    </div>
  </div>
  <script>
    (function () {
      fetch('/static/version.json').then(r => r.json()).then(v => {
        const el = document.getElementById('cli_version'); if (el) { el.textContent = (v && v.version) ? `CLI v${v.version}` : ''; }
      }).catch(() => { });
    })();
    (function () {
      function pickFolder() {
        fetch('/sources/pick-folder').then(r => r.json()).then(j => {
          if (j && j.path) { var inp = document.getElementById('pack_dir'); if (inp) { inp.value = j.path; } }
        }).catch(() => { });
      }
      var btn = document.getElementById('browse_pack'); if (btn) { btn.addEventListener('click', pickFolder); }
    })();
    (function () {
      const toggle = document.getElementById('agent_toggle');
      const label = document.getElementById('agent_state');
      const sw = document.getElementById('agent_switch');
      const knob = document.getElementById('agent_knob');
      if (!toggle) return;
      function refresh() {
        fetch('/agent/status').then(r => r.json()).then(j => {
          const running = !!(j && j.running);
          toggle.checked = running;
          if (label) { label.textContent = running ? '(running)' : '(stopped)'; }
          if (sw) { sw.style.background = running ? '#16a34a' : '#e5e7eb'; }
          if (knob) { knob.style.left = running ? '23px' : '3px'; }
        }).catch(() => { if (label) { label.textContent = '(unknown)'; } });
      }
      function setState(isOn) {
        fetch(isOn ? '/agent/start' : '/agent/stop', { method: 'POST' })
          .then(() => refresh())
          .catch(() => refresh());
      }
      toggle.addEventListener('change', function () { setState(toggle.checked); });
      if (sw) { sw.addEventListener('click', function () { toggle.checked = !toggle.checked; setState(toggle.checked); }); }
      refresh();
    })();
  </script>
</body>

</html>