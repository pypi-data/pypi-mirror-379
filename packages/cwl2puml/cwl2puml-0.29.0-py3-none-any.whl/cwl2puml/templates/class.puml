/'
 ' Diagram generated by cwl2puml v{{ version }}
 ' timestamp: {{ timestamp }}
 '/
@startuml

{% macro serialize_enum(id, symbols) %}
enum {{ id }} {
    {% for symbol in symbols %}
    {{ symbol.split('/')[-1] }}
    {% endfor %}
}
{%- endmacro %}

{% macro serialize_process(process) -%}
    +class "{{ process.id }}" as {{ process.class_ }}_{{ process.id | to_puml_name }} extends {{ process.class_ }} {
        __ Inputs __
        {% for input in process.inputs %}
            {% if not input.type_.symbols %}
        + {{ input.id }}: {{ input.type_ | type_to_string }}{% if input.default %} = {{ input.default }}{% endif %}
            {% endif %}
        {% endfor %}

        __ Outputs __
        {% for output in process.outputs %}
        + {{ output.id }}: {{ output.type_ | type_to_string }}
        {% endfor %}

        {% if process.steps %}
        __ Steps __
            {% for step in process.steps %}
        - {{ step.id }}: {{ step.run[1:] | to_puml_name }}
            {% endfor %}
        {% endif %}
    }

    {% for input in process.inputs %}
        {% if input.type_.symbols %}
    enum {{ input.id }} {
            {% for symbol in input.type_.symbols %}
        {{ symbol.split('/')[-1] }}
            {% endfor %}
    }
    {{ process.class_ }}_{{ process.id | to_puml_name }} -> {{ input.id }}
        {% endif %}
    {% endfor %}
{%- endmacro %}

{% macro serialize_workflow(workflow) -%}
package "{% if workflow.doc %}{{ workflow.doc }}{% elif workflow.label %}{{ workflow.label }}{% else %}{{ workflow.id }}{% endif %}" {

    {{ serialize_process(workflow) }}

    {% if workflow.steps %}
    package "Steps" {
        {% for step in workflow.steps %}
            {% set process = index.get(step.run[1:]) %}

            {% if process %}
                {% if 'Workflow' == process.class_ %}
                    {{ serialize_workflow(process) }}
                {% else %}
                    {{ serialize_process(process) }}
                {% endif %}
{{ workflow.class_ }}_{{ workflow.id | to_puml_name }} --> {{ process.class_ }}_{{ process.id | to_puml_name }}
            {% else %}
' [WARNING] {{ workflow.class_ }}_{{ workflow.id | to_puml_name }} --> {{ step.run[1:] }} : None
            {% endif %}
        {% endfor %}
    }
    {% endif %}

    {% if workflow.requirements %}
    package "Requirements" {
        {% for requirement in workflow.requirements %}
            {% if requirement.class_ %}
        class {{ requirement.class_ }}
        {{ workflow.class_ }}_{{ workflow.id | to_puml_name }} --> {{ requirement.class_ }}
            {% endif %}
        {% endfor %}
    }
    {% endif %}

    {% if workflow.hints %}
    package "Hints" {
        {% for hint in workflow.hints %}
            {% if hint.class_ %}
    {{ workflow.class_ }}_{{ workflow.id | to_puml_name }} --> {{ hint.class_ }}
            {% endif %}
        {% endfor %}
    }
    {% endif %}
}
{%- endmacro %}

{% set process = index.get(workflow_id) %}
{% if 'Workflow' == process.class_ %}
    {{ serialize_workflow(process) }}
{% endif %}
