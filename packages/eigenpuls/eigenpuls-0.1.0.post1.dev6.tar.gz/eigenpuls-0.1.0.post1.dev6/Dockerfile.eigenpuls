FROM python:3.12-slim AS build
WORKDIR /app
COPY eigenpuls.yaml /app/eigenpuls.yaml
RUN pip install --upgrade pip && pip install eigenpuls==X.Y.Z
RUN EIGENPULS_CONFIG=/app/eigenpuls.yaml python -m eigenpuls packages --type apt > /app/.apt.txt

FROM python:3.12-slim
ENV DEBIAN_FRONTEND=noninteractive
COPY --from=build /app/.apt.txt /app/.apt.txt
RUN apt-get update && xargs -r apt-get install -y --no-install-recommends < /app/.apt.txt && rm -rf /var/lib/apt/lists/*
RUN pip install --no-cache-dir eigenpuls==X.Y.Z
WORKDIR /app
COPY eigenpuls.yaml /app/eigenpuls.yaml
ENV EIGENPULS_CONFIG=/app/eigenpuls.yaml
EXPOSE 4242
CMD ["python", "-m", "eigenpuls", "serve", "-c", "/app/eigenpuls.yaml"]