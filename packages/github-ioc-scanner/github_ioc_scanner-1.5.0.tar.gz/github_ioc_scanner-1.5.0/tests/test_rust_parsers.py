"""Tests for Rust package manager parsers."""

import pytest
from src.github_ioc_scanner.parsers.rust import CargoLockParser
from src.github_ioc_scanner.models import PackageDependency


class TestCargoLockParser:
    """Test cases for CargoLockParser."""
    
    def setup_method(self):
        """Set up test fixtures."""
        self.parser = CargoLockParser()
    
    def test_can_parse_cargo_lock(self):
        """Test that parser correctly identifies Cargo.lock files."""
        assert self.parser.can_parse('Cargo.lock')
        assert self.parser.can_parse('path/to/Cargo.lock')
        assert self.parser.can_parse('/absolute/path/Cargo.lock')
        
        # Should not parse other files
        assert not self.parser.can_parse('Cargo.toml')
        assert not self.parser.can_parse('cargo.lock')
        assert not self.parser.can_parse('package.json')
        assert not self.parser.can_parse('go.mod')
    
    def test_parse_basic_cargo_lock(self):
        """Test parsing a basic Cargo.lock file."""
        content = """# This file is automatically @generated by Cargo.
# It is not intended for manual editing.
version = 3

[[package]]
name = "serde"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"

[[package]]
name = "tokio"
version = "1.21.2"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a9e03c497dc955702ba729190dc4aac6f2a0ce97f913e5b1b5912fc5039d9099"

[[package]]
name = "clap"
version = "4.0.26"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "2148adefda54e4919b4e4c7a6c69a4d83c0d8121ade233b9d6b6c9f8d5e600c"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='serde', version='1.0.147', dependency_type='dependencies'),
            PackageDependency(name='tokio', version='1.21.2', dependency_type='dependencies'),
            PackageDependency(name='clap', version='4.0.26', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 3
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_cargo_lock_with_dependencies(self):
        """Test parsing Cargo.lock with package dependencies."""
        content = """version = 3

[[package]]
name = "tokio"
version = "1.21.2"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a9e03c497dc955702ba729190dc4aac6f2a0ce97f913e5b1b5912fc5039d9099"
dependencies = [
    "bytes",
    "libc",
    "memchr",
    "mio",
    "num_cpus",
    "once_cell",
]

[[package]]
name = "bytes"
version = "1.2.1"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "ec8a7b6a70fde80372154c65702f00a0f56f3e1c36d4fdd2e9d0a5de1f445e7"

[[package]]
name = "libc"
version = "0.2.135"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "68783febc7782c6c5cb401fbda4de5a9898be1762314da0bb2c10ced61f18b0c"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='tokio', version='1.21.2', dependency_type='dependencies'),
            PackageDependency(name='bytes', version='1.2.1', dependency_type='dependencies'),
            PackageDependency(name='libc', version='0.2.135', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 3
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_cargo_lock_with_prerelease_versions(self):
        """Test parsing Cargo.lock with prerelease versions."""
        content = """version = 3

[[package]]
name = "serde"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"

[[package]]
name = "tokio"
version = "1.22.0-alpha.1"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a9e03c497dc955702ba729190dc4aac6f2a0ce97f913e5b1b5912fc5039d9099"

[[package]]
name = "experimental-crate"
version = "0.1.0-beta.2"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "2148adefda54e4919b4e4c7a6c69a4d83c0d8121ade233b9d6b6c9f8d5e600c"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='serde', version='1.0.147', dependency_type='dependencies'),
            PackageDependency(name='tokio', version='1.22.0-alpha.1', dependency_type='dependencies'),
            PackageDependency(name='experimental-crate', version='0.1.0-beta.2', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 3
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_cargo_lock_with_git_dependencies(self):
        """Test parsing Cargo.lock with git dependencies."""
        content = """version = 3

[[package]]
name = "serde"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"

[[package]]
name = "my-git-crate"
version = "0.1.0"
source = "git+https://github.com/user/my-git-crate.git#abc123def456"

[[package]]
name = "another-git-crate"
version = "0.2.0"
source = "git+https://github.com/user/another-git-crate.git?branch=main#def456abc123"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='serde', version='1.0.147', dependency_type='dependencies'),
            PackageDependency(name='my-git-crate', version='0.1.0', dependency_type='dependencies'),
            PackageDependency(name='another-git-crate', version='0.2.0', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 3
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_cargo_lock_with_path_dependencies(self):
        """Test parsing Cargo.lock with path dependencies."""
        content = """version = 3

[[package]]
name = "serde"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"

[[package]]
name = "my-local-crate"
version = "0.1.0"

[[package]]
name = "another-local-crate"
version = "0.2.0"
source = "path+file:///path/to/crate"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='serde', version='1.0.147', dependency_type='dependencies'),
            PackageDependency(name='my-local-crate', version='0.1.0', dependency_type='dependencies'),
            PackageDependency(name='another-local-crate', version='0.2.0', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 3
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_cargo_lock_with_complex_crate_names(self):
        """Test parsing crates with complex names (underscores, hyphens)."""
        content = """version = 3

[[package]]
name = "serde_json"
version = "1.0.87"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "6ce777b7b150d76b9cf60d28b55f5847135a003f7d7350c6be7a773508ce7d45"

[[package]]
name = "clap-derive"
version = "4.0.21"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "0177313f9f02afc995627906bbd8967e2be069f5261954222dac78290c2b9014"

[[package]]
name = "proc-macro2"
version = "1.0.47"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "5ea3d908b0e36316caf9e9e2c4625cdde190a7e6f440d794667ed17a9b86c5a8"

[[package]]
name = "quote"
version = "1.0.21"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "bbe448f377a7d6961e30f5955f9b8d106c3f5e449d493ee1b125c1d43c2b5179"
"""
        
        dependencies = self.parser.parse(content)
        
        expected_deps = [
            PackageDependency(name='serde_json', version='1.0.87', dependency_type='dependencies'),
            PackageDependency(name='clap-derive', version='4.0.21', dependency_type='dependencies'),
            PackageDependency(name='proc-macro2', version='1.0.47', dependency_type='dependencies'),
            PackageDependency(name='quote', version='1.0.21', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 4
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_empty_cargo_lock(self):
        """Test parsing an empty or minimal Cargo.lock file."""
        content = """# This file is automatically @generated by Cargo.
# It is not intended for manual editing.
version = 3
"""
        
        dependencies = self.parser.parse(content)
        assert len(dependencies) == 0
    
    def test_parse_cargo_lock_without_packages(self):
        """Test parsing Cargo.lock without package sections."""
        content = """version = 3

[metadata]
"checksum serde 1.0.147" = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"
"""
        
        dependencies = self.parser.parse(content)
        assert len(dependencies) == 0
    
    def test_parse_cargo_lock_with_incomplete_packages(self):
        """Test parsing Cargo.lock with incomplete package information."""
        content = """version = 3

[[package]]
name = "complete-package"
version = "1.0.0"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"

[[package]]
name = "missing-version-package"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a9e03c497dc955702ba729190dc4aac6f2a0ce97f913e5b1b5912fc5039d9099"

[[package]]
version = "2.0.0"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "2148adefda54e4919b4e4c7a6c69a4d83c0d8121ade233b9d6b6c9f8d5e600c"

[[package]]
name = "another-complete"
version = "3.0.0"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "xyz789abc123"
"""
        
        dependencies = self.parser.parse(content)
        
        # Should only parse packages with both name and version
        expected_deps = [
            PackageDependency(name='complete-package', version='1.0.0', dependency_type='dependencies'),
            PackageDependency(name='another-complete', version='3.0.0', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 2
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_malformed_cargo_lock(self):
        """Test parsing malformed Cargo.lock content."""
        # Invalid TOML
        with pytest.raises(ValueError, match="Invalid TOML in Cargo.lock"):
            self.parser.parse('[[package]\nname = "invalid toml"')
        
        # Invalid TOML that would parse as array (but TOML doesn't support top-level arrays)
        with pytest.raises(ValueError, match="Invalid TOML in Cargo.lock"):
            self.parser.parse('["not", "an", "object"]')
        
        # Invalid TOML that would parse as string (but TOML doesn't support top-level strings)
        with pytest.raises(ValueError, match="Invalid TOML in Cargo.lock"):
            self.parser.parse('"just a string"')
    
    def test_parse_cargo_lock_with_invalid_package_data(self):
        """Test parsing Cargo.lock with invalid package data."""
        content = """version = 3

package = [
    "not an object",
    { name = "valid-package", version = "1.0.0" },
    { name = "another-valid", version = "2.0.0" }
]
"""
        
        dependencies = self.parser.parse(content)
        
        # Should only parse valid package objects
        expected_deps = [
            PackageDependency(name='valid-package', version='1.0.0', dependency_type='dependencies'),
            PackageDependency(name='another-valid', version='2.0.0', dependency_type='dependencies'),
        ]
        
        assert len(dependencies) == 2
        for expected_dep in expected_deps:
            assert expected_dep in dependencies
    
    def test_parse_real_world_cargo_lock(self):
        """Test parsing a real-world Cargo.lock example."""
        content = """# This file is automatically @generated by Cargo.
# It is not intended for manual editing.
version = 3

[[package]]
name = "anyhow"
version = "1.0.66"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "216261ddc8289130e551ddcd5ce8a064710c0d064a4d2895c67151c92b5443f6"

[[package]]
name = "clap"
version = "4.0.26"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "2148adefda54e4919b4e4c7a6c69a4d83c0d8121ade233b9d6b6c9f8d5e600c"
dependencies = [
    "atty",
    "bitflags",
    "clap_derive",
    "clap_lex",
    "once_cell",
    "strsim",
    "termcolor",
]

[[package]]
name = "clap_derive"
version = "4.0.21"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "0177313f9f02afc995627906bbd8967e2be069f5261954222dac78290c2b9014"
dependencies = [
    "heck",
    "proc-macro-error",
    "proc-macro2",
    "quote",
    "syn",
]

[[package]]
name = "proc-macro2"
version = "1.0.47"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "5ea3d908b0e36316caf9e9e2c4625cdde190a7e6f440d794667ed17a9b86c5a8"
dependencies = [
    "unicode-ident",
]

[[package]]
name = "quote"
version = "1.0.21"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "bbe448f377a7d6961e30f5955f9b8d106c3f5e449d493ee1b125c1d43c2b5179"
dependencies = [
    "proc-macro2",
]

[[package]]
name = "serde"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965"
dependencies = [
    "serde_derive",
]

[[package]]
name = "serde_derive"
version = "1.0.147"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "4f1d362ca8fc9c3e3a7484440752472d68a6caa98f1ab81d99b5dfe517cec852"
dependencies = [
    "proc-macro2",
    "quote",
    "syn",
]

[[package]]
name = "serde_json"
version = "1.0.87"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "6ce777b7b150d76b9cf60d28b55f5847135a003f7d7350c6be7a773508ce7d45"
dependencies = [
    "itoa",
    "ryu",
    "serde",
]

[[package]]
name = "syn"
version = "1.0.103"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a864042229133ada95abf3b54fdc62ef5ccabe9515b64717bcb9a1919e59445d"
dependencies = [
    "proc-macro2",
    "quote",
    "unicode-ident",
]

[[package]]
name = "tokio"
version = "1.21.2"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "a9e03c497dc955702ba729190dc4aac6f2a0ce97f913e5b1b5912fc5039d9099"
dependencies = [
    "bytes",
    "libc",
    "memchr",
    "mio",
    "num_cpus",
    "once_cell",
    "parking_lot",
    "pin-project-lite",
    "signal-hook-registry",
    "socket2",
    "tokio-macros",
    "winapi",
]

[[package]]
name = "unicode-ident"
version = "1.0.5"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "6ceab39d59e4c9499d4e5a8ee0e2735b891bb7308ac83dfb4e80cad195c9f6f3"
"""
        
        dependencies = self.parser.parse(content)
        
        # Should extract all crates from package sections
        crate_names = [dep.name for dep in dependencies]
        
        # Check for some key crates
        assert 'serde' in crate_names
        assert 'tokio' in crate_names
        assert 'clap' in crate_names
        assert 'serde_json' in crate_names
        assert 'anyhow' in crate_names
        
        # Check specific versions
        serde_dep = next(dep for dep in dependencies if dep.name == 'serde')
        assert serde_dep.version == '1.0.147'
        
        tokio_dep = next(dep for dep in dependencies if dep.name == 'tokio')
        assert tokio_dep.version == '1.21.2'
        
        # Should have many dependencies
        assert len(dependencies) > 10